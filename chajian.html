<!DOCTYPE html>
<html>
<head>
  <style>
      /* =========================================
        1. 设计系统变量 (Design System Variables)
        现代极简风格 - 支持明暗模式
        ========================================= */
      :root {
          /* 主色调 */
          --primary: #6366F1;
          --primary-hover: #818CF8;
          --primary-active: #4F46E5;
          --primary-light: rgba(99, 102, 241, 0.1);
          --primary-lighter: rgba(99, 102, 241, 0.05);
          
          /* 语义色 */
          --success: #10B981;
          --success-light: rgba(16, 185, 129, 0.1);
          --warning: #F59E0B;
          --warning-light: rgba(245, 158, 11, 0.1);
          --danger: #EF4444;
          --danger-light: rgba(239, 68, 68, 0.1);
          --info: #3B82F6;
          --info-light: rgba(59, 130, 246, 0.1);
          
          /* 中性色 - 亮色模式 */
          --bg-body: #F8FAFC;
          --bg-white: #FFFFFF;
          --bg-elevated: #FFFFFF;
          --bg-muted: #F1F5F9;
          --bg-hover: #F1F5F9;
          --bg-active: #E2E8F0;
          
          --text-primary: #1E293B;
          --text-secondary: #64748B;
          --text-tertiary: #94A3B8;
          --text-disabled: #CBD5E1;
          --text-inverse: #FFFFFF;
          
          --border: #E2E8F0;
          --border-light: #F1F5F9;
          --border-focus: var(--primary);
          
          /* 阴影 */
          --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
          --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
          --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.03);
          --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 10px 10px -5px rgba(0, 0, 0, 0.02);
          
          /* 布局 */
          --sidebar-w: 140px;
          --sidebar-w-mini: 56px;
          --radius-sm: 6px;
          --radius-md: 8px;
          --radius-lg: 12px;
          --radius-xl: 16px;
          --radius-full: 9999px;
          
          /* 动画 */
          --transition-fast: 0.15s ease;
          --transition-normal: 0.2s ease;
          --transition-slow: 0.3s ease;
          
          /* 卡片主题色 - 亮色模式 */
          --card-orange-bg: #FFF7ED;
          --card-orange-text: #C2410C;
          --card-orange-border: rgba(194, 65, 12, 0.1);
          --card-blue-bg: #EFF6FF;
          --card-blue-text: #1D4ED8;
          --card-blue-border: rgba(29, 78, 216, 0.1);
          --card-purple-bg: #F5F3FF;
          --card-purple-text: #6D28D9;
          --card-purple-border: rgba(109, 40, 217, 0.1);
          --card-green-bg: #ECFDF5;
          --card-green-text: #047857;
          --card-green-border: rgba(4, 120, 87, 0.1);
          --card-pink-bg: #FDF2F8;
          --card-pink-text: #BE185D;
          --card-pink-border: rgba(190, 24, 93, 0.1);
      }
      
      /* =========================================
        暗色模式 (Dark Mode)
        ========================================= */
      [data-theme="dark"] {
          --bg-body: #0F172A;
          --bg-white: #1E293B;
          --bg-elevated: #334155;
          --bg-muted: #1E293B;
          --bg-hover: #334155;
          --bg-active: #475569;
          
          --text-primary: #F1F5F9;
          --text-secondary: #94A3B8;
          --text-tertiary: #64748B;
          --text-disabled: #475569;
          --text-inverse: #0F172A;
          
          --border: #334155;
          --border-light: #1E293B;
          
          --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
          --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
          --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
          --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
          
          --primary-light: rgba(99, 102, 241, 0.2);
          --primary-lighter: rgba(99, 102, 241, 0.1);
          
          --success-light: rgba(16, 185, 129, 0.2);
          --warning-light: rgba(245, 158, 11, 0.2);
          --danger-light: rgba(239, 68, 68, 0.2);
          --info-light: rgba(59, 130, 246, 0.2);
          
          --card-orange-bg: rgba(194, 65, 12, 0.15);
          --card-orange-text: #FB923C;
          --card-orange-border: rgba(194, 65, 12, 0.2);
          --card-blue-bg: rgba(29, 78, 216, 0.15);
          --card-blue-text: #60A5FA;
          --card-blue-border: rgba(29, 78, 216, 0.2);
          --card-purple-bg: rgba(109, 40, 217, 0.15);
          --card-purple-text: #A78BFA;
          --card-purple-border: rgba(109, 40, 217, 0.2);
          --card-green-bg: rgba(4, 120, 87, 0.15);
          --card-green-text: #34D399;
          --card-green-border: rgba(4, 120, 87, 0.2);
          --card-pink-bg: rgba(190, 24, 93, 0.15);
          --card-pink-text: #F472B6;
          --card-pink-border: rgba(190, 24, 93, 0.2);
      }

      /* =========================================
        全局重置与基础样式 (Reset & Base)
        ========================================= */
      *, *::before, *::after {
          box-sizing: border-box;
          margin: 0;
          padding: 0;
      }

      body {
          font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
          background: var(--bg-body);
          color: var(--text-primary);
          height: 100vh;
          width: 100vw;
          overflow: hidden;
          user-select: none;
          -webkit-font-smoothing: antialiased;
          -moz-osx-font-smoothing: grayscale;
          transition: background-color var(--transition-normal), color var(--transition-normal);
      }

      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: var(--border); border-radius: var(--radius-full); }
      ::-webkit-scrollbar-thumb:hover { background: var(--text-tertiary); }

      /* =========================================
        2. 主布局容器 (Layout Container)
        ========================================= */
      .container {
          display: flex;
          width: 100%;
          height: 100%;
      }

      .main-content {
          flex: 1;
          display: flex;
          flex-direction: column;
          height: 100%;
          position: relative;
          min-width: 0;
      }

      .content-scroll {
          flex: 1;
          min-height: 0;
          overflow-y: auto;
          position: relative;
      }

      .resize-handle {
          position: absolute;
          bottom: 0;
          right: 0;
          width: 16px;
          height: 16px;
          cursor: nwse-resize;
          z-index: 100;
      }
      .resize-handle::after {
          content: '';
          position: absolute;
          bottom: 4px;
          right: 4px;
          width: 8px;
          height: 8px;
          border-right: 2px solid var(--text-tertiary);
          border-bottom: 2px solid var(--text-tertiary);
          border-radius: 1px;
      }
      .resize-handle:hover::after { border-color: var(--primary); }

      /* =========================================
        3. 侧边栏 (Sidebar Navigation)
        ========================================= */
      .sidebar {
          width: var(--sidebar-w);
          background: var(--bg-white);
          border-right: 1px solid var(--border);
          display: flex;
          flex-direction: column;
          height: 100%;
          flex-shrink: 0;
          z-index: 10;
          transition: width var(--transition-normal);
      }

      .nav-scroll {
          flex: 1;
          overflow-y: auto;
          padding: 16px 8px;
      }

      .nav-item {
          display: flex;
          align-items: center;
          padding: 12px 10px;
          margin-bottom: 2px;
          cursor: pointer;
          color: var(--text-secondary);
          border-radius: var(--radius-md);
          transition: all var(--transition-fast);
          position: relative;
      }
      .nav-item:hover { 
          background: var(--bg-hover); 
          color: var(--primary); 
      }
      .nav-item.active { 
          background: var(--primary-light); 
          color: var(--primary); 
          font-weight: 600;
      }

      .nav-left { display: flex; align-items: center; gap: 10px; width: 100%; }
      .nav-icon { width: 20px; height: 20px; fill: currentColor; flex-shrink: 0; }
      .nav-text { font-size: 13px; white-space: nowrap; font-weight: 500; }

      .nav-meta { display: flex; align-items: center; gap: 4px; margin-left: auto; }
      .count-badge { 
          background: var(--bg-muted); 
          color: var(--text-tertiary); 
          padding: 2px 6px; 
          border-radius: var(--radius-full); 
          font-size: 10px; 
          font-weight: 600;
      }
      
      .sidebar-footer {
          padding: 12px;
          border-top: 1px solid var(--border);
          background: var(--bg-white);
          display: flex;
          flex-direction: column;
          gap: 8px;
      }
      .footer-btn {
          width: 100%;
          padding: 8px 0;
          border: 1px solid var(--border);
          background: var(--bg-white);
          border-radius: var(--radius-md);
          color: var(--text-secondary);
          font-size: 12px;
          font-weight: 500;
          cursor: pointer;
          text-align: center;
          transition: all var(--transition-fast);
      }
      .footer-btn:hover { 
          border-color: var(--primary); 
          color: var(--primary); 
          background: var(--primary-lighter); 
      }
      .lang-btn { 
          font-family: ui-monospace, SFMono-Regular, "SF Mono", Menlo, monospace; 
          font-weight: 600; 
          color: var(--primary); 
          background: var(--primary-lighter);
          border-color: var(--primary-light);
      }
      .lang-btn:hover { 
          background: var(--primary-light); 
          border-color: var(--primary); 
      }
      
      /* 主题切换按钮 */
      .theme-toggle-btn {
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 6px;
      }
      .theme-toggle-btn svg {
          width: 14px;
          height: 14px;
      }

      /* =========================================
        4. 侧边栏折叠模式 (Icon Only Mode)
        ========================================= */
      body.mini-mode .sidebar { width: var(--sidebar-w-mini); }
      body.mini-mode .nav-text, 
      body.mini-mode .nav-meta, 
      body.mini-mode .lang-btn { display: none; }
      
      body.mini-mode .nav-item { justify-content: center; padding: 14px 0; }
      body.mini-mode .nav-left { justify-content: center; width: auto; }
      body.mini-mode .nav-icon { width: 22px; height: 22px; margin: 0; }
      
      body.mini-mode .footer-btn { 
          padding: 8px 0; 
          font-size: 11px; 
          border: none; 
          color: var(--text-tertiary);
          background: transparent;
      }
      body.mini-mode .footer-btn:hover {
          color: var(--primary);
      }

      /* =========================================
        5. 公共 UI 组件 (Common Components)
        ========================================= */
      .header { 
          padding: 16px; 
          flex-shrink: 0; 
          background: var(--bg-white);
          border-bottom: 1px solid var(--border);
      }
      .search-box {
          width: 100%;
          padding: 10px 14px;
          border: 1px solid var(--border);
          border-radius: var(--radius-md);
          background: var(--bg-body);
          font-size: 13px;
          color: var(--text-primary);
          outline: none;
          transition: all var(--transition-fast);
      }
      .search-box::placeholder {
          color: var(--text-tertiary);
      }
      .search-box:focus { 
          border-color: var(--primary); 
          background: var(--bg-white);
          box-shadow: 0 0 0 3px var(--primary-light); 
      }

      .primary-btn {
          background: var(--primary);
          color: var(--text-inverse);
          border: none;
          padding: 10px 24px;
          border-radius: var(--radius-md);
          font-size: 13px;
          font-weight: 600;
          cursor: pointer;
          width: 100%;
          transition: all var(--transition-fast);
      }
      .primary-btn:hover { 
          background: var(--primary-hover);
          transform: translateY(-1px);
      }
      .primary-btn:active {
          transform: translateY(0);
      }

      /* =========================================
        6. 网格与卡片 (Grid & Cards)
        ========================================= */
      .grid {
          padding: 16px;
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
          gap: 12px;
          flex-shrink: 0;
      }
      .card {
          border-radius: var(--radius-lg);
          padding: 16px;
          cursor: pointer;
          border: 1px solid transparent;
          transition: all var(--transition-fast);
          display: flex;
          flex-direction: column;
          gap: 8px;
          position: relative;
      }
      .card:hover { 
          transform: translateY(-2px); 
          box-shadow: var(--shadow-md); 
      }
      .card:active { 
          transform: scale(0.98); 
      }
      
      .card-title { 
          font-weight: 600; 
          font-size: 13px; 
          white-space: nowrap; 
          overflow: hidden; 
          text-overflow: ellipsis;
          display: block; 
          width: 100%; 
          margin-bottom: 0; 
      }

      .theme-orange { background: var(--card-orange-bg); color: var(--card-orange-text); border-color: var(--card-orange-border); }
      .theme-blue   { background: var(--card-blue-bg); color: var(--card-blue-text); border-color: var(--card-blue-border); }
      .theme-purple { background: var(--card-purple-bg); color: var(--card-purple-text); border-color: var(--card-purple-border); }
      .theme-green  { background: var(--card-green-bg); color: var(--card-green-text); border-color: var(--card-green-border); }
      .theme-pink   { background: var(--card-pink-bg); color: var(--card-pink-text); border-color: var(--card-pink-border); }

      /* Tooltip */
      #tooltip-box {
          position: fixed; display: none; z-index: 999;
          background: var(--bg-elevated); color: var(--text-primary);
          padding: 10px 14px; border-radius: var(--radius-md); font-size: 12px; line-height: 1.5;
          width: 240px; 
          box-shadow: var(--shadow-lg);
          border: 1px solid var(--border);
          pointer-events: none; animation: fadeIn var(--transition-fast); text-align: left;
      }
      .tt-title {
          font-weight: 600; font-size: 13px; margin-bottom: 6px; color: var(--text-primary);
          display: block; border-bottom: 1px solid var(--border); padding-bottom: 6px;
      }
      .tt-desc { font-size: 12px; color: var(--text-secondary); line-height: 1.5; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }
      
      /* Error Toast */
      #errorToast {
          position: fixed;
          bottom: 24px;
          left: 50%;
          transform: translateX(-50%);
          background: var(--danger);
          color: white;
          padding: 12px 20px;
          border-radius: var(--radius-lg);
          font-size: 13px;
          font-weight: 500;
          box-shadow: var(--shadow-lg);
          z-index: 10000;
          display: none;
          align-items: center;
          gap: 10px;
          max-width: 90%;
          animation: slideUp var(--transition-normal);
      }
      #errorToast.show { display: flex; }
      #errorToast .toast-icon { font-size: 16px; }
      #errorToast .toast-close {
          background: rgba(255,255,255,0.2);
          border: none;
          color: white;
          width: 20px;
          height: 20px;
          border-radius: 50%;
          cursor: pointer;
          font-size: 12px;
          display: flex;
          align-items: center;
          justify-content: center;
      }
      #errorToast .toast-close:hover { background: rgba(255,255,255,0.3); }
      @keyframes slideUp {
          from { opacity: 0; transform: translateX(-50%) translateY(20px); }
          to { opacity: 1; transform: translateX(-50%) translateY(0); }
      }

      .empty-state {
          display: none; flex-direction: column; align-items: center; justify-content: center;
          height: 100%; text-align: center; color: var(--text-tertiary); padding-top: 40px;
      }
      .empty-icon { width: 48px; height: 48px; margin-bottom: 10px; opacity: 0.5; }

      /* =========================================
        7. 文字查找替换 (Text Find & Replace) - 最终完整版
        ========================================= */
      
      /* 1. 主容器 (去边距) */
      #textPanel {
          padding: 0 !important;
          background: var(--bg-body);
          height: 100%;
          width: 100%;
          display: none; /* JS控制显示 */
          flex-direction: column;
          overflow: hidden;
      }
      
      /* 结果列表包装器 */
      #textResultWrapper {
          flex: 1;
          min-height: 0;
          display: none;
          flex-direction: column;
          background: var(--bg-body);
          overflow: hidden;
      }
      #textResultWrapper.show,
      #textResultWrapper.visible {
          display: flex !important;
      }

      /* 2. 新版顶部功能栏 (可点击折叠) */
      .text-panel-header {
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 12px 16px;
          background: var(--bg-white);
          border-bottom: 1px solid var(--border);
          cursor: pointer;
          transition: background var(--transition-fast);
          user-select: none;
          flex-shrink: 0;
      }
      .text-panel-header:hover {
          background: var(--bg-hover);
      }

      /* 标题组 (箭头+文字) */
      .header-title-group {
          display: flex; align-items: center; gap: 6px;
          font-size: 13px; font-weight: 600; color: var(--text-primary);
      }
      .header-arrow {
          width: 12px; height: 12px; transition: transform var(--transition-normal); opacity: 0.6;
      }
      /* 展开状态：箭头旋转 */
      .text-panel-header.expanded .header-arrow {
          transform: rotate(180deg);
      }
      /* 搜索状态高亮文字 */
      .search-status-text { color: var(--primary); font-weight: 600; }

      /* 右侧按钮组 */
      .header-actions { display: flex; gap: 8px; }

      /* 顶部小按钮样式 */
      .btn-action-small {
          padding: 4px 10px; border-radius: var(--radius-sm); font-size: 11px;
          border: 1px solid transparent; cursor: pointer; transition: all var(--transition-fast);
          background: var(--bg-muted); color: var(--text-secondary);
      }
      .btn-action-small:hover { background: var(--primary-light); color: var(--primary); }
      
      .btn-restore { background: var(--danger-light); color: var(--danger); }
      .btn-restore:hover { background: rgba(239, 68, 68, 0.2); }

      /* 3. 配置内容容器 (用于折叠隐藏) */
      #textControlsContent {
          padding: 16px; 
          background: var(--bg-white); 
          border-bottom: 1px solid var(--border);
          display: block; /* 默认展开 */ 
          width: 100%; 
          box-sizing: border-box;
          flex-shrink: 0;
      }
      #textControlsContent.collapsed {
          display: none;
      }

      /* 4. 范围选择器 */
      .scope-segmented-control {
          display: flex; width: 100%; background: var(--bg-muted);
          padding: 3px; border-radius: var(--radius-md); margin-bottom: 12px;
      }
      .scope-seg-item {
          flex: 1; text-align: center; padding: 8px 0; font-size: 12px;
          color: var(--text-secondary); cursor: pointer; border-radius: var(--radius-sm);
          white-space: nowrap; /* 防止换行 */
          transition: all var(--transition-fast);
      }
      .scope-seg-item.active {
          background: var(--bg-white); color: var(--primary);
          box-shadow: var(--shadow-sm); font-weight: 600;
      }

      /* 5. 输入框 */
      .modern-input-group { position: relative; margin-bottom: 8px; width: 100%; }
      .modern-input-group input {
          width: 100%; box-sizing: border-box;
          padding: 8px 12px 8px 32px; border: 1px solid var(--border);
          border-radius: var(--radius-md); height: 36px;
          background: var(--bg-white);
          color: var(--text-primary);
          transition: all var(--transition-fast);
      }
      .modern-input-group input:focus {
          border-color: var(--primary);
          box-shadow: 0 0 0 3px var(--primary-light);
          outline: none;
      }
      .modern-input-group .m-icon {
          position: absolute; left: 10px; top: 50%; transform: translateY(-50%);
          color: var(--text-tertiary); pointer-events: none; z-index: 1;
      }

      /* 6. 开始查找按钮 */
      .btn-find-hero {
          width: 100%; height: 36px; background: var(--primary); color: var(--text-inverse);
          border: none; border-radius: var(--radius-md); font-size: 13px; font-weight: 600;
          cursor: pointer; display: flex; align-items: center; justify-content: center;
          margin-top: 8px;
          transition: all var(--transition-fast);
      }
      .btn-find-hero:hover {
          background: var(--primary-hover);
          transform: translateY(-1px);
          box-shadow: var(--shadow-md);
      }

      /* 7. 结果列表项 (强制 Flex 布局) */
      .text-result-row {
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 10px 16px;
          background: var(--bg-white);
          border-bottom: 1px solid var(--border);
          width: 100%;
          box-sizing: border-box;
          transition: background var(--transition-fast);
          min-height: 40px;
      }
      .text-result-row:hover {
          background: var(--bg-hover);
      }
      .text-result-row .row-cb {
          margin: 0 12px 0 0 !important; cursor: pointer; flex-shrink: 0; width: 16px; height: 16px;
      }
      .text-row-content {
          flex: 1; overflow: hidden; margin-right: 12px;
          cursor: pointer; display: flex; align-items: center;
      }
      .text-preview-main {
          font-size: 13px; color: var(--text-primary); white-space: nowrap; overflow: hidden;
          text-overflow: ellipsis; width: 100%; display: block;
      }
      .hl-text {
          background: var(--warning-light); color: var(--warning);
          border-bottom: 2px solid var(--warning); padding: 0 2px; font-weight: bold;
      }
      
      /* 替换小按钮 */
      .btn-row-replace {
          padding: 4px 10px !important; background: var(--bg-white) !important; border: 1px solid var(--border) !important;
          border-radius: var(--radius-sm); font-size: 11px; color: var(--text-secondary); cursor: pointer;
          white-space: nowrap; flex-shrink: 0; height: auto; line-height: normal; display: inline-block;
          transition: all var(--transition-fast);
      }
      .btn-row-replace:hover {
          background: var(--primary-light) !important; color: var(--primary) !important; border-color: var(--primary) !important;
      }

      /* 状态样式 */
      .text-result-row.is-highlighted {
          background: var(--danger-light) !important; border-left: 3px solid var(--danger);
      }
      .text-result-row.is-highlighted .text-preview-main { color: var(--danger); }
      
      .text-result-row.replaced {
          background: var(--bg-muted) !important; opacity: 0.6; pointer-events: none;
      }
      .text-result-row.replaced .text-preview-main { text-decoration: line-through; color: var(--text-tertiary); }
      .text-result-row.replaced .btn-row-replace { display: none; }

      /* 8. 列表容器与底部 */
      .text-list-header-bar {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 8px 16px;
          background: var(--bg-muted);
          border-bottom: 1px solid var(--border);
          font-size: 12px;
          color: var(--text-secondary);
          flex-shrink: 0;
          width: 100%;
          box-sizing: border-box;
      }
      .text-list-container { 
          flex: 1; 
          min-height: 0;
          overflow-y: auto; 
          padding: 0; 
          background: var(--bg-white);
          width: 100%;
          box-sizing: border-box;
      }
      #textResultList {
          display: block;
          width: 100%;
      }
      .text-fixed-footer {
          background: var(--bg-white); 
          padding: 12px 16px; 
          border-top: 1px solid var(--border); 
          display: none;
          z-index: 3; 
          flex-shrink: 0;
      }

      /* =========================================
        8. 选择工具面板 (Selection Panel - Redesigned)
        ========================================= */
      #selectionPanel {
          padding: 0 !important;
          background: var(--bg-body);
          height: 100%;
          display: none; /* JS控制 */
          flex-direction: column;
          overflow: hidden;
      }

      /* 滚动区域 */
      .selection-scroll-area {
          flex: 1;
          overflow-y: auto;
          padding: 16px;
          display: flex;
          flex-direction: column;
          gap: 24px;
      }

      /* 分组标题 */
      .section-header {
          display: flex;
          align-items: center;
          justify-content: space-between;
          margin-bottom: 10px;
      }
      .section-title {
          font-size: 13px;
          font-weight: 700;
          color: var(--text-primary);
          margin: 0;
      }

      /* 范围选择器 */
      .scope-control {
          display: flex;
          gap: 4px !important;
          padding: 0px;
          border-radius: 0px;
          width: 100%;
          box-sizing: border-box;
      }
      .scope-btn {
          flex: 1;
          text-align: center;
          padding: 6px 0;
          font-size: 12px;
          color: var(--text-secondary);
          cursor: pointer;
          border-radius: var(--radius-md);
          transition: all var(--transition-fast);
          font-weight: 500;
          margin: 0 !important;
          background: var(--bg-muted);
          border: 1px solid var(--border);
      }
      .scope-btn.active {
          background: var(--primary-light);
          color: var(--primary);
          font-weight: 600;
          box-shadow: var(--shadow-sm);
          border-color: var(--primary);
      }

      /* 名称输入行 */
      .name-input-row {
          display: flex;
          gap: 8px;
          align-items: center;
      }
      .name-input-wrapper {
          flex: 1;
          position: relative;
          display: flex;
          align-items: center;
      }
      .name-input {
          width: 100%;
          padding: 8px 12px 8px 30px;
          border: 1px solid var(--border);
          border-radius: var(--radius-md);
          height: 36px;
          font-size: 13px;
          background: var(--bg-white);
          color: var(--text-primary);
          transition: all var(--transition-fast);
      }
      .name-input:focus { 
          border-color: var(--primary); 
          outline: none;
          box-shadow: 0 0 0 3px var(--primary-light);
      }
      .name-icon {
          position: absolute;
          left: 10px;
          top: 0;
          bottom: 0;
          margin: auto;
          height: 16px;
          width: 16px;
          color: var(--text-tertiary);
          pointer-events: none;
      }
      
      .icon-btn-square {
          width: 36px; height: 36px;
          border: 1px solid var(--border);
          background: var(--bg-white);
          border-radius: var(--radius-md);
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          color: var(--text-secondary);
          transition: all var(--transition-fast);
      }
      .icon-btn-square:hover { 
          border-color: var(--primary); 
          color: var(--primary); 
          background: var(--primary-light); 
      }
      .icon-btn-square.active { 
          background: var(--primary); 
          color: var(--text-inverse); 
          border-color: var(--primary); 
      }

      /* 清除按钮样式 */
      .btn-clear-input {
          position: absolute;
          right: 8px;
          top: 0;
          bottom: 0;
          margin: auto;
          width: 20px;
          height: 20px;
          display: flex;
          align-items: center;
          justify-content: center;
          color: var(--text-tertiary);
          cursor: pointer;
          font-size: 14px;
          border-radius: 50%;
          transition: all var(--transition-fast);
      }
      .btn-clear-input:hover {
          color: var(--text-secondary);
          background: var(--bg-muted);
      }
      .btn-clear-input.hidden { display: none; }
      
      /* 标签云容器 */
      .tag-cloud {
          display: flex;
          flex-wrap: wrap;
          gap: 4px;
      }
      /* 标签按钮 */
      .filter-tag {
          padding: 7px 6px;
          background: var(--bg-white);
          border: 1px solid var(--border);
          border-radius: var(--radius-md);
          font-size: 12px;
          color: var(--text-secondary);
          cursor: pointer;
          transition: all var(--transition-fast);
          display: flex;
          align-items: center;
          gap: 4px;
      }
      .filter-tag:hover { background: var(--bg-hover); border-color: var(--text-tertiary); }
      .filter-tag.active {
          background: var(--primary-light);
          border-color: var(--primary);
          color: var(--primary);
          font-weight: 500;
      }
      .filter-tag.all-tag.active {
          background: var(--text-primary);
          border-color: var(--text-primary);
          color: var(--text-inverse);
      }

      /* 开关 (包含/不包含) */
      .mode-switch {
          display: flex;
          font-size: 11px;
          background: var(--bg-muted);
          border-radius: var(--radius-sm);
          padding: 3px;
          cursor: pointer;
      }
      .mode-switch span {
          padding: 3px 8px;
          border-radius: var(--radius-sm);
          color: var(--text-tertiary);
          transition: var(--transition-fast);
      }
      .mode-switch.include .ms-in { 
          background: var(--bg-white); 
          color: var(--primary); 
          font-weight: 600; 
          box-shadow: var(--shadow-sm); 
      }
      .mode-switch.exclude .ms-ex { 
          background: var(--bg-white); 
          color: var(--danger); 
          font-weight: 600; 
          box-shadow: var(--shadow-sm); 
      }

      /* 属性行列表 */
      .prop-list-container {
          display: flex;
          flex-direction: column;
          gap: 10px;
      }
      .prop-item {
          display: flex;
          gap: 8px;
          align-items: center;
          background: var(--bg-white);
          padding: 8px;
          border: 1px solid var(--border);
          border-radius: var(--radius-md);
      }
      .prop-select {
          flex: 1;
          height: 28px;
          border: 1px solid var(--border);
          border-radius: var(--radius-sm);
          font-size: 12px;
          padding-left: 4px;
          background: var(--bg-white);
          color: var(--text-primary);
      }
      .prop-op {
          width: 44px;
          height: 28px;
          border: 1px solid var(--border);
          border-radius: var(--radius-sm);
          font-size: 12px;
          background: var(--bg-muted);
          text-align: center;
          color: var(--text-primary);
      }
      .prop-val-input {
          width: 60px;
          height: 28px;
          border: 1px solid var(--border);
          border-radius: var(--radius-sm);
          font-size: 12px;
          padding-left: 6px;
          background: var(--bg-white);
          color: var(--text-primary);
      }
      .prop-del-btn {
          width: 20px; height: 20px;
          display: flex; align-items: center; justify-content: center;
          color: var(--text-tertiary); cursor: pointer; border-radius: 50%;
          font-size: 16px; line-height: 1;
          transition: all var(--transition-fast);
      }
      .prop-del-btn:hover { background: var(--danger-light); color: var(--danger); }

      .add-prop-link {
          font-size: 12px; color: var(--primary); cursor: pointer;
          display: inline-flex; align-items: center; gap: 4px; font-weight: 600;
      }
      .add-prop-link:hover { text-decoration: underline; }

      /* 底部固定操作栏 */
      .selection-footer {
          padding: 12px 16px;
          background: var(--bg-white);
          border-top: 1px solid var(--border);
          flex-shrink: 0;
          z-index: 5;
          display: flex;
          gap: 8px;
          align-items: center;
      }

      /* 结果统计按钮样式 */
      .result-btn {
          background: var(--text-primary);
          color: var(--text-inverse);
          border: none;
          padding: 10px 14px;
          border-radius: var(--radius-md);
          font-size: 12px;
          font-weight: 500;
          cursor: pointer;
          display: inline-flex;
          align-items: center;
          justify-content: center;
          white-space: nowrap;
          transition: all var(--transition-fast);
          box-shadow: var(--shadow-sm);
      }
      .result-btn:hover {
          background: var(--bg-active);
          transform: translateY(-1px);
          box-shadow: var(--shadow-md);
      }
      .result-btn:active {
          transform: translateY(0);
      }
      .result-badge {
          background: var(--info);
          color: var(--text-inverse);
          padding: 2px 6px;
          border-radius: var(--radius-full);
          font-size: 10px;
          margin: 0 6px;
          font-weight: 700;
          box-shadow: 0 0 10px rgba(59, 130, 246, 0.4);
      }

      /* =========================================
        9. PPT Master 面板样式
        ========================================= */
      #pptPanel { 
          display: none; 
          flex-direction: column; 
          height: 100%; 
          background: var(--bg-white); 
          width: 100%; 
      }
      .ppt-dashboard { 
          padding: 16px; 
          background: var(--bg-white); 
          border-bottom: 1px solid var(--border); 
          flex-shrink: 0; 
          z-index: 2; 
      }
      .ppt-tips {
          background: var(--warning-light); 
          border: 1px solid rgba(245, 158, 11, 0.3); 
          border-radius: var(--radius-lg);
          padding: 8px; 
          font-size: 11px; 
          color: var(--warning); 
          line-height: 1.5; 
          margin-bottom: 8px;
      }
      .ppt-tips ul { margin: 0; padding-left: 16px; }
      .ppt-tips li { margin-bottom: 2px; }

      .btn-auto-run {
          width: 100%; 
          border: none; 
          cursor: pointer; 
          border-radius: var(--radius-lg);
          background: linear-gradient(135deg, var(--primary) 0%, var(--primary-active) 100%);
          color: var(--text-inverse); 
          font-size: 14px; 
          font-weight: 600; 
          padding: 12px;
          box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); 
          transition: all var(--transition-fast);
          display: flex; 
          align-items: center; 
          justify-content: center; 
          gap: 8px;
      }
      .btn-auto-run:hover { 
          transform: translateY(-1px); 
          box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4); 
      }
      .btn-auto-run:disabled { 
          background: var(--text-disabled); 
          box-shadow: none; 
          cursor: not-allowed; 
      }

      .ppt-content-area {
          flex: 1; 
          overflow-y: auto; 
          overflow-x: hidden; 
          padding: 16px;
          display: flex; 
          flex-direction: column; 
          align-items: center; 
          width: 100%;
      }
      .ppt-step {
          background: var(--bg-white); 
          border: 1px solid var(--border); 
          border-radius: var(--radius-lg);
          padding: 16px; 
          box-shadow: var(--shadow-md);
          display: none; 
          flex-direction: column; 
          align-items: center; 
          text-align: center;
          width: 100%; 
          animation: slideUp 0.3s ease-out;
      }
      .ppt-step.active { display: flex; }
      @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

      .ppt-icon {
          font-size: 24px; 
          width: 48px; 
          height: 48px; 
          margin-bottom: 12px;
          background: var(--primary-light); 
          border: 1px solid rgba(99, 102, 241, 0.2); 
          color: var(--primary);
          border-radius: 50%; 
          display: flex; 
          align-items: center; 
          justify-content: center;
      }
      .ppt-title { 
          font-size: 18px; 
          font-weight: 700; 
          margin-bottom: 8px; 
          color: var(--text-primary); 
      }
      .ppt-desc { 
          font-size: 13px; 
          color: var(--text-tertiary); 
          margin-bottom: 16px; 
          line-height: 1.5; 
      }
      .ppt-status { 
          font-size: 12px; 
          color: var(--text-tertiary); 
          font-family: monospace; 
          background: var(--bg-muted); 
          padding: 4px 10px; 
          border-radius: var(--radius-full); 
      }

      .ppt-footer {
          height: 56px; 
          border-top: 1px solid var(--border);
          display: flex; 
          background: var(--bg-white); 
          flex-shrink: 0;
      }
      .ppt-footer button {
          border: none; 
          background: var(--bg-white); 
          cursor: pointer; 
          font-size: 13px; 
          font-weight: 700; 
          transition: background var(--transition-fast);
      }
      .ppt-footer button:hover { background: var(--bg-hover); }
      .ppt-footer .primary-btn { 
          background: var(--bg-white); 
          color: var(--primary); 
          border-left: 1px solid var(--border); 
          border-radius: 0; 
      }

      .ppt-progress-track { 
          height: 6px; 
          background: var(--bg-muted); 
          width: 100%; 
          margin-top: auto; 
      }
      .ppt-progress-fill { 
          height: 100%; 
          background: var(--success); 
          width: 0%; 
          transition: width 0.3s; 
      }

      .btn-manual-dl {
          width: 100%; 
          margin-top: 12px; 
          padding: 8px 16px;
          background: var(--info-light); 
          border: 1px solid rgba(59, 130, 246, 0.3); 
          color: var(--info);
          border-radius: var(--radius-md); 
          font-size: 12px; 
          font-weight: 600;
          justify-content: center; 
          cursor: pointer; 
          display: inline-flex; 
          align-items: center; 
          gap: 6px; 
          transition: all var(--transition-fast);
      }
      .btn-manual-dl:hover { 
          background: rgba(59, 130, 246, 0.15); 
          border-color: var(--info); 
      }

      .loading-overlay {
          position: absolute; 
          top: 0; 
          left: 0; 
          width: 100%; 
          height: 100%;
          background: rgba(255, 255, 255, 0.98); 
          z-index: 100;
          display: none; 
          flex-direction: column; 
          align-items: center; 
          justify-content: center;
      }
      [data-theme="dark"] .loading-overlay {
          background: rgba(15, 23, 42, 0.98);
      }
      .loading-overlay.active { display: flex; }
      .spinner {
          width: 40px; 
          height: 40px; 
          border: 4px solid var(--primary-light); 
          border-top: 4px solid var(--primary);
          border-radius: 50%; 
          animation: spin 1s linear infinite; 
          margin-bottom: 20px;
      }
      .loading-text { 
          font-size: 16px; 
          font-weight: 600; 
          color: var(--text-primary); 
          margin-bottom: 8px; 
      }
      .loading-sub { 
          font-size: 12px; 
          color: var(--text-secondary); 
      }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

      /* =========================================
        10. Refiner (组件清洗) 面板样式
        ========================================= */
      #lintResultsWrapper, #findResultsWrapper {
          display: none; 
          flex-direction: column; 
          overflow: hidden; 
          height: 100%;
      }
      #findResultsWrapper { flex: 1; min-height: 0; }
      .limit-warning {
          padding: 8px 12px; 
          background: var(--warning-light); 
          color: var(--warning); 
          font-size: 11px;
          text-align: center; 
          border-bottom: 1px solid rgba(245, 158, 11, 0.3); 
          flex-shrink: 0;
      }
      .comp-header { position: sticky; top: 0; z-index: 5; }

      .split-row { display: flex; gap: 12px; margin-top: 8px; }
      .split-col { flex: 1; display: flex; flex-direction: column; min-width: 0; }
      .split-col .style-label, .style-label {
          font-size: 11px; 
          color: var(--text-secondary); 
          margin-bottom: 6px; 
          font-weight: 600;
      }
      .radio-grid { display: grid; gap: 8px; }
      .split-col .radio-grid { grid-template-columns: 1fr; }
      .lint-controls-wrapper { 
          display: flex; 
          flex-direction: column; 
          height: 100%; 
          overflow: visible; 
          background: var(--bg-white); 
      }

      #refinerPanel { 
          display: none; 
          flex-direction: column !important; 
          height: 100%; 
          width: 100%; 
          background: var(--bg-white); 
          overflow: hidden; 
      }
      .refiner-tabs {
          display: flex; 
          background: var(--bg-white); 
          padding: 4px 16px 0; 
          border-bottom: 1px solid var(--border); 
          flex-shrink: 0; 
          gap: 16px;
      }
      .refiner-tab-item {
          flex: 1; 
          display: flex; 
          justify-content: center; 
          padding: 10px 4px;
          font-size: 14px; 
          font-weight: 500; 
          color: var(--text-secondary); 
          cursor: pointer;
          border-bottom: 2px solid transparent; 
          transition: all var(--transition-fast);
      }
      .refiner-tab-item:hover { color: var(--text-primary); }
      .refiner-tab-item.active { 
          color: var(--primary); 
          border-bottom-color: var(--primary); 
          font-weight: 600; 
      }
      
      .refiner-tab-content { 
          flex: 1; 
          display: none; 
          flex-direction: column; 
          overflow: hidden; 
          background: var(--bg-body); 
          height: 100%; 
      }
      .refiner-tab-content.active { display: flex; }

      .refiner-config { 
          padding: 16px; 
          flex: 1; 
          overflow-y: auto; 
          background: var(--bg-white); 
      }
      .config-group { 
          margin-bottom: 12px; 
          border-bottom: 1px solid var(--border-light); 
          padding-bottom: 8px; 
      }
      .config-group:last-child { border-bottom: none; }
      .config-label { 
          display: block; 
          font-size: 13px; 
          font-weight: 700; 
          color: var(--text-primary); 
          margin-bottom: 6px; 
      }
      .sub-label { 
          font-size: 12px; 
          font-weight: 600; 
          color: var(--text-tertiary); 
          margin-bottom: 6px; 
          margin-top: 4px;
      }
      .style-section { display: flex; flex-direction: column; gap: 2px; }
      .disabled-area { opacity: 0.5; pointer-events: none; filter: grayscale(1); }
      
      .find-options { display: flex; justify-content: center; margin: 10px 0 4px; }
      .checkbox-center { 
          display: flex; 
          align-items: center; 
          gap: 6px; 
          font-size: 12px; 
          color: var(--text-secondary); 
          cursor: pointer; 
          user-select: none; 
      }
      .checkbox-center:hover { color: var(--text-primary); }
      .checkbox-center input { margin: 0; }

      .radio-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
      .radio-item {
          display: flex; 
          align-items: center; 
          justify-content: center;
          padding: 8px 4px; 
          border: 1px solid var(--border); 
          border-radius: var(--radius-md);
          font-size: 12px; 
          color: var(--text-secondary); 
          cursor: pointer; 
          background: var(--bg-white); 
          transition: all var(--transition-fast); 
          user-select: none;
      }
      .radio-item:hover { background: var(--bg-hover); border-color: var(--text-tertiary); }
      .radio-item.active { 
          background: var(--primary-light); 
          border-color: var(--primary); 
          color: var(--primary); 
          font-weight: 600; 
      }
      .radio-item.disabled { 
          opacity: 0.5; 
          pointer-events: none; 
          background: var(--bg-muted); 
          border-color: var(--border); 
          color: var(--text-tertiary); 
      }

      .checkbox-row { 
          display: flex; 
          align-items: center; 
          gap: 8px; 
          margin-bottom: 10px; 
          font-size: 12px; 
          color: var(--text-secondary); 
          cursor: pointer; 
          user-select: none; 
      }
      .checkbox-row:hover { color: var(--text-primary); }
      .checkbox-row input { accent-color: var(--primary); width: 14px; height: 14px; }

      .checkbox-grid-row {
          display: flex;
          gap: 8px;
          flex-wrap: wrap;
      }
      .checkbox-chip {
          display: flex;
          align-items: center;
          gap: 6px;
          padding: 8px 12px;
          background: var(--bg-muted);
          border-radius: var(--radius-md);
          font-size: 12px;
          cursor: pointer;
          transition: all var(--transition-fast);
          border: 1px solid transparent;
      }
      .checkbox-chip:hover {
          background: var(--bg-hover);
      }
      .checkbox-chip.active {
          background: var(--primary-light);
          color: var(--primary);
          border-color: var(--primary);
      }
      .checkbox-chip input {
          accent-color: var(--primary);
          width: 14px;
          height: 14px;
      }

      .btn-start-lint {
          width: 100%; 
          padding: 10px; 
          background: var(--primary); 
          color: var(--text-inverse);
          border: none; 
          border-radius: var(--radius-md); 
          font-size: 14px; 
          font-weight: 600;
          cursor: pointer; 
          margin-top: 10px; 
          transition: all var(--transition-fast);
          box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2); 
          display: flex; 
          align-items: center; 
          justify-content: center; 
          gap: 8px;
      }
      .btn-start-lint:hover { 
          background: var(--primary-hover); 
          transform: translateY(-1px); 
      }
      .btn-start-lint.loading { 
          background: var(--primary-hover); 
          pointer-events: none; 
          cursor: wait; 
      }
      .btn-spinner { 
          width: 14px; 
          height: 14px; 
          border: 2px solid var(--text-inverse); 
          border-top-color: transparent; 
          border-radius: 50%; 
          animation: spin 0.8s linear infinite; 
          display: none; 
      }
      .btn-start-lint.loading .btn-spinner { display: block; }

      .lint-controls-wrapper, .find-controls { 
          background: var(--bg-white); 
          border-bottom: 1px solid var(--border); 
          flex-shrink: 0; 
          transition: all 0.3s ease; 
          overflow: hidden; 
      }
      .lint-summary-bar, .find-summary-bar {
          display: none; 
          align-items: center; 
          justify-content: space-between;
          padding: 8px 16px; 
          background: var(--bg-white); 
          border-bottom: 1px solid var(--border); 
          cursor: pointer;
      }
      .lint-summary-bar:hover { background: var(--bg-hover); }
      .lint-summary-bar.visible, .find-summary-bar.visible { display: flex; }
      .find-expanded { 
          display: flex; 
          flex-direction: column; 
          gap: 0px; 
          padding: 12px 16px; 
          opacity: 1; 
          max-height: 300px; 
      }
      .find-summary-bar { 
          display: flex; 
          align-items: center; 
          justify-content: space-between; 
          background: var(--info-light); 
          border-bottom: 1px solid rgba(59, 130, 246, 0.3); 
          padding: 8px 16px; 
          cursor: pointer; 
          flex-shrink: 0; 
          font-size: 12px; 
          font-weight: 500; 
      }
      .find-summary-bar:hover { background: rgba(59, 130, 246, 0.15); }
      
      .filter-chips-row { display: flex; gap: 8px; align-items: center; margin-top: 2px; }
      .chip-check {
          flex: 1; 
          display: flex; 
          justify-content: center; 
          align-items: center; 
          gap: 4px;
          cursor: pointer; 
          font-size: 11px; 
          color: var(--text-secondary); 
          padding: 6px 8px;
          border-radius: var(--radius-full); 
          border: 1px solid var(--border); 
          background: var(--bg-white); 
          transition: all var(--transition-fast);
      }
      .chip-check:hover { background: var(--bg-hover); }
      .chip-check.active { 
          background: var(--primary-light); 
          border-color: var(--primary); 
          color: var(--primary); 
          font-weight: 500; 
      }
      .chip-check input { display: none; }

      /* Refiner List Items */
      .res-header {
          background: var(--bg-white); 
          padding: 8px 12px; 
          border-bottom: 1px solid var(--border); 
          display: flex; 
          justify-content: space-between; 
          align-items: center; 
          flex-shrink: 0;
      }
      .header-left { display: flex; align-items: center; gap: 8px; }
      .header-cb { accent-color: var(--primary); cursor: pointer; transform: scale(1.1); }
      .btn-reset { 
          border: none; 
          background: transparent; 
          color: var(--text-tertiary); 
          cursor: pointer; 
          font-size: 11px; 
      }
      .btn-reset:hover { color: var(--primary); }

      .comp-group { 
          background: var(--bg-white); 
          border-bottom: 1px solid var(--border); 
      }
      .comp-header { 
          padding: 8px 12px; 
          display: flex; 
          align-items: center; 
          justify-content: space-between; 
          cursor: pointer; 
      }
      .comp-header:hover { background: var(--bg-hover); }
      .comp-info { 
          display: flex; 
          align-items: center; 
          gap: 6px; 
          font-size: 12px; 
          color: var(--primary); 
          font-weight: 600; 
          overflow: hidden; 
      }
      .comp-arrow { 
          color: var(--text-tertiary); 
          font-size: 10px; 
          width: 10px; 
          transition: transform var(--transition-fast); 
          display: inline-block; 
      }
      .comp-group.expanded .comp-arrow { transform: rotate(90deg); }
      .comp-details { display: none; padding-bottom: 4px; }
      .comp-group.expanded .comp-details { display: block; }

      .detail-category {
          font-size: 11px; 
          font-weight: 600; 
          color: var(--text-secondary); 
          background: var(--bg-muted);
          padding: 6px 12px 6px 16px; 
          border-top: 1px solid var(--border); 
          border-bottom: 1px solid var(--border);
          display: flex; 
          align-items: center; 
          gap: 6px;
      }
      .detail-category:first-child { border-top: none; }
      
      .diff-item {
          display: flex; 
          align-items: center; 
          gap: 6px; 
          padding: 6px 12px 6px 26px; 
          font-size: 11px; 
          border-top: 1px dashed var(--border-light); 
          position: relative;
      }
      .diff-item:hover { background: var(--info-light); }
      .diff-item.fixed-success { background: var(--success-light); }

      .txt-wrapper { 
          flex: 1; 
          display: flex; 
          align-items: center; 
          overflow: hidden; 
          cursor: pointer; 
      }
      .txt-old { 
          color: var(--text-tertiary); 
          max-width: 45%; 
          overflow: hidden; 
          text-overflow: ellipsis; 
          white-space: nowrap; 
      }
      .txt-arrow { 
          color: var(--info); 
          margin: 0 10px; 
          font-size: 12px; 
          flex-shrink: 0; 
          font-weight: bold; 
      }
      .txt-new { 
          color: var(--success); 
          font-weight: 600; 
          max-width: 45%; 
          overflow: hidden; 
          text-overflow: ellipsis; 
          white-space: nowrap; 
      }

      .btn-locate {
          width: 24px; 
          height: 24px; 
          border-radius: var(--radius-sm); 
          display: flex; 
          align-items: center; 
          justify-content: center;
          cursor: pointer; 
          border: 1px solid transparent; 
          background: transparent;
          color: var(--text-tertiary); 
          opacity: 0; 
          transition: all var(--transition-fast);
      }
      .comp-header:hover .btn-locate, .diff-item:hover .btn-locate { opacity: 1; }
      .btn-locate:hover { 
          color: var(--primary); 
          background: var(--primary-light); 
          border-color: var(--primary); 
          opacity: 1; 
      }

      /* 列表区域：占据剩余空间，并在内部滚动 */
      .res-list {
          flex: 1;
          overflow-y: auto;
          padding-bottom: 10px;
          min-height: 0;
      }

      .res-footer { 
        padding: 12px 16px; 
        background: var(--bg-white); 
        border-top: 1px solid var(--border); 
        display: flex; gap: 12px; 
        flex-shrink: 0; 
        z-index: 10;
      }
      .btn-act { 
          flex: 1; 
          padding: 9px; 
          border-radius: var(--radius-md); 
          font-size: 12px; 
          font-weight: 500; 
          cursor: pointer; 
          border: 1px solid var(--border); 
          background: var(--bg-white); 
          color: var(--text-primary); 
          transition: all var(--transition-fast); 
      }
      .btn-act:hover { background: var(--bg-hover); border-color: var(--text-tertiary); }
      .btn-act:disabled { opacity: 0.5; cursor: not-allowed; background: var(--bg-muted); }
      .btn-act.primary { background: var(--primary); color: var(--text-inverse); border-color: var(--primary); }
      .btn-act.primary:hover { background: var(--primary-hover); border-color: var(--primary-hover); }

      .empty-state-refiner {
          display: flex; flex-direction: column; align-items: center; justify-content: center;
          flex: 1; min-height: 0; width: 100%; padding: 16px; text-align: center;
      }
      .empty-state-refiner .es-icon { font-size: 32px; line-height: 1; margin-bottom: 12px; }
      .empty-state-refiner .es-text { font-size: 13px; color: var(--text-secondary); font-weight: 400; line-height: 1.5; }

      .success-state-container { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 20px; text-align: center; }
      .success-emoji { font-size: 48px; margin-bottom: 16px; animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
      .success-overlay {
          position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-white); z-index: 10;
          display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center;
      }
      .success-icon { font-size: 32px; margin-bottom: 16px; color: var(--success); }
      .success-title { font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px; }
      .success-desc { font-size: 12px; color: var(--text-secondary); margin-bottom: 16px; line-height: 1.5; }

      /* 2. 修复查找替换面板 UI 混乱 (Fixes Issue 3) */

      /* 顶部范围切换器 */
      .scope-segment {
          display: flex;
          background: var(--bg-muted);
          padding: 3px;
          border-radius: var(--radius-md);
          margin-bottom: 0px;
          gap: 2px;
          width: 100%;
      }
      .scope-option {
          flex: 1;
          text-align: center;
          padding: 6px 0;
          font-size: 12px;
          color: var(--text-secondary);
          cursor: pointer;
          border-radius: var(--radius-sm);
          transition: all var(--transition-fast);
      }
      .scope-option:hover {
          background: rgba(255,255,255,0.5);
      }
      [data-theme="dark"] .scope-option:hover {
          background: rgba(255,255,255,0.1);
      }
      .scope-option.active {
          background: var(--bg-white);
          color: var(--primary);
          font-weight: 600;
          box-shadow: var(--shadow-sm);
      }

      /* 输入框组容器 */
      .input-group-icon {
          position: relative;
          margin-bottom: 0px;
          width: 100%;
          display: flex;
          align-items: center;
      }

      /* 输入框样式修正 */
      .input-group-icon input {
          width: 100%;
          height: 36px;
          padding: 0 60px 0 32px; /* 左侧留给图标，右侧留给Aa按钮 */
          border: 1px solid var(--border);
          border-radius: var(--radius-md);
          box-sizing: border-box;
          font-size: 13px;
          transition: border var(--transition-fast);
          background: var(--bg-white);
          color: var(--text-primary);
      }
      .input-group-icon input:focus {
          border-color: var(--primary);
          outline: none;
          box-shadow: 0 0 0 3px var(--primary-light);
      }

      /* 左侧图标 */
      .icon-prefix {
          position: absolute;
          left: 10px;
          top: 50%;
          transform: translateY(-50%);
          color: var(--text-tertiary);
          pointer-events: none;
          display: flex;
          align-items: center;
          justify-content: center;
          width: 16px; 
          height: 16px;
      }
      .icon-prefix svg {
          width: 100%;
          height: 100%;
      }

      /* 右侧按钮组 (Aa, ab) */
      .icon-suffix-group {
          position: absolute;
          right: 6px;
          top: 50%;
          transform: translateY(-50%);
          display: flex;
          gap: 2px;
      }

      /* 小开关按钮 */
      .icon-toggle {
          cursor: pointer;
          width: 24px;
          height: 24px;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: var(--radius-sm);
          font-size: 11px;
          font-weight: 600;
          color: var(--text-tertiary);
          border: 1px solid transparent;
          transition: all var(--transition-fast);
          user-select: none;
      }
      .icon-toggle:hover {
          background: var(--bg-hover);
          color: var(--text-secondary);
      }
      .icon-toggle.active {
          background: var(--primary-light);
          color: var(--primary);
          border-color: rgba(99, 102, 241, 0.3);
      }

      /* 修复下拉箭头 */
      .find-expanded svg {
          display: inline-block;
          vertical-align: middle;
      }

      /* =========================================
        11. 设计理论面板 (Design Theory)
        ========================================= */
      .theory-header { 
          padding: 12px 16px 8px; 
          background: var(--bg-white); 
          border-bottom: 1px solid var(--border); 
          flex-shrink: 0; 
      }
      .theory-tags-scroll { 
          display: flex; 
          gap: 8px; 
          overflow-x: auto; 
          padding-bottom: 4px; 
      }
      .theory-tags-scroll::-webkit-scrollbar { display: none; }
      .t-tag {
          padding: 4px 12px; 
          border-radius: var(--radius-full); 
          background: var(--bg-muted); 
          color: var(--text-secondary); 
          font-size: 11px;
          cursor: pointer; 
          white-space: nowrap; 
          transition: all var(--transition-fast); 
          border: 1px solid transparent;
      }
      .t-tag:hover { background: var(--primary-light); color: var(--primary); }
      .t-tag.active { 
          background: var(--primary-light); 
          color: var(--primary); 
          border-color: rgba(99, 102, 241, 0.3); 
          font-weight: 600; 
      }

      .theory-list-container {
          flex: 1; 
          overflow-y: auto; 
          padding: 16px; 
          display: grid; 
          grid-template-columns: 1fr; 
          gap: 12px; 
          align-content: start;
      }
      .theory-card {
          background: var(--bg-white); 
          border: 1px solid var(--border); 
          border-radius: var(--radius-lg); 
          padding: 14px;
          cursor: pointer; 
          transition: all var(--transition-fast);
          display: flex; 
          align-items: flex-start; 
          gap: 12px; 
          box-shadow: var(--shadow-sm);
      }
      .theory-card:hover { 
          transform: translateY(-2px); 
          box-shadow: var(--shadow-lg); 
          border-color: var(--primary); 
      }
      .t-card-icon {
          width: 36px; 
          height: 36px; 
          background: var(--bg-muted); 
          border-radius: var(--radius-md);
          display: flex; 
          align-items: center; 
          justify-content: center; 
          font-size: 18px; 
          flex-shrink: 0;
      }
      .t-card-content { flex: 1; }
      .t-card-title { 
          font-size: 13px; 
          font-weight: 700; 
          color: var(--text-primary); 
          margin-bottom: 4px; 
      }
      .t-card-desc { 
          font-size: 11px; 
          color: var(--text-tertiary); 
          line-height: 1.4; 
          display: -webkit-box; 
          -webkit-line-clamp: 2; 
          -webkit-box-orient: vertical; 
          overflow: hidden; 
      }

      /* Theory Detail */
      .theory-detail-nav { 
          padding: 10px 16px; 
          border-bottom: 1px solid var(--border); 
          background: var(--bg-white); 
          display: flex; 
          justify-content: space-between; 
          align-items: center; 
          flex-shrink: 0; 
      }
      .btn-back-theory {
          border: none; 
          background: transparent; 
          color: var(--text-secondary); 
          font-size: 12px;
          display: flex; 
          align-items: center; 
          gap: 4px; 
          cursor: pointer; 
          padding: 4px 8px; 
          border-radius: var(--radius-sm);
          transition: all var(--transition-fast);
      }
      .btn-back-theory:hover { background: var(--bg-hover); color: var(--text-primary); }
      .detail-cat-badge { 
          font-size: 10px; 
          padding: 2px 6px; 
          background: var(--bg-muted); 
          border-radius: var(--radius-sm); 
          color: var(--text-tertiary); 
      }
      .theory-article-scroll { 
          flex: 1; 
          overflow-y: auto; 
          padding: 20px 24px 40px; 
      }
      .theory-hero { text-align: center; margin-bottom: 24px; }
      .t-icon-large { font-size: 48px; margin-bottom: 12px; }
      .theory-hero h1 { 
          font-size: 20px; 
          color: var(--text-primary); 
          margin: 0 0 8px; 
      }
      .t-subtitle { 
          font-size: 13px; 
          color: var(--text-tertiary); 
          margin: 0; 
      }
      .t-desc-main {
          font-size: 13px; 
          color: var(--text-secondary); 
          margin-top: 12px; 
          line-height: 1.6; 
          padding: 0 12px;
      }
      .t-divider {
          border: 0; 
          border-top: 1px dashed var(--border); 
          margin: 20px 0;
      }

      /* Theory Detail Sub-items */
      #theoryDetailDynamicContent { padding-bottom: 40px; }
      .sub-theory-card {
          background: var(--bg-white); 
          border: 1px solid var(--border); 
          border-radius: var(--radius-xl); 
          padding: 20px;
          margin-bottom: 24px; 
          box-shadow: var(--shadow-md); 
          position: relative;
          overflow: hidden; 
          transition: all var(--transition-fast);
      }
      .sub-theory-card:hover { 
          box-shadow: var(--shadow-lg); 
          transform: translateY(-2px); 
      }
      .sub-theory-card::before {
          content: ''; 
          position: absolute; 
          left: 0; 
          top: 0; 
          bottom: 0; 
          width: 4px; 
          background: var(--primary); 
          opacity: 0.6;
      }
      .st-title { 
          font-size: 15px; 
          font-weight: 700; 
          color: var(--text-primary); 
          margin-bottom: 16px; 
          padding-right: 30px; 
      }
      .st-index { 
          font-family: 'Georgia', serif; 
          font-size: 40px; 
          color: var(--text-primary); 
          opacity: 0.04; 
          position: absolute; 
          right: 10px; 
          top: -5px; 
          pointer-events: none; 
      }
      .st-block { margin-bottom: 14px; }
      .st-block:last-child { margin-bottom: 0; }
      .st-label {
          display: inline-block; 
          font-size: 11px; 
          font-weight: 700; 
          padding: 2px 8px; 
          border-radius: var(--radius-sm); 
          margin-bottom: 6px;
      }
      .lbl-core { background: var(--info-light); color: var(--info); }
      .lbl-case { background: var(--success-light); color: var(--success); }
      .lbl-val  { background: var(--warning-light); color: var(--warning); }
      .st-text { 
          font-size: 13px; 
          color: var(--text-secondary); 
          line-height: 1.6; 
          text-align: justify; 
      }

      /* ========================
        Smart Fill Panel Styles
        ======================== */
      .smart-tabs {
        display: flex;
        background: var(--bg-white);
        border-bottom: 1px solid var(--border);
        padding: 0 16px;
        gap: 20px;
        flex-shrink: 0;
      }
      .smart-tab-item {
        padding: 12px 0;
        font-size: 13px;
        font-weight: 500;
        color: var(--text-secondary);
        cursor: pointer;
        border-bottom: 2px solid transparent;
        transition: all var(--transition-fast);
      }
      .smart-tab-item.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
      }

      .smart-content {
        flex: 1;
        display: none;
        flex-direction: column;
        overflow: hidden;
        background: var(--bg-body);
      }
      .smart-content.active { display: flex; }

      /* 基础列表 */
      .smart-list-container {
        flex: 1;
        overflow-y: auto;
        padding: 8px;
      }
      .smart-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: var(--bg-white);
        padding: 10px 12px;
        margin-bottom: 6px;
        border-radius: var(--radius-md);
        border: 1px solid transparent;
        cursor: pointer;
        transition: all var(--transition-fast);
      }
      .smart-row:hover {
        border-color: var(--primary);
        box-shadow: var(--shadow-sm);
      }
      .smart-label {
        font-size: 13px;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .smart-label .tag-custom {
        font-size: 10px;
        background: var(--primary-light);
        color: var(--primary);
        padding: 1px 4px;
        border-radius: var(--radius-sm);
      }
      .smart-setting-btn {
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-tertiary);
        border-radius: var(--radius-sm);
        transition: all var(--transition-fast);
      }
      .smart-setting-btn:hover {
        background: var(--bg-hover);
        color: var(--text-secondary);
      }

      /* 底部操作栏 */
      .smart-footer {
        background: var(--bg-white);
        padding: 12px;
        border-top: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-shrink: 0;
      }
      .smart-mode-check {
        display: flex;
        gap: 12px;
      }
      .check-item {
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 4px;
        cursor: pointer;
        user-select: none;
        color: var(--text-secondary);
      }

      /* 子页面 (Settings / Custom Add) */
      .sub-page {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        background: var(--bg-white);
        z-index: 50;
        display: none;
        flex-direction: column;
        transform: translateX(100%);
        transition: transform 0.25s ease;
      }

    /* 选择器结果列表样式 */
    .scope-desc {
      font-size: 11px;
      color: var(--text-tertiary);
      margin-top: 8px;
      padding: 0 4px;
      line-height: 1.4;
    }
    .sel-result-item {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      user-select: none;
      transition: background var(--transition-fast);
      font-size: 13px;
      outline: none;
    }
    .sel-result-item:hover {
      background-color: var(--bg-hover);
    }
    .sel-result-item:focus {
      background-color: var(--primary-light);
      position: relative;
    }
    .sel-result-item:focus::before {
      content: '';
      position: absolute;
      left: 0; top: 0; bottom: 0;
      width: 3px;
      background-color: var(--primary);
    }
      .sub-page.open {
        transform: translateX(0);
        display: flex;
      }
      .sub-header {
        padding: 12px 16px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        font-size: 14px;
        color: var(--text-primary);
      }
      .btn-back-sub { cursor: pointer; padding: 4px; margin-left: -4px; }
      .sub-form-container {
        padding: 16px; 
        overflow-y: auto; 
        flex: 1;
      }
      .sub-footer {
        padding: 16px; 
        border-top: 1px solid var(--border); 
        display: flex; 
        gap: 10px;
      }
      .privacy-note {
        margin-top: 16px; 
        padding: 12px; 
        background: var(--bg-muted); 
        border-radius: var(--radius-lg); 
        font-size: 12px; 
        color: var(--text-secondary); 
        line-height: 1.6;
      }
      .btn-primary-outline {
        background: var(--primary-light); 
        color: var(--primary); 
        border-color: var(--primary);
      }
      .btn-primary-outline:hover {
        background: var(--primary); 
        color: var(--text-inverse);
      }

      /* AI 界面 */
      .ai-container {
        padding: 16px;
        display: flex;
        flex-direction: column;
        height: 100%;
        box-sizing: border-box;
      }
      .ai-header-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }
      .ai-textarea {
        width: 100%;
        height: 80px;
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        padding: 8px;
        font-family: inherit;
        font-size: 13px;
        resize: none;
        margin-bottom: 10px;
        background: var(--bg-white);
        color: var(--text-primary);
        transition: all var(--transition-fast);
      }
      .ai-textarea:focus { 
          border-color: var(--primary); 
          outline: none;
          box-shadow: 0 0 0 3px var(--primary-light);
      }
      .ai-result-box {
        flex: 1;
        border: 1px solid var(--border);
        background: var(--bg-muted);
        border-radius: var(--radius-lg);
        padding: 8px;
        overflow-y: auto;
        margin-bottom: 12px;
        font-size: 12px;
        color: var(--text-secondary);
        white-space: pre-wrap;
      }
      .ai-actions {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }
      .btn-ai-action {
        padding: 8px;
        border: 1px solid var(--border);
        background: var(--bg-white);
        border-radius: var(--radius-md);
        font-size: 12px;
        cursor: pointer;
        transition: all var(--transition-fast);
        color: var(--text-primary);
      }
      .btn-ai-action:hover { border-color: var(--primary); color: var(--primary); }
      .btn-ai-action.btn-danger {
        color: var(--danger);
        border-color: var(--danger-light);
      }
      .btn-ai-action.btn-danger:hover {
        background: var(--danger-light);
        border-color: var(--danger);
      }
      .btn-ai-action.btn-ghost {
        color: var(--text-secondary);
        border-color: var(--border);
      }
      .btn-ai-action.btn-ghost:hover {
        background: var(--bg-hover);
        border-color: var(--text-tertiary);
      }

      /* --- 新增样式：标签与自定义Tab --- */

      /* 标签按钮组 */
      .row-tags {
        display: flex;
        gap: 6px;
        align-items: center;
      }

      /* 单个标签按钮 */
      .tag-btn {
        font-size: 11px;
        padding: 2px 8px;
        background: var(--bg-muted);
        color: var(--text-secondary);
        border-radius: var(--radius-sm);
        cursor: pointer;
        transition: all var(--transition-fast);
        border: 1px solid transparent;
        user-select: none;
      }
      .tag-btn:hover {
        background: var(--bg-hover);
      }
      /* 选中状态 */
      .tag-btn.active {
        background: var(--primary-light);
        color: var(--primary);
        border-color: var(--primary);
        font-weight: 500;
      }

      /* 发送到 AI 按钮 */
      .btn-to-ai {
        font-size: 11px;
        padding: 2px 8px;
        background: var(--card-pink-bg);
        color: var(--card-pink-text);
        border-radius: var(--radius-sm);
        cursor: pointer;
        border: 1px solid transparent;
        transition: all var(--transition-fast);
      }
      .btn-to-ai:hover {
        border-color: var(--card-pink-border);
      }

      /* 调整列表行布局，防止挤压 */
      .smart-row {
        flex-wrap: wrap; /* 允许小屏幕换行 */
        gap: 8px;
      }
      .smart-label {
        margin-right: auto; /* 让左侧文字撑开 */
        font-weight: 500;
      }

      /* 单选 Tag 样式 */
      .radio-tag {
          font-size: 12px;
          padding: 4px 12px;
          background: var(--bg-muted);
          border-radius: var(--radius-sm);
          color: var(--text-secondary);
          cursor: pointer;
          border: 1px solid transparent;
          transition: all var(--transition-fast);
      }
      .radio-tag.active {
          background: var(--primary-light);
          color: var(--primary);
          border-color: var(--primary);
          font-weight: 500;
      }
      .radio-tag input { display: none; }

  </style>
</head>
<body>
  
  <!-- 全局 Tooltip -->
  <div id="tooltip-box"></div>

  <!-- 主内容区域 -->
  <div class="container">
    
    <!-- =========================================
        侧边栏 (Sidebar Navigation)
        ========================================= -->
    <div class="sidebar">
      <div class="nav-scroll">
        <!-- 简易工具 -->
        <div class="nav-item active" onclick="switchGroup('simple', this)" data-key="nav_simple">
          <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
            <g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="4">
              <path d="M24 4v8"/>
              <path fill="currentColor" fill-rule="evenodd" d="m22 22l20 4l-6 4l6 6l-6 6l-6-6l-4 6z" clip-rule="evenodd"/>
              <path d="m38.142 9.858l-5.657 5.657M9.858 38.142l5.657-5.657M4 24h8M9.858 9.858l5.657 5.657"/>
            </g>
          </svg>
          <span class="nav-text">简易工具</span>
        </div>
        
        <!-- 选择工具 -->
        <div class="nav-item" onclick="switchGroup('select', this)" data-key="nav_select">
          <svg class="nav-icon" width="200" height="200" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
            <path fill="currentColor" fill-rule="evenodd" d="M16.499 3.924a2.5 2.5 0 0 0-2.575-2.423l-6.356.194l-.072.003a6.16 6.16 0 0 0-5.801 5.87L1.5 13.923a2.5 2.5 0 0 0 4.998.152l.192-6.311A1.16 1.16 0 0 1 7.765 6.69l6.311-.192a2.5 2.5 0 0 0 2.423-2.575Zm27.577 27.577a2.5 2.5 0 0 0-2.575 2.423l-.192 6.311a1.16 1.16 0 0 1-1.074 1.074l-6.311.192a2.5 2.5 0 1 0 .152 4.998l6.356-.194l.072-.003a6.16 6.16 0 0 0 5.801-5.87l.194-6.356a2.5 2.5 0 0 0-2.423-2.575m-10-30a2.5 2.5 0 1 0-.152 4.998l6.31.192a1.16 1.16 0 0 1 1.075 1.074l.192 6.311a2.5 2.5 0 0 0 4.998-.152l-.194-6.357l-.003-.072a6.16 6.16 0 0 0-5.87-5.8zm-30.152 30a2.5 2.5 0 0 1 2.575 2.423l.192 6.311a1.16 1.16 0 0 0 1.074 1.074l6.311.192a2.5 2.5 0 1 1-.152 4.998l-6.356-.194l-.072-.003a6.16 6.16 0 0 1-5.801-5.87L1.5 34.077a2.5 2.5 0 0 1 2.423-2.575Zm29.086-2.585A12.94 12.94 0 0 0 35 22c0-7.18-5.82-13-13-13S9 14.82 9 22s5.82 13 13 13c2.542 0 4.913-.73 6.916-1.99l.456.55c1 1.206 1.984 2.393 3.078 3.564c1.082 1.158 2.718 1.302 3.863.207a32 32 0 0 0 1.018-1.018c1.095-1.145.951-2.781-.207-3.863c-1.171-1.094-2.359-2.078-3.565-3.078zM22 14.5a7.5 7.5 0 1 0 0 15a7.5 7.5 0 0 0 0-15" clip-rule="evenodd"/>
          </svg>
          <span class="nav-text">选择工具</span>
        </div>

        <!-- 智能填充 -->
        <div class="nav-item" onclick="switchGroup('smartFill', this)" data-key="nav_smart">
          <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
            <path fill="currentColor" fill-rule="evenodd" clip-rule="evenodd" d="M24.06 2.914c2.19-2.189 5.77-3.056 8.653-.988a31 31 0 0 1 3.84 3.276a31 31 0 0 1 3.277 3.84c2.067 2.883 1.2 6.464-.989 8.653L17.527 39.009c-.871.871-2.041 1.493-3.377 1.612l-.05.004l-.057-.896l.057.896h-.018l-.044.003l-.043.003l-.122.007a88 88 0 0 1-2.748.1c-1.75.037-4.085.035-6.367-.126a3.9 3.9 0 0 1-3.614-3.615C.983 34.715.98 32.38 1.017 30.63a88 88 0 0 1 .11-2.913l.003-.044v-.016l.895.056l-.894-.057l.004-.051c.119-1.335.74-2.505 1.611-3.377zm8.889 15.017L15.613 35.266a33.3 33.3 0 0 0-4.11-5.015a33.3 33.3 0 0 0-5.013-4.11L23.826 8.807c3.748 1.91 7.214 5.375 9.123 9.125M34.7 28.75a6.95 6.95 0 0 0-4.268 12.437l.734.57a9.75 9.75 0 0 1-4.284.992H3a2.25 2.25 0 0 0 0 4.5h23.883c2.9 0 5.723-.884 8.098-2.525l1.013.788a8.25 8.25 0 0 0 5.065 1.737H45a2.25 2.25 0 1 0 0-4.5h-3.941a3.75 3.75 0 0 1-2.303-.79l-.091-.07l.902-.702a6.95 6.95 0 0 0-4.268-12.438zm2.103 8.885L35 39.039l-1.804-1.403a2.45 2.45 0 0 1 1.505-4.386h.598a2.45 2.45 0 0 1 1.505 4.386" />
          </svg>
          <span class="nav-text">智能填充</span>
        </div>

        <!-- 文字工具 -->
        <div class="nav-item" onclick="switchGroup('text', this)" data-key="nav_text">
          <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
            <path fill="currentColor" fill-rule="evenodd" d="M22.02 7.876c1.114-.068 1.936-.866 1.968-1.982a32 32 0 0 0 0-1.788c-.032-1.116-.854-1.914-1.969-1.982C20.96 2.058 19.356 2 17 2s-3.96.058-5.02.124c-1.114.068-1.936.866-1.968 1.982a32 32 0 0 0 0 1.788c.032 1.116.854 1.914 1.969 1.982l2.2.091S14 15.774 14 24s.18 16.033.18 16.033l-2.2.09c-1.114.07-1.936.867-1.968 1.983a32 32 0 0 0 0 1.788c.032 1.116.854 1.913 1.969 1.982C13.04 45.942 14.646 46 17 46s3.96-.058 5.02-.124c1.114-.069 1.936-.866 1.968-1.982a32 32 0 0 0 0-1.788c-.032-1.116-.854-1.913-1.969-1.982l-2.2-.091S20 32.226 20 24s-.18-16.033-.18-16.033zm2.954 8.353a2 2 0 1 1 .006-4c7.964.012 13.296.168 16.371.297c2.777.116 5.348 2.002 5.761 5.045c.214 1.574.388 3.697.388 6.43s-.174 4.855-.388 6.429c-.413 3.044-2.984 4.929-5.76 5.045c-3.076.13-8.408.286-16.372.297a2 2 0 1 1-.006-4c7.915-.011 13.192-.166 16.21-.293c1.14-.048 1.85-.746 1.964-1.586c.188-1.387.352-3.33.352-5.893s-.164-4.505-.352-5.892c-.114-.84-.825-1.538-1.965-1.586c-3.017-.127-8.294-.282-16.209-.294m-15.696-3.8a2 2 0 1 1 .126 3.999q-1.492.047-2.583.094c-1.143.048-1.856.748-1.97 1.587C4.665 19.495 4.5 21.439 4.5 24c0 2.563.164 4.506.352 5.892c.113.839.826 1.54 1.969 1.587q1.09.046 2.583.094a2 2 0 1 1-.126 3.998q-1.513-.048-2.625-.095c-2.774-.117-5.352-2-5.765-5.046C.675 28.856.5 26.733.5 24s.175-4.855.388-6.429c.413-3.046 2.991-4.93 5.765-5.046q1.112-.046 2.625-.095" clip-rule="evenodd"/>
          </svg>
          <span class="nav-text">文字替换</span>
        </div>

        <!-- PPT Master -->
        <div class="nav-item" onclick="switchGroup('ppt', this)" data-key="nav_ppt">
          <svg class="nav-icon" viewBox="0 0 1024 1024"><path d="M938.652 1023.94H213.341a85.409 85.409 0 0 1-85.348-85.348v-106.61H42.645A42.704 42.704 0 0 1 0.001 789.036V426.682a42.704 42.704 0 0 1 42.644-42.644h85.348V85.348A85.409 85.409 0 0 1 213.341 0h530.04L1023.94 282.427v656.526a85.409 85.409 0 0 1-85.288 84.987z m-746.874-192.019v106.67a21.322 21.322 0 0 0 21.322 21.322h725.552a21.382 21.382 0 0 0 21.382-21.322V308.808l-10.059-10.18h-126.487a98.118 98.118 0 0 1-98.057-97.997V72.64l-8.673-8.613H213.341a21.322 21.322 0 0 0-21.322 21.322v298.69h639.962a42.704 42.704 0 0 1 42.644 42.644V789.036a42.704 42.704 0 0 1-42.644 42.644z m367.835-367.414v33.61h86.433V722.78h39.03V498.418H770.967v-33.61z m-212.136 0V722.78h39.392v-100.406h66.857c61.617 0 92.877-26.622 92.877-79.145s-31.019-78.301-92.155-78.301z m-232.013 0V722.78h39.392v-100.406h66.857c61.617 0 92.877-26.622 92.877-79.145s-31.019-78.301-92.155-78.301z m335.912 124.258H387.11v-90.348h64.267a67.158 67.158 0 0 1 42.162 10.842 39.03 39.03 0 0 1 13.793 33.97 43.005 43.005 0 0 1-13.371 34.694 68.122 68.122 0 0 1-42.584 10.842z m-232.013 0H155.097v-90.348h64.267a67.158 67.158 0 0 1 42.162 10.842 39.03 39.03 0 0 1 13.793 33.97 43.005 43.005 0 0 1-13.371 34.694 68.122 68.122 0 0 1-42.584 10.842z" fill="currentColor"></path></svg>
          <span class="nav-text">PPT Master</span>
        </div>

        <!-- Refiner 工具 -->
        <div class="nav-item" onclick="switchGroup('refiner', this)" data-key="nav_refiner">
          <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
            <path fill="currentColor" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="m17 11l7-7l7 7l-7 7zm13 14l7-7l7 7l-7 7zM17 37l7-7l7 7l-7 7zM4 24l7-7l7 7l-7 7z"/>
          </svg>
          <span class="nav-text">Variant Refiner</span>
        </div>
        <!-- 设计理论 -->
        <div class="nav-item" onclick="switchGroup('theory', this)" data-key="nav_theory">
          <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
            <path fill="currentColor" fill-rule="evenodd" d="M22.252 12.466c.53-3.745 1.665-7.218 2.308-8.997c.568-1.568 2.14-2.684 3.958-2.434c2.5.344 7.658 1.599 12.252 6.193s5.85 9.753 6.193 12.252c.25 1.819-.866 3.39-2.434 3.958c-1.778.643-5.251 1.778-8.995 2.308c-.291 4.515-.779 8.081-1.183 10.475c-.485 2.866-2.595 5.08-5.297 5.874c-12.526 3.677-20.605 4.67-21.806 4.804c-.7.156-2.507.336-4.273-1.18a2 2 0 0 1-.693-.693C.765 43.26.945 41.452 1.101 40.751c.134-1.2 1.127-9.28 4.804-21.806c.793-2.7 3.007-4.812 5.874-5.296c2.393-.404 5.96-.892 10.473-1.183m5.676 25.79c-9.98 2.93-17.033 4.107-19.86 4.505l9.133-9.133a5.01 5.01 0 1 0-2.828-2.829l-9.134 9.135c.397-2.827 1.574-9.88 4.504-19.862c.388-1.322 1.435-2.265 2.702-2.479c2.485-.42 6.352-.943 11.312-1.21c.74.314 2.686 1.26 4.644 3.217c1.952 1.952 2.898 3.894 3.215 4.641c-.266 4.96-.79 8.829-1.21 11.314c-.214 1.267-1.156 2.314-2.478 2.702" clip-rule="evenodd"/>
          </svg>
          <span class="nav-text">设计理论</span>
        </div>  
      </div>
      
      <div class="sidebar-footer">
        <div class="footer-btn lang-btn" onclick="toggleLang()" title="切换语言">
          <span id="langText">中/EN</span>
        </div>
        <div class="footer-btn theme-toggle-btn" onclick="toggleTheme()" title="切换主题">
          <svg id="themeIconLight" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
          </svg>
          <svg id="themeIconDark" style="display:none" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
          </svg>
          <span id="themeText">主题</span>
        </div>
        <div class="footer-btn" id="modeBtn" onclick="toggleMode()" title="切换精简模式" data-key="btn_switch">精简</div>
      </div>
    </div>

    <!-- =========================================
        主内容区 (Main Content)
        ========================================= -->
    <div class="main-content">
      <div class="header" id="mainHeader">
        <input type="text" class="search-box" placeholder="搜索功能..." id="searchInput">
      </div>
      
      <div class="content-scroll">

        

        <!-- Panel 1: 简易工具 (Simple Tools) -->
        <div class="grid" id="toolPanel">
          <!-- 形状 -->
          <div class="card theme-orange" onclick="run('to-frame')" data-key="to_frame"><div class="card-title">To Frame</div></div>
          <div class="card theme-orange" onclick="run('to-rect')" data-key="to_rect"><div class="card-title">To Rectangle</div></div>
          <!-- 文本 -->
          <div class="card theme-pink" onclick="run('split-text')" data-key="split_text"><div class="card-title">Split Text</div></div>
          <div class="card theme-pink" onclick="run('join-text')" data-key="join_text"><div class="card-title">Join Text</div></div>
          <!-- 布局 -->
          <div class="card theme-blue" onclick="run('remove-al')" data-key="remove_al"><div class="card-title">Remove AL</div></div>
          <div class="card theme-blue" onclick="run('add-al-wrapper')" data-key="add_al_wrapper"><div class="card-title">Add AL Wrapper</div></div>
          <!-- 层级与整理 -->
          <div class="card theme-purple" onclick="run('up-one')" data-key="up_one"><div class="card-title">Up One Level</div></div>
          <div class="card theme-purple" onclick="run('up-all')" data-key="up_all"><div class="card-title">Up All Level</div></div>
          <div class="card theme-green" onclick="run('ungroup-all')" data-key="ungroup_all"><div class="card-title">Ungroup All</div></div>
          <div class="card theme-green" onclick="run('unlock-all')" data-key="unlock_all"><div class="card-title">Unlock All</div></div>
          <div class="card theme-orange" onclick="run('swap-fs')" data-key="swap_fs"><div class="card-title">Swap Fill/Stroke</div></div>
          <div class="card theme-orange" onclick="run('reset-image')" data-key="reset_image"><div class="card-title">Reset Image</div></div>
          <!-- 增强功能 -->
          <div class="card theme-pink" onclick="run('sort-layers')" data-key="sort_layers"><div class="card-title">Sort Layers</div></div>
          <div class="card theme-pink" onclick="run('rename-content')" data-key="rename_content"><div class="card-title">Rename Content</div></div>
          <div class="card theme-blue" onclick="run('detach-all')" data-key="detach_all"><div class="card-title">Detach All</div></div>
          <div class="card theme-blue" onclick="run('remove-hidden')" data-key="remove_hidden"><div class="card-title">Clean Hidden</div></div>
          <div class="card theme-purple" onclick="run('pixel-perfect')" data-key="pixel_perfect"><div class="card-title">Pixel Perfect</div></div>
          <div class="card theme-purple" onclick="run('swap-positions')" data-key="swap_positions"><div class="card-title">Swap Positions</div></div>
          <!-- 样式工具 -->
          <div class="card theme-green" onclick="run('create-styles')" data-key="create_styles"><div class="card-title">Create Styles</div></div>
          <div class="card theme-green" onclick="run('match-styles')" data-key="match_styles"><div class="card-title">Match Styles</div></div>
        
        </div>

        <!-- Panel 4: 超级选择工具 (Selection Tools - Redesigned) -->
        <div id="selectionPanel">
          <!-- A. 查询视图 -->
          <div id="selQueryView" style="display:flex; flex-direction:column; height:100%;">
          <div class="selection-scroll-area">
            
            <!-- 1. 查找范围 -->
            <div>
              <div class="section-header"><span class="section-title" data-key="sel_title_scope">查找范围</span></div>
              <div class="scope-control" id="scopeGroup">
                  <!-- 1. 去掉 inside 的 active -->
                  <div class="scope-btn" data-val="inside" onclick="toggleSingle(this, 'scopeGroup')" data-key="sel_scope_in">内在元素</div>
                  
                  <div class="scope-btn" data-val="sibling" onclick="toggleSingle(this, 'scopeGroup')" data-key="sel_scope_sib">同级</div>
                  <div class="scope-btn" data-val="children" onclick="toggleSingle(this, 'scopeGroup')" data-key="sel_scope_child">子级</div>
                  
                  <!-- 2. 给 descendants 加上 active (改为默认) -->
                  <div class="scope-btn active" data-val="descendants" onclick="toggleSingle(this, 'scopeGroup')" data-key="sel_scope_desc">子孙元素</div>
              </div>
              <!-- 新增：范围解释文字 -->
              <div class="scope-desc" id="scopeDescText" data-key="sel_desc_descendants">查找当前选中项及其内部所有图层；若未选择，则查找全页面</div>
            </div>

            <!-- 2. 名称 (增加清除按钮) -->
            <div>
              <div class="section-header"><span class="section-title" data-key="sel_title_name">名称</span></div>
              <div class="name-input-row">
                <div class="name-input-wrapper">
                  <svg class="name-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                  <input type="text" class="name-input" id="filterNameInput" placeholder="输入名称..." data-key="sel_ph_name" oninput="toggleClearBtn(this)">
                  <!-- 新增：清除按钮 -->
                  <div class="btn-clear-input hidden" id="nameClearBtn" onclick="clearNameInput()">✕</div>
                </div>
                <div class="icon-btn-square" onclick="fetchName()" title="拾取选中图层名称">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                </div>
                <div class="icon-btn-square" id="caseBtn" onclick="this.classList.toggle('active')" title="区分大小写">Aa</div>
              </div>
            </div>

            <!-- 3. 类型 (补充缺失项) -->
            <div>
              <div class="section-header">
                <span class="section-title" data-key="sel_title_type">类型</span>
                <div class="mode-switch include" id="typeLogic" onclick="toggleLogic(this)">
                  <span class="ms-in" data-key="logic_in">包含</span><span class="ms-ex" data-key="logic_ex">排除</span>
                </div>
              </div>
              <div class="tag-cloud" id="typeGroup">
                <div class="filter-tag all-tag active" onclick="clearGroup('typeGroup', this)" data-key="sel_type_all">全部类型</div>
                <!-- 基础 -->
                <div class="filter-tag" data-val="FRAME" onclick="toggleMulti(this)" data-key="sel_t_frame"># 画板 (Frame)</div>
                <div class="filter-tag" data-val="GROUP" onclick="toggleMulti(this)" data-key="sel_t_group">:: 组 (Group)</div>
                <div class="filter-tag" data-val="SECTION" onclick="toggleMulti(this)" data-key="sel_t_section">§ 区域 (Section)</div>
                <div class="filter-tag" data-val="AUTOLAYOUT" onclick="toggleMulti(this)" data-key="sel_t_auto">🍱 自动布局</div>
                
                <!-- 组件相关 -->
                <div class="filter-tag" data-val="COMPONENT" onclick="toggleMulti(this)" data-key="sel_t_comp">❖ 组件</div>
                <div class="filter-tag" data-val="COMPONENT_SET" onclick="toggleMulti(this)" data-key="sel_t_compset">💠 变体集</div>
                <div class="filter-tag" data-val="INSTANCE" onclick="toggleMulti(this)" data-key="sel_t_inst">◇ 实例</div>
                
                <!-- 形状与路径 -->
                <div class="filter-tag" data-val="RECTANGLE" onclick="toggleMulti(this)" data-key="sel_t_rect">☐ 矩形</div>
                <div class="filter-tag" data-val="ELLIPSE" onclick="toggleMulti(this)" data-key="sel_t_ell">○ 椭圆</div>
                <div class="filter-tag" data-val="LINE" onclick="toggleMulti(this)" data-key="sel_t_line">/ 直线</div>
                <div class="filter-tag" data-val="VECTOR" onclick="toggleMulti(this)" data-key="sel_t_vect">✎ 矢量</div>
                <div class="filter-tag" data-val="STAR" onclick="toggleMulti(this)" data-key="sel_t_star">★ 星形</div>
                <div class="filter-tag" data-val="POLYGON" onclick="toggleMulti(this)" data-key="sel_t_poly">▲ 多边形</div>
                <div class="filter-tag" data-val="BOOLEAN_OPERATION" onclick="toggleMulti(this)" data-key="sel_t_bool">◑ 布尔运算</div>
                
                <!-- 其他 -->
                <div class="filter-tag" data-val="TEXT" onclick="toggleMulti(this)" data-key="sel_t_text">T 文本</div>
                <div class="filter-tag" data-val="IMAGE" onclick="toggleMulti(this)" data-key="sel_t_img">🌄 图片填充</div>
                <div class="filter-tag" data-val="SLICE" onclick="toggleMulti(this)" data-key="sel_t_slice">✂️ 切片</div>
                <div class="filter-tag" data-val="CONNECTOR" onclick="toggleMulti(this)" data-key="sel_t_conn">⤚ 连接线</div>
                <div class="filter-tag" data-val="SHAPE_WITH_TEXT" onclick="toggleMulti(this)" data-key="sel_t_shape_text">💬 形状文字</div>
                <div class="filter-tag" data-val="STICKY" onclick="toggleMulti(this)" data-key="sel_t_sticky">📝 贴纸</div>
                <div class="filter-tag" data-val="WIDGET" onclick="toggleMulti(this)" data-key="sel_t_widget">🧩 Widget</div>
                <div class="filter-tag" data-val="STAMP" onclick="toggleMulti(this)" data-key="sel_t_stamp">💮 印章</div>
                <div class="filter-tag" data-val="WASHI_TAPE" onclick="toggleMulti(this)" data-key="sel_t_washi">🎞 胶带</div>
              </div>
            </div>

            <!-- 4. 状态 (补充 Mask, Export) -->
            <div>
              <div class="section-header">
                <span class="section-title" data-key="sel_title_state">状态</span>
                <div class="mode-switch include" id="stateLogic" onclick="toggleLogic(this)">
                  <span class="ms-in" data-key="logic_in">包含</span><span class="ms-ex" data-key="logic_ex">排除</span>
                </div>
              </div>
              <div class="tag-cloud" id="stateGroup">
                <div class="filter-tag all-tag active" onclick="clearGroup('stateGroup', this)" data-key="sel_state_all">全部状态</div>
                <div class="filter-tag" data-val="hidden" onclick="toggleMulti(this)" data-key="sel_s_hidden">👻 隐藏</div>
                <div class="filter-tag" data-val="locked" onclick="toggleMulti(this)" data-key="sel_s_lock">🔒 锁定</div>
                <div class="filter-tag" data-val="mask" onclick="toggleMulti(this)" data-key="sel_s_mask">🎭 蒙版 (Mask)</div>
                <div class="filter-tag" data-val="export" onclick="toggleMulti(this)" data-key="sel_s_export">📤 导出 (Export)</div>
                <div class="filter-tag" data-val="no-fill" onclick="toggleMulti(this)" data-key="sel_s_nofill">无填充</div>
                <div class="filter-tag" data-val="no-stroke" onclick="toggleMulti(this)" data-key="sel_s_nostroke">无描边</div>
                <div class="filter-tag" data-val="clip" onclick="toggleMulti(this)" data-key="sel_s_clip">✂️ 裁剪内容</div>
                <div class="filter-tag" data-val="no-children" onclick="toggleMulti(this)" data-key="sel_s_nochild">空容器</div>
              </div>
            </div>

            <!-- 5. 属性 -->
            <div>
              <div class="section-header">
                <span class="section-title" data-key="sel_title_prop">高级属性</span>
                <div class="add-prop-link" onclick="addPropRow()">
                  <span style="font-size:16px;">+</span> <span data-key="sel_add_prop">添加条件</span>
                </div>
              </div>
              <div class="prop-list-container" id="propList">
                <!-- JS 动态添加 -->
              </div>
            </div>

          </div>
          <div class="selection-footer">
            <button class="primary-btn" style="flex: 1;" onclick="runFilter()" data-key="sel_btn_exec">查找并选择</button>
            <button id="btnShowSelResult" class="result-btn" style="display:none; flex: 1;" onclick="showSelectionResults()">
              <span data-key="sel_btn_res_prefix">已找到</span> 
              <span class="result-badge" id="selResultBadge">0</span> 
              <span data-key="sel_btn_res_suffix">项 ➔</span>
            </button>
          </div>
          </div> <!-- End Query View -->

          <!-- B. 结果列表视图 -->
          <div id="selResultView" style="display:none; flex-direction:column; height:100%; background:var(--bg-color);">
             <div class="sel-result-header" style="height:44px; display:flex; align-items:center; padding:0 8px; border-bottom:1px solid var(--border-color); flex-shrink:0;">
                <button class="icon-btn" onclick="hideSelectionResults()" style="height:32px; display:flex; align-items:center; gap:4px; padding:0 8px; border:none; background:transparent; cursor:pointer; font-size:13px; color:var(--text-color); font-weight:600;">
                  <span>⬅</span> <span data-key="sel_btn_back">返回</span>
                </button>
                <div style="flex:1; text-align:center; font-weight:600; font-size:13px; color:var(--text-color);">
                  <span data-key="sel_res_title_prefix">已找到</span> 
                  <span id="selResultCountText">0</span> 
                  <span data-key="sel_res_title_suffix">个图层</span>
                </div>
                <div style="width:60px;"></div> <!-- 占位平衡 -->
             </div>
             
             <div id="selResultList" class="sel-result-list" style="flex:1; overflow-y:auto; padding:4px 0;">
                <!-- Items -->
             </div>
          </div>
        </div>

        <!-- Panel 5: 文字工具 (Text Tools) - 最终UI优化版 -->
        <div id="textPanel">
          
          <!-- 1. 新版顶部功能栏 (常驻) -->
          <!-- 注意：onclick 事件绑定在整个 header 上，实现点击即折叠/展开 -->
          <div id="textPanelHeader" class="text-panel-header expanded" onclick="toggleTextHeader()">
            
            <!-- 左侧：箭头 + 动态标题 -->
            <div class="header-title-group">
              <svg class="header-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
              <span id="txtHeaderTitle" data-key="txt_title_config">查找配置</span>
            </div>

            <!-- 右侧：操作按钮 (阻止冒泡防止触发折叠) -->
            <div class="header-actions">
              <button class="btn-action-small btn-restore" onclick="clearAllHighlights(event)" title="还原所有标红">
                 <span data-key="txt_restore">还原</span> 
              </button>
              <button class="btn-action-small" onclick="resetTextFind(event)">
                 <span data-key="txt_reset">重置</span>
              </button>
            </div>
          </div>

          <!-- 2. 可折叠的内容区域 -->
          <div id="textControlsContent">
              <!-- 范围选择 -->
              <div class="scope-segmented-control">
                 <div class="scope-seg-item active" id="tScopeSel" onclick="toggleTextScope('selection')" data-key="txt_scope_sel">仅选中图层</div>
                 <div class="scope-seg-item" id="tScopePage" onclick="toggleTextScope('page')" data-key="txt_scope_page">当前整个页面</div>
              </div>

              <!-- 查找输入 -->
              <div class="modern-input-group">
                <div class="m-icon">🔍</div>
                <input type="text" id="txtFindInput" placeholder="请输入查找关键词" data-key="txt_ph_find">
              </div>
              
              <!-- 替换输入 -->
              <div class="modern-input-group">
                <div class="m-icon" style="color:#1890FF;">✏️</div>
                <input type="text" id="txtRepInput" placeholder="替换为..." data-key="txt_ph_rep">
              </div>

              <!-- 按钮行 -->
              <button class="btn-find-hero" id="btnTextFind" onclick="startTextFind()">
                <div class="btn-spinner"></div><span data-key="txt_btn_find">开始查找</span>
              </button>
          </div>

          <!-- 3. 结果列表区 (滚动) -->
          <div id="textResultWrapper">
            <!-- 列表头部条 -->
            <div class="text-list-header-bar">
              <label style="display:flex; align-items:center; cursor:pointer; width:100%;">
                <input type="checkbox" id="textSelectAll" style="margin-right:8px;" onclick="toggleTextSelectAll(this.checked)">
                <span id="textHeaderLabel" data-key="txt_label_all">全选 / 共 <b id="textCount" style="color:#333;">0</b> <data-key="txt_label_items">项</data-key></span>
              </label>
            </div>
            
            <!-- 列表容器 -->
            <div id="textResultList" class="text-list-container"></div>
          </div>

          <!-- 4. 空状态 -->
          <div id="textEmptyState" class="empty-state-refiner">
            <div class="es-icon" style="font-size:32px; margin-bottom:12px; opacity:0.8;">📝</div>
            <div class="es-text" style="font-size:13px;" data-key="txt_empty_intro">输入关键词，精准定位并替换</div>
          </div>

          <!-- 5. 底部固定操作栏 -->
          <div id="textFooter" class="text-fixed-footer">
            <button class="primary-btn" id="btnTextBatchRep" disabled onclick="runBatchTextReplace()" data-key="txt_btn_rep_batch">
              替换选中项
            </button>
          </div>

        </div>

        <!-- Panel 6: PPT Master 面板 -->
        <div id="pptPanel" style="display: none;">
          <!-- Loading 遮罩 -->
          <div class="loading-overlay" id="loadingOverlay">
            <div class="spinner"></div>
            <div class="loading-text" id="loadingTitle">Processing...</div>
            <div class="loading-sub" id="loadingMsg">Please wait...</div>
          </div>
          <!-- 仪表盘 -->
          <div class="ppt-dashboard">
            <div class="ppt-tips">
              <b data-key="ppt_tips_title">💕 导出说明：</b>
              <ul>
                <li data-key="ppt_tip_1">建议复制 Page</li>
                <li data-key="ppt_tip_2">图片重命名为 p_img</li>
                <li data-key="ppt_tip_3">建议 1920x1080 尺寸</li>
                <li data-key="ppt_tip_4">建议初次分步操作</li>
                <li data-key="ppt_tip_5">图片导出为占位符</li>
              </ul>
            </div>
            <button class="btn-auto-run" id="btnAutoRun" onclick="startAutoRun()"><span data-key="ppt_btn_auto">🚀 一键全自动导出 PPT</span></button>
          </div>
          <!-- 步骤 -->
          <div class="ppt-content-area">
            <div class="ppt-step active" id="pptStep1">
              <div class="ppt-icon">🧹</div>
              <div class="ppt-title" data-key="ppt_step1_t">1. 全局清洗</div>
              <div class="ppt-desc" data-key="ppt_step1_d">解锁图层、移除隐藏项、解绑组件。</div>
              <div class="ppt-status" id="status1" data-key="ppt_stat_wait">等待执行</div>
            </div>
            <div class="ppt-step" id="pptStep2">
              <div class="ppt-icon">🖼️</div>
              <div class="ppt-title" data-key="ppt_step2_t">2. 图标栅格化</div>
              <div class="ppt-desc" data-key="ppt_step2_d">将矢量图标和 p_img 组转换为高清位图。</div>
              <div class="ppt-status" id="status2">等待执行</div>
            </div>
            <div class="ppt-step" id="pptStep3">
              <div class="ppt-icon">📑</div>
              <div class="ppt-title" data-key="ppt_step3_t">3. 深度扁平化</div>
              <div class="ppt-desc" data-key="ppt_step3_d">消除所有分组和嵌套，修复层级遮挡。</div>
              <div class="ppt-status" id="status3">等待执行</div>
            </div>
            <div class="ppt-step" id="pptStep4">
              <div class="ppt-icon">📊</div>
              <div class="ppt-title" data-key="ppt_step4_t">4. 生成 PPT 结构</div>
              <div class="ppt-desc" data-key="ppt_step4_d">提取布局信息，生成 .pptx 文件。</div>
              <label style="font-size:12px; display:block; margin-bottom:10px;">
                <input type="checkbox" id="pptScale" checked> <span data-key="ppt_step4_scale">缩放至 16:9 (960x540)</span>
              </label>
              <div class="ppt-status" id="status4">等待执行</div>
            </div>
            <div class="ppt-step" id="pptStep5">
              <div class="ppt-icon">📦</div>
              <div class="ppt-title" data-key="ppt_step5_t">5. 导出资源包</div>
              <div class="ppt-desc" data-key="ppt_step5_d">打包下载图片资源 (.zip)。</div>
              <div class="ppt-status" id="status5">等待执行</div>
            </div>
            <div class="ppt-step" id="pptStep6">
              <div class="ppt-icon" style="background:#f6ffed; color:#52c41a; border-color:#b7eb8f;">🎉</div>
              <div class="ppt-title" data-key="ppt_step6_t">全部完成</div>
              <div class="ppt-desc" data-key="ppt_step6_d">文件已生成，请下载。</div>
              <button class="btn-manual-dl" onclick="generateAssetsZip()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                <span data-key="ppt_btn_manual">📦 没收到文件？点此手动下载</span>
              </button>
            </div>
          </div>
          <!-- 底部 -->
          <div class="ppt-progress-track"><div class="ppt-progress-fill" id="pptProgBar"></div></div>
          <div class="ppt-footer">
            <button style="width: 30%; color:#999;" onclick="resetPPT()" data-key="ppt_btn_reset">↺ 重置</button>
            <button class="primary-btn" style="width: 70%;" id="pptActionBtn" data-key="ppt_btn_run">分步执行 STEP 1</button>
          </div>
        </div>

        <!-- Panel 7: Variant Refiner (组件清洗) -->
        <div id="refinerPanel" style="display: none;">
          <!-- Tabs -->
          <div class="refiner-tabs">
            <div class="refiner-tab-item active" onclick="switchRefinerTab('lint')" data-key="ref_tab_lint">智能检查 (Lint)</div>
            <div class="refiner-tab-item" onclick="switchRefinerTab('find')" data-key="ref_tab_find">查找替换 (Find)</div>
          </div>

          <!-- Tab 1: Lint (智能检查) -->
          <div id="tabLint" class="refiner-tab-content active">
            
            <!-- 1. 配置页面 (默认显示) -->
            <div id="lintConfigPage" class="lint-controls-wrapper">
              <div class="refiner-config">
                
                <!-- A. 检查范围 -->
                <div class="config-group">
                  <label class="config-label" data-key="lbl_scope">检查范围</label>
                  <div class="radio-grid">
                    <div class="radio-item active" data-value="selection" onclick="selectRadio(this, 'scope', 'selection')">
                      <span data-key="scope_sel">选中图层</span>
                    </div>
                    <div class="radio-item" data-value="page" onclick="selectRadio(this, 'scope', 'page')">
                      <span data-key="scope_page">当前页面</span>
                    </div>
                  </div>
                </div>

                <!-- A2. 目标类型 (多选) -->
                <div class="config-group">
                  <label class="config-label" data-key="lbl_target_type">目标类型</label>
                  <div class="checkbox-grid-row">
                    <label class="checkbox-chip active" onclick="toggleTargetChip(this)">
                      <input type="checkbox" id="target_comp_name" checked>
                      <span data-key="target_comp_name">组件名</span>
                    </label>
                    <label class="checkbox-chip active" onclick="toggleTargetChip(this)">
                      <input type="checkbox" id="target_prop_name" checked>
                      <span data-key="target_prop_name">属性名</span>
                    </label>
                    <label class="checkbox-chip active" onclick="toggleTargetChip(this)">
                      <input type="checkbox" id="target_prop_value" checked>
                      <span data-key="target_prop_value">属性值</span>
                    </label>
                  </div>
                </div>

                <!-- B. 目标命名风格 (重构) -->
                <div class="config-group">
                  <label class="config-label" data-key="lbl_case">目标命名风格</label>
                  
                  <div class="style-section">
                    <!-- 1. 格式 Format (三选一) -->
                    <div>
                      <div class="sub-label" data-key="lbl_fmt">格式 (Format)</div>
                      <div class="radio-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                        <div class="radio-item" data-value="camelCase" onclick="selectRadio(this, 'format', 'camelCase'); updateStyleUI();">camelCase</div>
                        <div class="radio-item" data-value="PascalCase" onclick="selectRadio(this, 'format', 'PascalCase'); updateStyleUI();">PascalCase</div>
                        <!-- 默认选中分隔符模式 -->
                        <div class="radio-item active" data-value="separator" onclick="selectRadio(this, 'format', 'separator'); updateStyleUI();" data-key="opt_fmt_sep">分隔符模式</div>
                      </div>
                    </div>

                    <!-- 2. 分隔符与大小写 (并排) -->
                    <div id="separatorOptions" class="split-row">
                      <!-- 左：分隔符 -->
                      <div class="split-col">
                        <div class="sub-label" data-key="lbl_sep">分隔符 (Separator)</div>
                        <div class="radio-grid" style="grid-template-columns: 1fr;">
                          <div class="radio-item" data-value="snake" onclick="selectRadio(this, 'sep', 'snake')">Snake (_)</div>
                          <div class="radio-item" data-value="kebab" onclick="selectRadio(this, 'sep', 'kebab')">Kebab (-)</div>
                          <!-- 默认 Space -->
                          <div class="radio-item active" data-value="space" onclick="selectRadio(this, 'sep', 'space')">Space ( )</div>
                        </div>
                      </div>
                      
                      <!-- 右：大小写 -->
                      <div class="split-col">
                        <div class="sub-label" data-key="lbl_casing">大小写 (Casing)</div>
                        <div class="radio-grid" style="grid-template-columns: 1fr;">
                          <div class="radio-item" data-value="none" onclick="selectRadio(this, 'casing', 'none')" data-key="opt_keep_orig">保持原样</div>
                          <div class="radio-item" data-value="upper" onclick="selectRadio(this, 'casing', 'upper')">UPPER CASE</div>
                          <!-- 默认 Lower -->
                          <div class="radio-item active" data-value="lower" onclick="selectRadio(this, 'casing', 'lower')">lowercase</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- C. 清洗选项 -->
                <div class="config-group">
                  <label class="config-label" data-key="lbl_opt">清洗选项</label>
                  <label class="checkbox-row"><input type="checkbox" id="opt_trim" checked> <span data-key="opt_trim">去除首尾空格</span></label>
                  <label class="checkbox-row"><input type="checkbox" id="opt_emoji" checked> <span data-key="opt_emoji">保留 Emoji</span></label>
                  <label class="checkbox-row"><input type="checkbox" id="opt_id" checked> <span data-key="opt_id">移除 Figma ID (#123)</span></label>
                  <!-- 🔥 新增选项：清除隐藏标记 -->
                  <label class="checkbox-row" style="color:#d46b08;">
                      <input type="checkbox" id="opt_unmark_hidden"> 
                      <span data-key="opt_unmark">清除隐藏标记 (Remove . / _)</span>
                  </label>
                </div>

                <!-- 开始按钮 -->
                <button id="btnLintStart" class="btn-start-lint" >
                  <div class="btn-spinner"></div><span data-key="btn_start_check">检查并预览</span>
                </button>

              </div>
            </div>

            <!-- 结果列表容器 -->
            <div id="lintResultsWrapper" style="display:none; flex-direction:column; flex:1; overflow:hidden;">
                
                <!-- 1. 列表头部 -->
                <div class="res-header">
                  <div class="header-left">
                    <input type="checkbox" id="lintSelectAll" class="header-cb" checked onclick="toggleSelectAll('lint', this.checked)">
                    <span style="font-size:12px; font-weight:600;"><span data-key="res_title">检查结果</span> (<span id="lintCount">0</span>)</span>
                  </div>
                  <button class="btn-reset" onclick="resetLintList()" data-key="btn_back">↺ 返回配置</button>
                </div>
                
                <!-- 2. 列表内容 -->
                <div id="lintList" class="res-list"></div>
                
                <!-- 3. 空状态 (查无结果时显示) -->
                <div id="lintEmpty" class="empty-state-refiner" style="display:none;">
                  <div class="es-icon">✨</div>
                  <div class="es-text" style="margin-bottom:20px;">太棒了！未发现需要修复的组件命名</div>
                  <!-- 🔥 关键：在这里也加上返回按钮 -->
                  <button class="primary-btn" style="width:auto; padding:8px 32px;" onclick="resetLintList()" data-key="btn_back">返回配置</button>
                </div>

                <!-- 4. 修复成功页 -->
                <div id="lintSuccess" class="success-state-container" style="display:none;">
                  <div class="success-emoji">🎉</div>
                  <div style="font-size:16px; font-weight:600; color:#333; margin-bottom:8px;">全部修复完成</div>
                  <div style="font-size:13px; color:#666; margin-bottom:20px;">命名已更新，界面更加整洁了。</div>
                  <!-- 这个按钮也调用 resetLintList -->
                  <button class="primary-btn" style="width:auto; padding:8px 32px;" onclick="resetLintList()">返回继续检查</button>
                </div>
                <!-- 🔥🔥🔥 结束 🔥🔥🔥 -->

                <!-- 5. 底部按钮 -->
                <div class="res-footer" id="lintFooter">
                  <button class="btn-act primary" onclick="fixRefiner('checked')">修复选中项</button>
                </div>

            </div>
          </div>

          <!-- Tab 2: Find & Replace (查找替换) -->
          <!-- Tab 2: 查找替换 (Find) -->
          <div id="tabFind" class="refiner-tab-content">
            
            <div class="find-controls" style="overflow:visible;">
              
              <!-- 1. 折叠后的摘要条 (默认隐藏) -->
              <!-- 🔥🔥🔥 重点：加了 style="display:none;" 🔥🔥🔥 -->
              <div id="findSummaryBar" class="find-summary-bar" style="display:none;" onclick="toggleFindHeader(true)">
                <div class="summary-text">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" style="margin-right:6px;"><polyline points="6 9 12 15 18 9"></polyline></svg>
                  <span>点击展开配置</span>
                </div>
              </div>

              <!-- 2. 展开的配置面板 -->
              <div id="findControlsExpanded" class="find-expanded" style="max-height:none;">
                
                <!-- 🔥 修改点 1: 范围选择器移到最上方 -->
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                  <!-- <span style="font-size:12px; font-weight:600; color:#333;">查找范围</span> -->
                  <div class="scope-segment">
                      <div class="scope-option active" id="fScopeSel" onclick="toggleFindScope('selection')" data-key="ref_scope_sel_short">选中图层</div>
                      <div class="scope-option" id="fScopePage" onclick="toggleFindScope('page')" data-key="ref_scope_page_short">当前页面</div>
                  </div>
                </div>

                <!-- 查找输入 -->
                <div class="input-group-icon">
                  <div class="icon-prefix"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg></div>
                  <input type="text" id="inpFind" placeholder="Search variants..." data-key="ref_ph_find">
                  <div class="icon-suffix-group">
                    <div class="icon-toggle" id="btnCase" onclick="this.classList.toggle('active')" title="Aa">Aa</div>
                    <div class="icon-toggle" id="btnWhole" onclick="this.classList.toggle('active')" title="ab">ab</div>
                  </div>
                </div>
                
                <!-- 替换输入 -->
                <div class="input-group-icon" style="margin-top:8px;">
                  <div class="icon-prefix" style="color:#1890FF;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg></div>
                  <input type="text" id="inpRep" placeholder="Replace with..." data-key="ref_ph_rep">
                </div>

                <!-- 搜索目标 Filter -->
                <div class="filter-chips-row" style="margin-top:8px;">
                  <div class="chip-check active" onclick="toggleChip(this)" data-target="PropName" data-key="ref_chip_pname">Prop Name</div>
                  <div class="chip-check active" onclick="toggleChip(this)" data-target="PropValue" data-key="ref_chip_pval">Prop Value</div>
                </div>

                <!-- 🔥 修改点 2: 互斥选项逻辑 -->
                <div class="find-options" style="flex-direction:column; gap:6px; align-items:flex-start; margin-top:10px;">
                  <label class="checkbox-center" title="在名称前自动添加 '.'">
                      <input type="checkbox" id="opt_mark_hidden_find" onchange="handleExclusiveFindOptions('mark')"> 
                      <span data-key="opt_mark_hidden">标记为隐藏组件 (Add .)</span>
                  </label>
                  <label class="checkbox-center" title="移除名称开头的 '.' 或 '_'" style="color:#d46b08;">
                      <input type="checkbox" id="opt_unmark_hidden_find" onchange="handleExclusiveFindOptions('unmark')"> 
                      <span data-key="opt_unmark">清除隐藏标记 (Remove . / _)</span>
                  </label>
                </div>

                <!-- 查找按钮 -->
                <button class="btn-start-lint" id="btnFindStart" >
                  <div class="btn-spinner"></div><span data-key="ref_btn_find_preview">查找并预览</span>
                </button>

                <!-- 🔥 修改点 3: 收起箭头 -->
                <div style="text-align:center; padding-top:6px; cursor:pointer; color:#999;" onclick="toggleFindHeader(false)">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="18 15 12 9 6 15"></polyline></svg>
                </div>

              </div>
            </div>

            <!-- 结果列表区 -->
            <div id="findResultsWrapper" style="display:flex; flex-direction:column; flex:1; overflow:hidden;">
              <div class="res-header" id="findListHeader" style="display:none;">
                <div class="header-left">
                  <input type="checkbox" id="findSelectAll" class="header-cb" checked onclick="toggleSelectAll('find', this.checked)">
                  <span style="font-size:12px; font-weight:600;">
                    <span data-key="res_title">Result</span> (<span id="findCount">0</span>)
                  </span>
                </div>
              </div>

              <div id="findList" class="res-list">
                <div class="empty-state-refiner">
                  <div class="es-icon">🔍</div>
                  <div class="es-text" data-key="ref_empty_find_init">输入关键词预览修改效果</div>
                </div>
              </div>
              <!-- 🔥🔥🔥 新增：查找替换专用的成功页 🔥🔥🔥 -->
              <div id="findSuccess" class="success-state-container" style="display:none;">
                <div class="success-emoji">🎉</div>
                <div style="font-size:16px; font-weight:600; color:#333; margin-bottom:8px;">替换完成</div>
                <div style="font-size:13px; color:#666; margin-bottom:20px;">
                  本次共成功替换 <b id="findSuccessCount">0</b> 项。
                </div>
                <!-- 点击按钮调用 resetFindState -->
                <button class="primary-btn" style="width:auto; padding:8px 32px;" onclick="resetFindState()">继续查找</button>
              </div>
            </div>
            
            <div class="res-footer" id="findFooter">
              <button class="btn-act primary" id="btnRepChecked" disabled onclick="fixRefiner('checked')">Replace Selected</button>
            </div>
          </div>

          <!-- Success Overlay -->
          <div id="successResultView" class="success-overlay">
            <div class="success-icon">✅</div>
            <div class="success-title">修复成功 (Fixed)</div>
            <div class="success-desc">
              本次共修复 <b id="successCount" style="color:#333;">0</b> 项。<br>点击继续，返回列表处理剩余项。
            </div>
            <button class="primary-btn" style="width:120px;" onclick="continueAfterFix()">继续 (Continue)</button>
          </div>
        </div>

        <!-- Panel 8: Design Theory (设计理论) -->
        <div id="theoryPanel" style="display: none; flex-direction: column; height: 100%; background: var(--bg-white);">
          
          <!-- 1. 列表视图 -->
          <div id="theoryListView" style="display: flex; flex-direction: column; height: 100%;">
            <!-- 顶部：分类 Tag -->
            <div class="theory-header">
              <div class="theory-tags-scroll">
                <div class="t-tag active" onclick="filterTheory('all', this)">全部</div>
                <div class="t-tag" onclick="filterTheory('interaction', this)">交互与可用性</div>
                <div class="t-tag" onclick="filterTheory('psychology', this)">心理学</div>
                <div class="t-tag" onclick="filterTheory('visual', this)">视觉感知</div>
                <div class="t-tag" onclick="filterTheory('business', this)">商业策略</div>
                <div class="t-tag" onclick="filterTheory('system', this)">系统思维</div>
              </div>
            </div>
            
            <!-- 列表内容 -->
            <div class="theory-list-container" id="theoryGrid">
              <!-- JS 动态渲染卡片 -->
            </div>
          </div>

          <!-- 2. 详情视图 (默认隐藏) -->
          <div id="theoryDetailView" style="display: none; flex-direction: column; height: 100%; background: var(--bg-white);">
            <div class="theory-detail-nav">
              <button class="btn-back-theory" onclick="closeTheoryDetail()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"></polyline></svg>
                返回列表
              </button>
              <div class="detail-cat-badge" id="detailCatBadge">Category</div>
            </div>
            
            <!-- 修改后的详情页滚动区域 -->
            <div class="theory-article-scroll">
              <!-- 头部 Hero 区域 (保持不变) -->
              <div class="theory-hero">
                <div class="t-icon-large" id="detailIcon">💡</div>
                <h1 id="detailTitle">Theory Title</h1>
                <p class="t-subtitle" id="detailSubtitle">Subtitle</p>
                <!-- 新增：总体描述 -->
                <p id="detailMainDesc" class="t-desc-main"></p>
              </div>
              
              <hr class="t-divider">

              <!-- 新增：动态渲染区域 (核心变化) -->
              <div id="theoryDetailDynamicContent">
                <!-- JS 将在这里插入一个个子理论卡片 -->
              </div>
            </div>
          </div>
        </div>

        <!-- Panel 10: 智能填充 (Smart Fill) -->
        <div id="smartFillPanel" style="display: none; flex-direction: column; height: 100%; background: var(--bg-white); position: relative; overflow: hidden;">
          
          <!-- 顶部 Tabs -->
          <div class="smart-tabs">
            <div class="smart-tab-item active" onclick="switchSmartTab('basic')" data-key="sf_tab_basic">基础填充</div>
            <div class="smart-tab-item" onclick="switchSmartTab('ai')" data-key="sf_tab_ai">AI 生成</div>
            <div class="smart-tab-item" onclick="switchSmartTab('custom')" data-key="sf_tab_custom">自定义字段</div>
          </div>

          <!-- Tab 1: 基础填充 -->
          <div id="smartBasic" class="smart-content active">
            <div class="smart-list-container" id="smartBasicList">
              <!-- JS 动态生成列表项 -->
            </div>
            <div class="smart-footer">
               <div class="smart-mode-check">
                 <label class="check-item"><input type="checkbox" id="sfPrefix"> <span data-key="sf_prefix">加为前缀</span></label>
                 <label class="check-item"><input type="checkbox" id="sfSuffix"> <span data-key="sf_suffix">加为后缀</span></label>
               </div>
               
            </div>
          </div>

          <!-- Tab 2: AI 生成 -->
          <div id="smartAI" class="smart-content">
             <div class="ai-container">
               <div class="ai-header-row">
                 <span style="font-weight:600; font-size:13px;" data-key="sf_ai_title">AI 对话生成</span>
                 <div class="icon-btn-square" onclick="openSubPage('pageAiConfig')" style="width:28px; height:28px;" title="配置模型">⚙️</div>
               </div>
               
               <textarea class="ai-textarea" id="aiPrompt" placeholder="例：生成20个高档小区名称..."></textarea>
               
               <!-- 新增：控制栏 (思考模式 + 按钮组) -->
               <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; gap: 12px;">
                   
                   <!-- 思考模式开关 (左侧) -->
                   <label class="check-item" title="关闭可加快速度。" style="flex-shrink: 0;">
                       <input type="checkbox" id="aiThinkingToggle"> 
                       <span>DeepThink</span>
                   </label>

                   <!-- 按钮组 (右侧) -->
                   <div style="display: flex; gap: 8px; flex: 1;">
                       <button class="primary-btn" id="btnAiGen"  style="flex: 1; margin-bottom: 0;">
                          <span data-key="sf_btn_gen">生成内容</span>
                       </button>
                       <button class="btn-ai-action btn-ghost" onclick="clearAiInput()" style="width: auto; padding: 0 12px;" title="清空">
                          🗑️
                       </button>
                   </div>
               </div>

               <div class="ai-result-box" id="aiResultArea" placeholder="生成结果将显示在这里..."></div>
               
               <div class="ai-actions">
                 <button class="btn-ai-action"  data-key="sf_btn_seq">⬇ 顺序录入</button>
                 <button class="btn-ai-action"  data-key="sf_btn_rnd">🔀 随机录入</button>
                 <button class="btn-ai-action"  title="保存为新的列表" data-key="sf_btn_new_list">
                    💾 存为新列表
                 </button>
                 <button class="btn-ai-action"  title="追加到已有列表" data-key="sf_btn_append_list">
                    ➕ 追加到列表
                 </button>
               </div>
             </div>
          </div>

          <!-- Tab 3: 新增 自定义字段 -->
          <div id="smartCustom" class="smart-content">
            <div class="smart-list-container" id="smartCustomList">
              <!-- JS 动态渲染自定义列表 -->
              <div class="empty-state-refiner" id="customEmptyState" style="display:none;">
                  <div class="es-text" data-key="sf_empty_custom">暂无自定义数据<br>请在“AI生成”中保存或点击下方添加</div>
              </div>
            </div>
            <div class="smart-footer" style="display: flex; gap: 10px;">
              <!-- 左侧：功能按钮组 -->
              <div style="display: flex; gap: 6px;">
                  <button class="btn-ai-action btn-danger" onclick="clearAllCustomLists()" title="清空列表">🗑️</button>
                  <button class="btn-ai-action"  title="导出 JSON">📤</button>
                  <button class="btn-ai-action"  title="导入 JSON">📥</button>
              </div>
              
              <!-- 隐藏的文件上传 input -->
              <input type="file" id="importFileBtn" accept=".json" style="display: none;" onchange="importCustomLists(this)">

              <!-- 右侧：添加按钮 -->
              <button class="primary-btn" style="flex: 1;" onclick="openAddCustomPage()" data-key="sf_btn_add_new">+ 添加新列表</button>
            </div>
          </div>

          <!-- 子页面 1: 添加自定义类型 -->
          <div id="pageAddCustom" class="sub-page">
            <div class="sub-header">
              <span class="btn-back-sub" onclick="closeSubPage('pageAddCustom')">←</span>
              <span data-key="sf_sub_add_title">添加自定义数据</span>
            </div>
            <div style="padding:16px; flex:1; display:flex; flex-direction:column; gap:10px;">
              <input type="text" id="customTitle" class="search-box" placeholder="标题 (如: 部门列表)">
              <textarea id="customContent" class="ai-textarea" style="flex:1;" placeholder="输入内容，每行一个..."></textarea>
              <button class="primary-btn" onclick="saveCustomList()">保存</button>
            </div>
          </div>

          <!-- 子页面 2: AI 配置 -->
          <div id="pageAiConfig" class="sub-page">
            <div class="sub-header">
              <span class="btn-back-sub" onclick="closeSubPage('pageAiConfig')">←</span>
              <span data-key="sf_sub_cfg_title">AI 模型配置</span>
            </div>
            <div style="padding:16px; display:flex; flex-direction:column; gap:12px;">
              
              <div>
                <label class="config-label" data-key="sf_lbl_provider">服务商</label>
                <select id="aiProvider" class="search-box" onchange="updateAiConfigDefaults()">
                  <!-- 默认选中 GLM -->
                  <option value="glm" selected>智谱 GLM (默认)</option>
                  
                  <option value="deepseek">DeepSeek</option>
                  <option value="kimi">Kimi (Moonshot)</option>
                  <option value="qwen">通义千问 (Qwen)</option>
                  <option value="openai">OpenAI</option>
                  <option value="gemini">Google Gemini</option>
                  <option value="claude">Anthropic Claude</option>
                  <option value="grok">xAI Grok</option>
                  <option value="ollama">Ollama (Local)</option>
                  <option value="siliconflow">硅基流动 (SiliconFlow)</option>
                  
                  <option value="custom">Custom (自定义)</option>
                </select>
              </div>

              <div>
                <label class="config-label" data-key="sf_lbl_baseurl">API 地址 (Base URL)</label>
                <input type="text" id="aiBaseUrl" class="search-box">
              </div>

              <div>
                <label class="config-label" data-key="sf_lbl_model">模型名称 (Model)</label>
                <input type="text" id="aiModelName" class="search-box">
              </div>

              <div>
                <label class="config-label">API Key</label>
                <input type="password" id="aiKey" class="search-box" placeholder="sk-...">
              </div>

              <button class="primary-btn" onclick="saveAiConfig()" style="margin-top:10px;" data-key="sf_btn_save_cfg">保存配置</button>
              
              <div class="privacy-note" data-key="sf_privacy_note">
                隐私说明：本插件没有后台服务器，API Key 仅保存在本地。Figma 卸载重装后需要重新填写 Key，请放心使用。
              </div>
            </div>
          </div>
          
           <!-- 子页面 3: 简单设置页 (用于基础类型的简单设置) -->
          <div id="pageBasicSetting" class="sub-page">
             <div class="sub-header">
              <span class="btn-back-sub" onclick="closeSubPage('pageBasicSetting')">←</span>
              <span id="basicSettingTitle">设置</span>
            </div>
            <div class="sub-form-container" id="settingFormContainer">
               <!-- 动态插入表单 -->
            </div>
            <div class="sub-footer">
                <button class="primary-btn" onclick="saveCurrentSettings()" style="flex:1;" data-key="sf_btn_save_cfg">保存配置</button>
                <button class="btn-ai-action btn-primary-outline" onclick="saveAndFill()" style="flex:1;" data-key="sf_btn_save_fill">保存并填充</button>
            </div>
          </div>

        </div>

        <!-- Panel 9: 空状态 (Fallback) -->
        <div id="emptyPanel" class="empty-state">
          <svg class="empty-icon" viewBox="0 0 24 24" fill="#ccc"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
          <div class="empty-text" data-key="empty_title"></div>
          <div style="font-size:11px; margin-top:4px;" data-key="empty_desc"></div>
        </div>

      </div>
      
      <!-- Resize Handle -->
      <div class="resize-handle" id="resizeHandle"></div>
    </div>
  </div>

  <!-- Error Toast -->
  <div id="errorToast">
    <span class="toast-icon">⚠️</span>
    <span class="toast-message">发生错误</span>
    <button class="toast-close" onclick="hideErrorToast()">✕</button>
  </div>

  <!-- 自定义通用弹窗 (用于保存/追加) -->
  <div id="saveDialog" class="sub-page" style="height: auto; max-height: 80%; bottom: 0; top: auto; border-radius: 12px 12px 0 0; box-shadow: 0 -4px 20px rgba(0,0,0,0.15);">
    <div class="sub-header">
      <span id="saveDialogTitle" data-key="sf_dialog_title">保存列表</span>
      <span class="btn-back-sub" onclick="closeSaveDialog()" style="margin-left: auto;">✕</span>
    </div>
    <div style="padding: 20px; display: flex; flex-direction: column; gap: 16px;">
      
      <!-- 模式 A: 新建 -->
      <div id="saveModeNew">
        <label class="config-label" style="margin-bottom: 8px; display: block;" data-key="sf_mode_new">列表标题</label>
        <input type="text" id="saveNewTitle" class="search-box" placeholder="请输入标题..." data-key="sf_ph_dialog_title">
      </div>

      <!-- 模式 B: 追加 -->
      <div id="saveModeAppend" style="display: none;">
        <label class="config-label" style="margin-bottom: 8px; display: block;" data-key="sf_mode_append">选择目标列表</label>
        <select id="saveTargetSelect" class="search-box">
           <!-- JS 动态填充 -->
        </select>
      </div>

      <div style="display: flex; gap: 10px; margin-top: 10px;">
        <button class="btn-ai-action" onclick="closeSaveDialog()" style="flex: 1;" data-key="sf_btn_cancel">取消</button>
        <button class="primary-btn" onclick="confirmSaveDialog()" style="flex: 1;" data-key="sf_btn_confirm">确定</button>
      </div>
    </div>
  </div>
  
  <!-- 遮罩层 (用于点击空白关闭) -->
  <div id="dialogOverlay" onclick="closeSaveDialog()" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 49; display: none;"></div>

  <script>
    // =============================================================================
    // 1. 全局变量与配置 (Globals)
    // =============================================================================
    
    // --- 内存缓存系统 ---
    const MemoryCache = {
      _data: {},
      
      get(key) {
        return this._data[key];
      },
      
      set(key, value) {
        this._data[key] = value;
        return value;
      },
      
      has(key) {
        return key in this._data;
      },
      
      remove(key) {
        delete this._data[key];
      },
      
      clear() {
        this._data = {};
      }
    };
    
    // --- 持久化缓存系统 ---
    const PersistentCache = {
      prefix: 'allinone_',
      
      get(key) {
        try {
          const data = localStorage.getItem(this.prefix + key);
          return data ? JSON.parse(data) : null;
        } catch (e) {
          console.warn('[Cache] Read error:', e);
          return null;
        }
      },
      
      set(key, value) {
        try {
          localStorage.setItem(this.prefix + key, JSON.stringify(value));
          return value;
        } catch (e) {
          console.warn('[Cache] Write error:', e);
          return null;
        }
      },
      
      remove(key) {
        try {
          localStorage.removeItem(this.prefix + key);
        } catch (e) {
          console.warn('[Cache] Remove error:', e);
        }
      },
      
      clear() {
        try {
          Object.keys(localStorage)
            .filter(k => k.startsWith(this.prefix))
            .forEach(k => localStorage.removeItem(k));
        } catch (e) {
          console.warn('[Cache] Clear error:', e);
        }
      }
    };
    
    // --- 全局错误处理器 ---
    const ErrorHandler = {
      errors: [],
      maxErrors: 50,
      
      init() {
        window.onerror = (msg, url, line, col, error) => {
          this.handleError({
            type: 'sync',
            message: msg,
            source: url,
            line,
            col,
            stack: error?.stack,
            time: Date.now()
          });
          return false;
        };
        
        window.addEventListener('unhandledrejection', (event) => {
          this.handleError({
            type: 'promise',
            message: event.reason?.message || String(event.reason),
            stack: event.reason?.stack,
            time: Date.now()
          });
        });
        
        window.addEventListener('error', (event) => {
          if (event.error) {
            this.handleError({
              type: 'resource',
              message: event.message,
              source: event.filename,
              line: event.lineno,
              col: event.colno,
              time: Date.now()
            });
          }
        }, true);
      },
      
      handleError(error) {
        this.errors.push(error);
        if (this.errors.length > this.maxErrors) {
          this.errors.shift();
        }
        
        console.error('[ErrorHandler]', error);
        
        if (typeof showErrorToast === 'function') {
          showErrorToast(error.message);
        }
      },
      
      getErrors() {
        return this.errors;
      },
      
      clearErrors() {
        this.errors = [];
      }
    };
    
    ErrorHandler.init();
    
    // --- Error Toast Functions ---
    let errorToastTimer = null;
    
    function showErrorToast(message, duration = 4000) {
      const toast = document.getElementById('errorToast');
      const msgEl = toast?.querySelector('.toast-message');
      if (!toast || !msgEl) return;
      
      msgEl.textContent = message || '发生未知错误';
      toast.classList.add('show');
      
      if (errorToastTimer) clearTimeout(errorToastTimer);
      errorToastTimer = setTimeout(() => hideErrorToast(), duration);
    }
    
    function hideErrorToast() {
      const toast = document.getElementById('errorToast');
      if (toast) toast.classList.remove('show');
      if (errorToastTimer) {
        clearTimeout(errorToastTimer);
        errorToastTimer = null;
      }
    }
    
    // --- 国际化数据字典 ---
    const i18n = {
      zh: {

        nav_smart: "智能填充",
        sf_tab_basic: "基础填充",
        sf_tab_ai: "AI 生成",
        sf_tab_custom: "自定义字段",
        sf_prefix: "加为前缀",
        sf_suffix: "加为后缀",
        sf_btn_add_custom: "+ 自定义",
        sf_ai_title: "AI 对话生成",
        sf_btn_gen: "生成内容",
        sf_btn_seq: "⬇ 顺序录入",
        sf_btn_rnd: "🔀 随机录入",
        sf_btn_save_list: "💾 存为自定义列表",
        sf_sub_add_title: "添加自定义数据",
        sf_sub_cfg_title: "AI 模型配置",
        // ... 原有 Smart Fill 翻译 ...
      
      // 新增翻译 (Smart Fill Advanced)
      sf_tag_cn: "中文",
      sf_tag_en: "英文",
      sf_tag_same: "同地区",
      sf_tag_zip: "带邮编",
      sf_tag_male: "男",
      sf_tag_female: "女",
      sf_tag_comma: "千分号",
      sf_tag_year: "年",
      sf_tag_month: "月",
      sf_tag_day: "日",
      sf_tag_ltd: "有限责任",
      sf_tag_grp: "集团",
      sf_tag_noproto: "去协议头",
      sf_tag_long: "长路径",
      sf_tag_port: "含端口",
      sf_tag_prov: "省",
      sf_tag_city: "市",
      sf_tag_area: "区",
      
      sf_send_ai: "发送到 AI",
      sf_btn_save_cfg: "保存配置",
      sf_btn_save_fill: "保存并填充",
      
      sf_ph_title: "标题 (如: 部门列表)",
      sf_ph_content: "输入内容，每行一个...",
      sf_btn_save: "保存",
      
      sf_lbl_provider: "服务商",
      sf_lbl_baseurl: "API 地址 (Base URL)",
      sf_lbl_model: "模型名称 (Model)",
      sf_lbl_key: "API Key",
      sf_privacy_note: "隐私说明：本插件没有后台服务器，API Key 仅保存在本地。Figma 卸载重装后需要重新填写 Key，请放心使用。",
      
      sf_cfg_range: "数值范围 (最小值 - 最大值)",
      sf_cfg_time_range: "时间范围",
      sf_cfg_date_range: "日期范围",

      sf_cfg_time_help: "* 仅支持设置时分，秒数随机",
      sf_cfg_decimal: "小数位数 (0为整数)",
      sf_cfg_thous: "使用千分位分隔符 (1,000)",
      sf_cfg_sort: "排序方式",
      sf_sort_rand: "随机",
      sf_sort_asc: "升序",
      sf_sort_desc: "降序",
      
      sf_cfg_date_fmt: "日期格式",
      sf_cfg_time_fmt: "时间格式",
      
      sf_dialog_title: "保存列表",
      sf_mode_new: "列表标题",
      sf_mode_append: "选择目标列表",
      sf_btn_cancel: "取消",
      sf_btn_confirm: "确定",
      sf_ph_dialog_title: "请输入标题...",
      
      sf_btn_new_list: "💾 存为新列表",
      sf_btn_append_list: "➕ 追加到列表",
      sf_btn_add_new: "+ 添加新列表",
      sf_empty_custom: "暂无自定义数据\n请在“AI生成”中保存或点击下方添加",

      // --- Label 翻译 (Smart Fill Basic) ---
      sf_lbl_name: "姓名",
      sf_lbl_address: "地址",
      sf_lbl_province: "省市区",
      sf_lbl_street: "街道",
      sf_lbl_community: "小区",
      sf_lbl_number: "数字",
      sf_lbl_date: "日期",
      sf_lbl_time: "时间",
      sf_lbl_email: "Email",
      sf_lbl_idcard: "身份证",
      sf_lbl_company: "公司名称",
      sf_lbl_bank: "银行卡号",
      sf_lbl_website: "网站地址",
      sf_lbl_ip: "IP地址",
      sf_lbl_phone: "手机型号",
      sf_lbl_gender: "性别",
      sf_lbl_nickname: "网名",
      sf_lbl_news_title: "新闻标题",
      sf_lbl_lorem: "名人名言",

      // --- Tags (CN) ---
      sf_tag_cn: "中文",
      sf_tag_en: "英文",
      sf_tag_prov: "省",
      sf_tag_city: "市",
      sf_tag_area: "区",
      sf_tag_noproto: "去协议头",
      sf_tag_long: "长路径",
      sf_tag_port: "含端口",
      sf_tag_male: "男",
      sf_tag_female: "女",
        
        // =========================================
        // 1. 导航与通用 (Navigation & General)
        // =========================================
        nav_simple: "简易工具",
        nav_select: "超级选择",
        nav_layout: "布局工具",
        nav_text: "文字替换",
        nav_style_tools: "样式工具",
        nav_ppt: "导出PPT",
        nav_refiner: "组件清洗",
        nav_theory: "设计理论",
        
        btn_switch: "精简",
        btn_compact: "精简",
        btn_expand: "展开",
        btn_lang: "中/EN",
        btn_theme_dark: "主题",
        btn_theme_light: "亮色",
        btn_back: "返回配置",
        search_ph: "搜索功能...",
        empty_title: "功能开发中",
        empty_desc: "敬请期待...",

        // =========================================
        // 2. Refiner 组件清洗 (Lint & Find)
        // =========================================
        lbl_scope: "检查范围",
        scope_sel: "选中图层",
        scope_page: "当前页面",
        
        lbl_target_type: "目标类型",
        target_comp_name: "组件名",
        target_prop_name: "属性名",
        target_prop_value: "属性值",
        
        lbl_case: "目标命名风格",
        lbl_fmt: "格式",       // 新增
        lbl_sep: "分隔符",  // 新增
        lbl_casing: "大小写",  // 新增
        
        opt_fmt_sep: "分隔符模式",      // 新增
        opt_keep_orig: "保持原样",      // 新增
        lbl_opt: "清洗选项",
        opt_trim: "🔲 移除首尾空格",
        opt_emoji: "😜 保留 Emoji 表情",
        opt_id: "✳️ 移除内部 ID (#21:3)",
        opt_unmark: "清除隐藏标记 (Remove . / _)", // 新增
        lbl_replace: "查找与替换 (可选)",
        
        btn_start_check: "开始检查",
        btn_reset: "重置配置",
        btn_fix_sel: "修复选中项",
        btn_fix_all: "修复全部",
        
        res_title: "检查结果",
        empty_perfect_title: "太棒了,爱开始扩散",
        empty_perfect_desc: "未发现不规范的命名",
        
        // Refiner 新增补充 (Tab & Find)
        ref_tab_lint: "智能检查",
        ref_tab_find: "查找替换",
        
        ref_scope_sel_short: "选中图层",
        ref_scope_page_short: "当前页面",
        ref_scope_all_short: "全文件",

        opt_mark_hidden: "标记为隐藏组件 (Add .)", // 新增
        
        ref_status_ready: "就绪",
        ref_status_searching: "搜索中...",
        ref_status_done: "完成",
        ref_status_searching_prefix: "查找：",
        
        ref_chip_pname: "属性名 (Name)",
        ref_chip_pval: "属性值 (Value)",
        ref_chip_pname_title: "组件名",
        ref_chip_prop_key_title: "属性名",
        ref_chip_prop_val_title: "属性值",
        
        ref_ph_find: "查找内容...",
        ref_ph_rep: "替换为...",
        
        ref_empty_find_init: "输入关键词预览修改效果",
        btn_rep_selected: "修复选中项", // 复用于两个面板的底部按钮
        ref_empty_find_none: "未找到匹配项",
        
        ref_btn_rep: "替换",
        ref_btn_rep_all: "全部替换",
        ref_btn_find_preview: "查找并预览",
        ref_btn_replace_checked: "替换选中项",
        ref_btn_edit: "编辑",
        ref_btn_back: "返回",
        ref_btn_continue: "好的，继续",
        
        ref_msg_scan: "正在扫描...",
        ref_msg_analyze: "正在分析图层...",
        
        ref_err_no_input: "请输入查找内容",
        ref_err_no_target: "请选择至少一个搜索目标",
        ref_err_no_fix: "未选择需要修复的项",
        
        ref_success_title: "修复成功",
        ref_success_desc_1: "本次共修复",
        ref_success_desc_2: "项",
        ref_success_btn: "继续处理剩余项",

        // =========================================
        // 3. 选择工具 (Selection Tools) - 全量扩充版
        // =========================================
        sel_title_scope: "查找范围",
        sel_scope_in: "内在元素",
        sel_scope_sib: "同级",
        sel_scope_child: "子级",
        sel_scope_desc: "子孙元素",
        sel_desc_inside: "选中项内部的所有图层，不含选中项本身",
        sel_desc_sibling: "当前选中项处于同一层级的其他图层",
        sel_desc_children: "当前选中项的下一层子图层",
        sel_desc_descendants: "当前选中项及内部所有图层；若未选择图层，则查找全页",
        
        sel_title_name: "名称",
        sel_ph_name: "输入名称",
        sel_btn_exec: "查找并选择",
        sel_btn_res_prefix: "已找到",
        sel_btn_res_suffix: "项 ➔",
        sel_res_title_prefix: "已找到",
        sel_res_title_suffix: "个图层",
        sel_res_empty: "暂无找到图层",
        sel_btn_back: "返回",
        
        sel_title_type: "类型",
        logic_in: "包含",
        logic_ex: "排除",
        sel_type_all: "全部类型",
        
        // --- 类型 (Types) ---
        sel_t_frame: "# 画板 Frame",
        sel_t_group: "🃖 组 Group",
        sel_t_section: "❏ 区域 Section)",
        sel_t_auto: "⍇⍈ 自动布局",
        
        sel_t_comp: "❖ 组件",
        sel_t_compset: "💠 变体集",
        sel_t_inst: "◇ 实例",
        
        sel_t_rect: "⬛️ 矩形",
        sel_t_ell: "⭕️ 椭圆",
        sel_t_line: "| 直线",
        sel_t_vect: "✏️ 矢量",
        sel_t_star: "⭐️ 星形",
        sel_t_poly: "🛑 多边形",
        sel_t_bool: "◑ 布尔",
        
        sel_t_text: "T 文本",
        sel_t_img: "🌄 图片",
        sel_t_slice: "✂️ 切片",
        sel_t_conn: "⤚ 连接线",
        sel_t_shape_text: "💬 形状文字",
        sel_t_sticky: "📝 便签",
        sel_t_widget: "🧩 小部件",
        sel_t_stamp: "💮 图章",
        sel_t_washi: "🎞 胶带",
        
        // --- 状态 (States) ---
        sel_title_state: "状态",
        sel_state_all: "全部状态",
        
        sel_s_hidden: "👻 隐藏",
        sel_s_lock: "🔒 锁定",
        sel_s_mask: "🎭 蒙版",
        sel_s_export: "📤 可导出",
        
        sel_s_nofill: "无填充",
        sel_s_nostroke: "无描边",
        sel_s_clip: "✂️ 裁剪内容",
        sel_s_nochild: "无子集",
        
        // --- 属性 (Properties) ---
        sel_title_prop: "高级属性",
        sel_ph_val: "值",
        sel_add_prop: "添加条件",


        // =========================================
        // 4. 文字工具 (Text Tools)
        // =========================================
        txt_title_find: "查找与替换",
        txt_ph_find: "查找内容，注意区分大小写...",
        txt_ph_rep: "替换为...",
        txt_btn_exec: "执行替换",

        // =========================================
        // 5. PPT Master
        // =========================================
        ppt_tips_title: "💕 导出说明：",
        ppt_tip_1: "⚠️ 为防止破坏源文件，必须创建当前Page的副本，名称中必须包含\"副本\" 或 \"copy\"。",
        ppt_tip_2: "⚠️ 混合路径、蒙版、模糊、特殊形状、曲线、折线等复杂图层PPT无法识别，无法在PPT中编辑，请各自编组重命名为\"p_img\"。",
        ppt_tip_3: "图片仅导出占位符，请从资源包中手动替换。",
        ppt_tip_4: "经过测试，1920x1080 画板对应 PPT 16:9 画布，导出时建议勾选缩小 0.5 倍，避免 PPT 过大。",
        ppt_tip_5: "重置按钮只重置插件，复原设计稿需要使用 Ctrl+Z 。",
        
        ppt_btn_auto: "🚀 一键自动导出 PPT",
        ppt_btn_manual: "📦 没收到？点此手动下载",
        ppt_btn_reset: "🌀 重置",
        
        ppt_step1_t: "1. 全局清洗",
        ppt_step1_d: "解锁图层、移除隐藏项、解绑实例",
        
        ppt_step2_t: "2. 图标图形栅格化",
        ppt_step2_d: "将复杂矢量图形和 p_img 图层转换为 PNG 素材",
        
        ppt_step3_t: "3. 深度扁平化",
        ppt_step3_d: "消除所有分组嵌套和不可见Frame，修复遮挡",
        
        ppt_step4_t: "4. 生成 PPT 结构",
        ppt_step4_d: "提取布局信息，生成 .pptx 文件",
        ppt_step4_scale: "缩放至 960x540，建议勾选",
        
        ppt_step5_t: "5. 导出资源包",
        ppt_step5_d: "打包生成 PPT 和图片资源 (.zip)",
        
        ppt_step6_t: "全部完成",
        ppt_step6_d: "文件已生成完成，请下载",
        
        ppt_stat_wait: "等待执行",
        ppt_stat_done: "✅ 执行成功",
        ppt_btn_next: "下一步 →",
        ppt_btn_done: "已完成",
        ppt_btn_run: "分步执行 STEP ",

        // --- 文字查找替换 (Text Tool) ---
        txt_expand: "点击展开查找配置", // 折叠时的默认提示
        txt_prefix_find: "查找",       // 用于组合 "查找: xxx"
        
        txt_reset: "重置",            // 顶部小按钮
        txt_restore: "还原",          // 顶部小按钮 (还原高亮)
        
        txt_scope_sel: "仅选中图层",   // 范围选择
        txt_scope_page: "当前整个页面", // 范围选择
        
        txt_ph_find: "请输入查找关键词", // 查找输入框
        txt_ph_rep: "替换为...",       // 替换输入框
        
        txt_btn_find: "开始查找",      // 大按钮
        txt_btn_finding: "搜索中...",  // 大按钮 Loading 态
        
        txt_label_all: "全选 / 共",    // 列表头部
        txt_label_item: "项",         // 列表头部单位
        
        txt_empty_intro: "输入关键词，精准定位并替换", // 空状态
        txt_empty_none: "未找到匹配内容",            // 无结果状态
        
        txt_btn_rep_batch: "替换选中项", // 底部大按钮
        txt_btn_rep_single: "替换",      // 列表行内小按钮
        
        txt_tip_locate: "点击定位并标红",  // 列表行 Tooltip
        txt_title_config: "查找配置", // <--- 新增
        txt_err_no_input: "请输入查找内容", // <--- 新增

        // =========================================
        // 6. 工具卡片详情 (Tool Cards)
        // 格式: [标题, 简介, 详细Tooltip, 成功提示]
        // =========================================
        
        // --- 形状转换 ---
        to_frame: ["🖼️ 矩转框", "保留外观转换为Frame", "将选中的矩形转换为Frame，保留原有的填充、描边、圆角等样式。", "已转换为 Frame"],
        to_rect: ["🧱 框转矩", "Frame扁平化为矩形", "将选中的Frame或Group降维成普通矩形，保留视觉样式但移除容器属性。", "已转换为矩形"],
        
        // --- 文本处理 ---
        split_text: ["✂️ 段落行拆分", "按换行符拆分文本", "将多行文本段落按换行符拆分为独立的文本层，保持原有间距。", "文本已拆分"],
        join_text: ["🔗 文本拼合", "多行文本合并为一个", "将选中的多个文本图层按视觉位置排序，合并为一个多行文本框。", "文本已拼合"],
        
        // --- 自动布局 ---
        remove_al: ["⛔️ 清除自动布局属性", "移除Auto Layout", "移除选中图层及其内部所有子层级的 Auto Layout 属性，恢复为普通 Frame。", "已移除自动布局"],
        add_al_wrapper: ["🍱 外加自动布局Frame", "添加自动布局包裹", "给选中图层分别添加一层自动布局Frame外套。", "已添加自动布局外套"],
        
        // --- 层级穿梭 ---
        up_one: ["📤 逃逸一层", "图层向上提一级", "将选中图层从当前父级中移出，放入上一级容器中。", "图层已上移"],
        up_all: ["🚀 完全逃逸", "图层提至最外层", "将选中图层直接移动到页面的最顶层（Root）。", "已提至最外层"],
        
        // --- 编组与锁定 ---
        ungroup_all: ["💥 解除所有Group", "解散内部所有组", "递归查找并解散选中元素内部所有的 Group，只保留 Frame 结构。", "已解散内部组"],
        unlock_all: ["🔓 解锁内部图层", "递归解锁所有子级", "一键解锁选中元素内部所有被锁定的图层，方便批量编辑。", "已全部解锁"],
        
        // --- 属性调整 ---
        swap_fs: ["🔄 交换填充描边", "互换填充与描边色", "将选中图层的填充颜色与描边颜色互换。", "已交换填充描边"],
        reset_image: ["⚖️ 重置图片比例", "恢复原始宽高比", "修复被拉伸变形的图片，恢复其原始的长宽比例。", "已重置图片比例"],
        
        // --- 排序与命名 ---
        sort_layers: ["👁️ 按视觉排序图层", "按坐标重排图层", "根据画布上的 X/Y 坐标，重新排列图层列表顺序（从上到下，从左到右）。再点一次可反向排列", "图层已排序"],
        rename_content: ["🏷️ 按内容重命名", "图层名同步文本内容", "自动将文本层或包含文本的 Frame 重命名为其内容。", "图层已重命名"],
        
        // --- 实例与清理 ---
        detach_all: ["💔 解绑所有实例", "递归解绑组件实例", "解绑选中图层下所有嵌套的组件实例（Instance）。", "已解绑所有实例"],
        remove_hidden: ["👻 删除隐藏图层", "清理不可见图层", "递归删除所选范围内所有'闭眼'的隐藏图层。", "已删除隐藏图层"],
        
        // --- 位置与对齐 ---
        pixel_perfect: ["🎯 像素取整", "坐标尺寸取整", "将选中图层的 X、Y 坐标及宽高强制四舍五入为整数，消除小数杂边。", "已像素对齐"],
        swap_positions: ["🔀 交换位置", "互换图层坐标", "交换选中的两个图层的 X/Y 坐标，保持图层层级不变。", "位置已交换"],
        
        // --- 样式管理 ---
        create_styles: ["✨ 生成本地样式", "一键提取样式", "将选中图层的颜色、文本、效果转为本地样式。自动检测重名。", "检查样式完成"],
        match_styles: ["💅 匹配本地样式", "重新链接样式库", "扫描选中图层，将裸奔的颜色/字体属性与本地样式库重新绑定。", "已完成样式匹配"]
      },
      en: {
        nav_smart: "Smart Fill",
        sf_tab_basic: "Basic",
        sf_tab_ai: "AI Gen",
        sf_tab_custom: "Custom Fields",
        sf_prefix: "Prefix",
        sf_suffix: "Suffix",
        sf_btn_add_custom: "+ Custom",
        sf_ai_title: "AI Generation",
        sf_btn_gen: "Generate",
        sf_btn_seq: "⬇ Sequential",
        sf_btn_rnd: "🔀 Random",
        sf_btn_save_list: "💾 Save as List",
        sf_sub_add_title: "Add Custom Data",
        sf_sub_cfg_title: "AI Config",
        // ... Existing Smart Fill translations ...
      
      // New Translations (Smart Fill Advanced)
      sf_tag_cn: "CN",
      sf_tag_en: "EN",
      sf_tag_same: "Same Region",
      sf_tag_zip: "Zip Code",
      sf_tag_male: "Male",
      sf_tag_female: "Female",
      sf_tag_comma: "Comma",
      sf_tag_year: "Year",
      sf_tag_month: "Month",
      sf_tag_day: "Day",
      sf_tag_ltd: "Ltd.",
      sf_tag_grp: "Group",
      sf_tag_noproto: "No Protocol",
      sf_tag_long: "Long Path",
      sf_tag_port: "Port",
      sf_tag_prov: "Prov",
      sf_tag_city: "City",
      sf_tag_area: "Dist",
      
      sf_send_ai: "Send to AI",
      sf_btn_save_cfg: "Save Config",
      sf_btn_save_fill: "Save & Fill",
      
      sf_ph_title: "Title (e.g. Departments)",
      sf_ph_content: "Enter content, one per line...",
      sf_btn_save: "Save",
      
      sf_lbl_provider: "Provider",
      sf_lbl_baseurl: "API Address (Base URL)",
      sf_lbl_model: "Model Name",
      sf_lbl_key: "API Key",
      sf_privacy_note: "Privacy Note: This plugin has no backend server. API Keys are stored locally only. You'll need to re-enter the key after reinstalling Figma. Feel free to use with confidence.",
      
      sf_cfg_range: "Range (Min - Max)",
      sf_cfg_time_range: "Time Range",
      sf_cfg_date_range: "Date Range",

      sf_cfg_time_help: "Format: HH:mm:ss",
      sf_cfg_decimal: "Decimals (0 for Integer)",
      sf_cfg_thous: "Thousands Separator (1,000)",
      sf_cfg_sort: "Sort Order",
      sf_sort_rand: "Random",
      sf_sort_asc: "Ascending",
      sf_sort_desc: "Descending",
      
      sf_cfg_date_fmt: "Date Format",
      sf_cfg_time_fmt: "Time Format",
      
      sf_dialog_title: "Save List",
      sf_mode_new: "List Title",
      sf_mode_append: "Select Target List",
      sf_btn_cancel: "Cancel",
      sf_btn_confirm: "Confirm",
      sf_ph_dialog_title: "Enter title...",
      
      sf_btn_new_list: "💾 New List",
      sf_btn_append_list: "➕ Append",
      sf_btn_add_new: "+ Add New List",
      sf_empty_custom: "No custom data\nSave from AI or click Add below",

      // --- Label Translations (Smart Fill Basic) ---
      sf_lbl_name: "Name",
      sf_lbl_address: "Address",
      sf_lbl_province: "Prov/City/Dist",
      sf_lbl_street: "Street",
      sf_lbl_community: "Community",
      sf_lbl_number: "Number",
      sf_lbl_date: "Date",
      sf_lbl_time: "Time",
      sf_lbl_email: "Email",
      sf_lbl_idcard: "ID Card",
      sf_lbl_company: "Company",
      sf_lbl_bank: "Bank Card",
      sf_lbl_website: "Website",
      sf_lbl_ip: "IP Address",
      sf_lbl_phone: "Phone Model",
      sf_lbl_gender: "Gender",
      sf_lbl_nickname: "Nickname",
      sf_lbl_news_title: "News Title",
      sf_lbl_lorem: "Quotes",

      // --- Tags (EN) ---
      sf_tag_cn: "CN",
      sf_tag_en: "EN",
      sf_tag_prov: "Prov",
      sf_tag_city: "City",
      sf_tag_area: "Dist",
      sf_tag_noproto: "No Protocol",
      sf_tag_long: "Long Path",
      sf_tag_port: "Port",
      sf_tag_male: "Male",
      sf_tag_female: "Female",
        
        // =========================================
        // 1. Navigation & General
        // =========================================
        nav_simple: "Simple",
        nav_select: "Super Select",
        nav_layout: "Layout",
        nav_text: "Text Replace",
        nav_style_tools: "Style",
        nav_ppt: "Ex-PPT",
        nav_refiner: "Comp...Refiner",
        nav_theory: "Design Theory", 
        
        btn_switch: "Compact",
        btn_compact: "Compact",
        btn_expand: "Expand",
        btn_lang: "中/EN",
        btn_theme_dark: "Theme",
        btn_theme_light: "Light",
        btn_back: "Back to Config",
        search_ph: "Search...",
        empty_title: "Coming Soon",
        empty_desc: "Under development...",
      
        // =========================================
        // 2. Refiner (Lint & Find)
        // =========================================
        lbl_scope: "Scope",
        scope_sel: "Selection",
        scope_page: "Current Page",
        
        lbl_target_type: "Target Types",
        target_comp_name: "Comp Name",
        target_prop_name: "Prop Name",
        target_prop_value: "Prop Value",
        
        lbl_case: "Naming Case",
        lbl_fmt: "Format",
        lbl_sep: "Separator",
        lbl_casing: "Casing",

        opt_fmt_sep: "Delimiter",      // 新增
        opt_keep_orig: "Remain intact",      // 新增
        lbl_opt: "Options",
        opt_trim: "🔲 Trim Whitespace",
        opt_emoji: "😜 Keep Emojis",
        opt_id: "✳️ Remove ID (#123)",
        lbl_replace: "Find & Replace (Optional)",
        opt_unmark: "Unmark Hidden Mark (Remove . / _)",
        
        btn_start_check: "Start Check",
        btn_reset: "Reset Config",
        btn_fix_sel: "Fix Selected",
        btn_fix_all: "Fix All",
        
        res_title: "Results",
        empty_perfect_title: "Perfect, Love begins to permeate!",
        empty_perfect_desc: "No issues found",
        
        // Refiner Supplement
        ref_tab_lint: "Lint",
        ref_tab_find: "Find & Replace",
        
        ref_scope_sel_short: "Selection",
        ref_scope_page_short: "Current Page",
        ref_scope_all_short: "All Pages",

        opt_mark_hidden: "Mark as Hidden (Add .)",
        
        ref_status_ready: "Ready",
        ref_status_searching: "Searching...",
        ref_status_done: "Done",
        ref_status_searching_prefix: "Search:",
        
        ref_chip_pname: "Prop Name",
        ref_chip_pval: "Prop Value",
        ref_chip_pname_title: "Comp Name",
        ref_chip_prop_key_title: "Prop Name",
        ref_chip_prop_val_title: "Prop Value",
        
        ref_ph_find: "Find text...",
        ref_ph_rep: "Replace with...",
        
        ref_empty_find_init: "Enter text to preview changes",
        btn_rep_selected: "Replace Selected",
        ref_empty_find_none: "No matches found",
        
        ref_btn_rep: "Replace",
        ref_btn_rep_all: "Replace All",
        ref_btn_find_preview: "Find & Preview",
        ref_btn_replace_checked: "Replace Selected",
        ref_btn_edit: "Edit",
        ref_btn_back: "Back",
        ref_btn_continue: "OK, Continue",
        
        ref_msg_scan: "Scanning...",
        ref_msg_analyze: "Analyzing layers...",
        
        ref_err_no_input: "Please enter text to find",
        ref_err_no_target: "Select at least one target",
        ref_err_no_fix: "No items selected",
        
        ref_success_title: "Success",
        ref_success_desc_1: "Fixed",
        ref_success_desc_2: "items",
        ref_success_btn: "Continue",
        
        // =========================================
        // 3. Selection Tools (English) - Fully Extended
        // =========================================
        sel_title_scope: "Search Scope",
        sel_scope_in: "Inside",
        sel_scope_sib: "Siblings",
        sel_scope_child: "Children",
        sel_scope_desc: "Descendants",
        sel_desc_inside: "Search all layers inside the selection (excluding the selected layers themselves)",
        sel_desc_sibling: "Search other layers at the same parent level as the current selection",
        sel_desc_children: "Search only the immediate direct children of the selection",
        sel_desc_descendants: "Search current selection and all its descendants; searches entire page if nothing selected",
        
        sel_title_name: "Name",
        sel_ph_name: "Input Name",
        sel_btn_exec: "Find & Select",
        sel_btn_res_prefix: "Found",
        sel_btn_res_suffix: "Items ➔",
        sel_res_title_prefix: "Found",
        sel_res_title_suffix: "Layers",
        sel_res_empty: "No layers found",
        sel_btn_back: "Back",
        
        sel_title_type: "Type",
        logic_in: "Include",
        logic_ex: "Exclude",
        sel_type_all: "All Types",
        
        // --- Types ---
        sel_t_frame: "# Frame",
        sel_t_group: "🃖 Group",
        sel_t_section: "❏ Section",
        sel_t_auto: "⍇⍈ AutoLayout",
        
        sel_t_comp: "❖ Component",
        sel_t_compset: "💠 ComponSet",
        sel_t_inst: "◇ Instance",
        
        sel_t_rect: "⬛️ Rectangle",
        sel_t_ell: "⭕️ Ellipse",
        sel_t_line: "| Line",
        sel_t_vect: "✏️ Vector",
        sel_t_star: "⭐️ Star",
        sel_t_poly: "🛑 Polygon",
        sel_t_bool: "◑ Boolean",
        
        sel_t_text: "T Text",
        sel_t_img: "🌄 Image",
        sel_t_slice: "✂️ Slice",
        sel_t_conn: "⤚ Connector",
        sel_t_shape_text: "💬 Shape with Text",
        sel_t_sticky: "📝 Sticky",
        sel_t_widget: "🧩 Widget",
        sel_t_stamp: "💮 Stamp",
        sel_t_washi: "🎞 Washi Tape",
        
        // --- States ---
        sel_title_state: "State",
        sel_state_all: "All States",
        
        sel_s_hidden: "👻 Hide",
        sel_s_lock: "🔒 Locked",
        sel_s_mask: "🎭 Mask",
        sel_s_export: "📤 Export",
        
        sel_s_nofill: "No Fill",
        sel_s_nostroke: "No Stroke",
        sel_s_clip: "✂️ Clip",
        sel_s_nochild: "No Child",
        
        // --- Properties ---
        sel_title_prop: "Advanced Props",
        sel_ph_val: "Value",
        sel_add_prop: "Add Condition",


        // =========================================
        // 4. Text Tools
        // =========================================
        txt_title_find: "Find & Replace",
        txt_ph_find: "Find text (case sensitive)...",
        txt_ph_rep: "Replace with...",
        txt_btn_exec: "Replace All",

        // =========================================
        // 5. PPT Master
        // =========================================
        ppt_tips_title: "💕 Export Guide:",
        ppt_tip_1: "⚠️ To avoid damaging the source file, duplicate the current Page. Name must include \"copy\" or \"副本\".",
        ppt_tip_2: "⚠️ Complex layers (mixed paths, masks, blur, special shapes, curves, etc.) cannot be edited in PPT. Group and rename them to \"p_img\" to rasterize.",
        ppt_tip_3: "Images are exported as placeholders. Please replace them manually using the asset pack.",
        ppt_tip_4: "1920x1080 artboards map to 16:9 PPT slides. Scaling down to 0.5x is recommended to keep file size optimized.",
        ppt_tip_5: "Reset button only restarts the plugin. Use Ctrl+Z to restore design changes.",
        
        ppt_btn_auto: "🚀 One-click Auto Export PPT",
        ppt_btn_manual: "📦 Didn't receive it? Download manually",
        ppt_btn_reset: "🌀 Reset",
        
        ppt_step1_t: "1. Global Cleanup",
        ppt_step1_d: "Unlock layers, remove hidden items, and detach instances",
        
        ppt_step2_t: "2. Rasterize Graphics",
        ppt_step2_d: "Convert complex vector shapes and p_img layers into PNG assets",
        
        ppt_step3_t: "3. Deep Flattening",
        ppt_step3_d: "Remove nested groups and invisible frames; fix layer overlap",
        
        ppt_step4_t: "4. Generate PPT Structure",
        ppt_step4_d: "Extract layout info and generate .pptx file",
        ppt_step4_scale: "Scale to 960x540 (Recommended)",
        
        ppt_step5_t: "5. Export Asset Pack",
        ppt_step5_d: "Package PPT and image resources into a .zip file",
        
        ppt_step6_t: "Task Completed",
        ppt_step6_d: "File generated successfully. Please download.",
        
        ppt_stat_wait: "Waiting",
        ppt_stat_done: "✅ Success",
        ppt_btn_next: "Next →",
        ppt_btn_done: "Completed",
        ppt_btn_run: "RUN STEP ",

        // --- Text Find & Replace ---
        txt_expand: "Expand Search Config",
        txt_prefix_find: "Find",
        
        txt_reset: "Reset",
        txt_restore: "Restore",
        
        txt_scope_sel: "Selection Only",
        txt_scope_page: "Current Page",
        
        txt_ph_find: "Enter text to find...",
        txt_ph_rep: "Replace with...",
        
        txt_btn_find: "Start Find",
        txt_btn_finding: "Searching...",
        
        txt_label_all: "Select All / Total",
        txt_label_item: "items",
        
        txt_empty_intro: "Enter keywords to locate & replace",
        txt_empty_none: "No matches found",
        
        txt_btn_rep_batch: "Replace Selected",
        txt_btn_rep_single: "Replace",
        
        txt_tip_locate: "Click to locate & highlight",
        txt_title_config: "Search Config", // <--- 新增
        txt_err_no_input: "Please enter text to find", // <--- 新增

        // =========================================
        // 6. Tool Cards (English)
        // Format: [Title, Short Desc, Tooltip, Success Msg]
        // =========================================
        
        to_frame: ["🖼️ Rect to Frame", "Convert to Frame", "Convert selected rectangles into Frames while preserving fills, strokes, and corners.", "Converted to Frame"],
        to_rect: ["🧱 Frame to Rect", "Flatten to Rectangle", "Convert Frames/Groups into simple Rectangles, preserving visual styles but removing container properties.", "Converted to Rect"],
        
        split_text: ["✂️ Split Text", "Split by Line", "Split multi-line text into separate text layers per line, maintaining visual spacing.", "Text Split"],
        join_text: ["🔗 Join Text", "Merge Text Layers", "Merge selected text layers into a single multi-line text box, sorted by visual position.", "Text Joined"],
        
        remove_al: ["⛔️ Remove AL", "Remove Auto Layout", "Recursively remove Auto Layout from selected layers and all nested children.", "Auto Layout Removed"],
        add_al_wrapper: ["🍱 Add AL Wrapper", "Add AL Wrapper", "Wrap selected layers individually in a new Auto Layout Frame.", "Auto Layout Wrapped"],
        
        up_one: ["📤 Up One Level", "Lift Layer Up", "Move selected layers out of their current parent into the grandparent container.", "Layer Moved Up"],
        up_all: ["🚀 Up All Level", "Lift to Root", "Move selected layers directly to the Page root level.", "Moved to Top"],
        
        ungroup_all: ["💥 Ungroup All", "Ungroup Nested", "Recursively find and ungroup all Groups within selection, keeping Frames intact.", "Groups Ungrouped"],
        unlock_all: ["🔓 Unlock All", "Unlock Nested", "Recursively unlock all locked layers within the selection.", "All Unlocked"],
        
        swap_fs: ["🔄 Swap Fill/Stroke", "Swap Colors", "Swap the fill color and stroke color of selected layers.", "Swapped"],
        reset_image: ["⚖️ Reset Image Ratio", "Fix Aspect Ratio", "Restore the original aspect ratio of distorted images.", "Ratio Reset"],
        
        sort_layers: ["👁️ Sort by Visual", "Sort by Position", "Reorder layer list based on visual X/Y position (Top-Left to Bottom-Right).", "Layers Sorted"],
        rename_content: ["🏷️ Rename by Content", "Sync Name to Text", "Rename layers based on their text content for better organization.", "Renamed"],
        
        detach_all: ["💔 Detach Instances", "Detach Nested", "Recursively detach all nested Component Instances within selection.", "Detached"],
        remove_hidden: ["👻 Remove Hidden", "Clean Invisible", "Recursively delete all layers that are toggled off (invisible).", "Removed Hidden"],
        
        pixel_perfect: ["🎯 Pixel Perfect", "Round Coordinates", "Round X, Y, Width, and Height to the nearest integers to fix sub-pixel rendering.", "Pixel Perfected"],
        swap_positions: ["🔀 Swap Positions", "Swap Locations", "Swap X/Y coordinates of exactly two selected layers.", "Swapped"],
        
        create_styles: ["✨ Create Styles", "Generate Styles", "Convert properties to local styles based on layer name. Detects conflicts.", "Styles Created"],
        match_styles: ["💅 Match Styles", "Relink Styles", "Scan selection and bind raw properties to local styles if values match exactly.", "Styles Matched"]
      }
    };
    
    let curLang = PersistentCache.get('user_lang') || 'zh';

    updateLanguage();
    
  
    // =============================================================================
    // 2. 核心通信与工具函数 (Core & Utils)
    // =============================================================================

    function postMsg(type, data = {}) {
        parent.postMessage({ pluginMessage: { type, ...data } }, '*');
    }

    function toggleLang() {
      curLang = curLang === 'zh' ? 'en' : 'zh';
      PersistentCache.set('user_lang', curLang);
      updateLanguage();
      if(typeof renderBasicList === 'function') renderBasicList();
      if(typeof renderCustomList === 'function') renderCustomList();
    }

    function updateLanguage() {
      const t = i18n[curLang];
      if (!t) return;

      // 1. 通用更新：处理新加的 Refiner 界面及普通文本
      // 筛选策略：找到有 data-key 属性，但【不是】导航项、【不是】卡片的元素
      document.querySelectorAll('[data-key]:not(.nav-item):not(.card)').forEach(el => {
        const k = el.getAttribute('data-key');
        if (t[k]) {
          // 如果是输入框，更新 placeholder
          if (el.tagName === 'INPUT' && (el.type === 'text' || !el.type)) {
            el.placeholder = t[k];
          } 
          // 普通文本元素 (Label, Span, Button, etc.)
          else {
            el.innerText = t[k];
          }
        }
      });

      // 2. 特殊处理：导航项 (Nav Item) - 必须保留 SVG 图标
      document.querySelectorAll('.nav-item').forEach(el => {
        const k = el.getAttribute('data-key');
        // 只更新内部的 .nav-text，绝对不要动 el.innerText
        const txtSpan = el.querySelector('.nav-text');
        if(k && t[k] && txtSpan) {
          txtSpan.innerText = t[k];
        }
      });

      // 3. 特殊处理：工具卡片 (Card) - 必须处理数组数据
      document.querySelectorAll('.card').forEach(el => {
        const k = el.getAttribute('data-key');
        // 检查 t[k] 是否存在且为数组 [标题, 简介, ...]
        if(k && t[k] && Array.isArray(t[k])) {
          const titleEl = el.querySelector('.card-title');
          const descEl = el.querySelector('.card-desc');
          
          // 更新标题 (保留可能存在的图标，通常文本是第一个子节点)
          if (titleEl && titleEl.childNodes.length > 0) {
            // 只要替换文本节点，避免重写 HTML
            titleEl.childNodes[0].textContent = t[k][0] + " "; 
          }
          // 更新简介
          if (descEl) descEl.innerText = t[k][1];
        }
      });

      // 4. 特殊处理：那些可能没有 data-key 的遗留 ID
      // 如果你的 HTML 里这些元素已经加了 data-key，这部分其实可以删掉，但保留着最保险
      const modeBtn = document.getElementById('modeBtn');
      if(modeBtn && t.btn_switch) modeBtn.innerText = t.btn_switch;
      
      const searchInput = document.getElementById('searchInput');
      if(searchInput && t.search_ph) searchInput.placeholder = t.search_ph;
    }

    // 通用工具卡片点击事件
    function run(type) {
      // 发送消息时带上当前语言的提示文案，以便 code.ts 直接使用
      const t = i18n[curLang];
      // 找到对应 key
      const card = document.querySelector(`.card[onclick*="${type}"]`);
      const key = card ? card.getAttribute('data-key') : null;
      const msg = (key && t[key]) ? t[key][3] : "Done";
      // 发送消息
      postMsg(type,{successMsg:msg});
    }

    // 运行替换功能
    function runReplace() {
      const findText = document.getElementById('findInput').value;
      const repText = document.getElementById('repInput').value;
      if (!findText) return;
      
      parent.postMessage({ 
        pluginMessage: { 
          type: 'find-replace', 
          findText: findText, 
          replaceText: repText 
        } 
      }, '*');
    }

    // 切换功能组
    function switchGroup(group, el) {
      document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
      el.classList.add('active');
      
      const ids = [
        'toolPanel', 
        'stylePanel', 
        'selectionPanel', 
        'selectionFooter', 
        'emptyPanel', 
        'layoutPanel', 
        'textPanel', 
        'pptPanel', 
        'refinerPanel',
        'theoryPanel',
        'smartFillPanel'
      ];
      const map = {
        'simple': ['toolPanel'],
        'style':  ['stylePanel'],
        'select': ['selectionPanel', 'selectionFooter'],
        'layout': ['layoutPanel'],
        'text':   ['textPanel'],
        'ppt':    ['pptPanel'],
        'smartFill': ['smartFillPanel'],
        'refiner': ['refinerPanel'],
        'theory':  ['theoryPanel']
      };
      
      // 1. 隐藏所有
      ids.forEach(id => {
        const div = document.getElementById(id);
        if(div) div.style.display = 'none';
      });
      
      // 关闭所有子页面，防止穿透
      document.querySelectorAll('.sub-page').forEach(page => {
        page.classList.remove('open');
      });
      
      const searchBox = document.getElementById('searchInput');
      const mainHeader = document.getElementById('mainHeader');
      
      // 2. 显示目标
      if (map[group]) {
        map[group].forEach(id => {
          const div = document.getElementById(id);
          if(div){
            if(id === 'refinerPanel' || id === 'theoryPanel' || id === 'smartFillPanel' || id === 'textPanel') { 
              div.style.display = 'flex';
            } else {
              div.style.display = (id === 'toolPanel' || id === 'stylePanel' || id === 'layoutPanel') ? 'grid' : 'flex';
            }
          }
        });
        
        // 头部搜索框仅在 Grid 类型的面板显示，选择和文字工具不需要
        // 允许 Theory 面板使用搜索框
        if (group === 'simple' || group === 'style' || group === 'layout' || group === 'theory') {
          searchBox.disabled = false;
          mainHeader.style.display = 'block';
          searchBox.value = ''; // 切换时清空搜索
          // 如果是切到理论，初始化列表
          if (group === 'theory') {
             renderTheoryList('all'); // 默认显示全部
             searchBox.placeholder = "搜索设计理论 (如: 尼尔森)...";
          } else {
             searchBox.placeholder = i18n[curLang].search_ph || "搜索功能...";
          }
        } else {
          searchBox.disabled = true;
          mainHeader.style.display = 'none';
        }
      }
    }

    // 切换迷你模式
    function toggleMode() {
      document.body.classList.toggle('mini-mode');
      const isMini = document.body.classList.contains('mini-mode');
      const btn = document.getElementById('modeBtn');
      const t = i18n[curLang];
      if(btn) btn.innerText = isMini ? (t.btn_expand || "展开") : (t.btn_compact || "精简");
    }

    // 切换主题 (明暗模式)
    function toggleTheme() {
      const html = document.documentElement;
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      
      html.setAttribute('data-theme', newTheme);
      PersistentCache.set('user_theme', newTheme);
      
      const lightIcon = document.getElementById('themeIconLight');
      const darkIcon = document.getElementById('themeIconDark');
      const themeText = document.getElementById('themeText');
      const t = i18n[curLang];
      
      if (newTheme === 'dark') {
        lightIcon.style.display = 'none';
        darkIcon.style.display = 'block';
        themeText.textContent = t.btn_theme_light || "亮色";
      } else {
        lightIcon.style.display = 'block';
        darkIcon.style.display = 'none';
        themeText.textContent = t.btn_theme_dark || "主题";
      }
    }

    function initTheme() {
      const savedTheme = PersistentCache.get('user_theme') || 'light';
      
      if (savedTheme === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
        const lightIcon = document.getElementById('themeIconLight');
        const darkIcon = document.getElementById('themeIconDark');
        const themeText = document.getElementById('themeText');
        if (lightIcon) lightIcon.style.display = 'none';
        if (darkIcon) darkIcon.style.display = 'block';
        if (themeText) themeText.textContent = '亮色';
      }
    }
    
    initTheme();

    // 搜索功能
    document.getElementById('searchInput').addEventListener('input', (e) => {
      const val = e.target.value.toLowerCase();
      const cards = document.querySelectorAll('.card');
      if(document.getElementById('toolPanel').style.display !== 'none'){
        cards.forEach(card => {
          // 搜索匹配中英文标题
          const key = card.getAttribute('data-key');
          const zhTitle = i18n.zh[key][0].toLowerCase();
          const enTitle = i18n.en[key][0].toLowerCase();
          const visible = zhTitle.includes(val) || enTitle.includes(val);
          card.style.display = visible ? 'flex' : 'none';
        });
      }
    });

    // 工具卡片悬停显示详细描述
    // --- Tooltip 悬停逻辑 ---
    const tooltip = document.getElementById('tooltip-box');
    const cards = document.querySelectorAll('.card');

    // 为每个卡片添加悬停事件
    cards.forEach(card => {
      card.addEventListener('mouseenter', (e) => {
        // 迷你模式不显示
        if(document.body.classList.contains('mini-mode')) return;

        const key = card.getAttribute('data-key');
        if(!key) return;
        
        // 获取数据配置
        const data = i18n[curLang][key];
        
        if (data) {
            const title = data[0]; // 数组第0项是标题 (如"逃逸一层")
            const desc = data[2];  // 数组第2项是详细描述
            
            // --- 核心修改：使用 innerHTML 插入结构化内容 ---
            tooltip.innerHTML = `
                <div class="tt-title">${title}</div>
                <div class="tt-desc">${desc}</div>
            `;
            
            tooltip.style.display = 'block';
            moveTooltip(e);
        }
      });

      card.addEventListener('mousemove', (e) => {
        if(document.body.classList.contains('mini-mode')) return;
        moveTooltip(e);
      });

      card.addEventListener('mouseleave', () => {
        tooltip.style.display = 'none';
      });
    });

    // 移动 Tooltip 到鼠标位置
    function moveTooltip(e) {
      // 简单的跟随鼠标，稍微偏移
      const x = e.clientX + 15; 
      const y = e.clientY + 15;
      
      // 防止溢出边界处理
      const rect = tooltip.getBoundingClientRect();
      const winW = window.innerWidth;
      const winH = window.innerHeight;

      let finalX = x;
      let finalY = y;

      if (x + rect.width > winW) finalX = e.clientX - rect.width - 10;
      if (y + rect.height > winH) finalY = e.clientY - rect.height - 10;

      tooltip.style.left = finalX + 'px';
      tooltip.style.top = finalY + 'px';
    }

    // 单选切换逻辑 (互斥)
    function toggleSingle(el, parentId) {
        // 1. 找到父容器
        const parent = document.getElementById(parentId);
        if (!parent) return;

        // 2. 移除该容器下所有按钮的 active 类
        // 注意：这里使用 .scope-btn 选择器，确保选中所有按钮
        const btns = parent.querySelectorAll('.scope-btn, .filter-btn'); 
        btns.forEach(btn => btn.classList.remove('active'));

        // 3. 给当前点击的按钮添加 active 类
        el.classList.add('active');

        // 🔥 新增：自动更新范围描述 (仅针对 scopeGroup)
        if (parentId === 'scopeGroup') {
            const val = el.getAttribute('data-val');
            const descEl = document.getElementById('scopeDescText');
            if (descEl) {
                const descKey = `sel_desc_${val}`;
                descEl.setAttribute('data-key', descKey);
                // 立即应用当前语言的文字 (依赖 i18n 和 curLang)
                if (typeof i18n !== 'undefined' && typeof curLang !== 'undefined') {
                    descEl.innerText = i18n[curLang][descKey] || "";
                }
            }
        }
    }
    
    // 多选切换逻辑 (类型/状态)
    function toggleMulti(el) { 
      // 1. 切换当前按钮的激活状态
      el.classList.toggle('active'); 
      
      // 2. 找到父容器
      const parent = el.parentElement;
      if (parent) {
          // 🔥 关键修复：查找 .all-tag (新类名) 而不是 .all-btn
          const allBtn = parent.querySelector('.all-tag');
          if (allBtn) {
              // 只要有一个具体标签被选中，"全部"按钮就取消激活
              allBtn.classList.remove('active');
              
              // 如果所有具体标签都取消了，自动激活"全部"按钮 (可选优化)
              const hasActive = parent.querySelector('.filter-tag.active:not(.all-tag)');
              if (!hasActive) {
                  allBtn.classList.add('active');
              }
          }
      }
    }
    
    // 清除选中逻辑 (点击"全部类型"时)
    function clearGroup(gid, el) { 
      // 1. 找到该组下所有普通标签，移除 active
      document.querySelectorAll(`#${gid} .filter-tag:not(.all-tag)`).forEach(b => b.classList.remove('active')); 
      
      // 2. 激活"全部"按钮自己
      el.classList.add('active'); 
    }
    
    function toggleLogic(el) {
      el.classList.toggle('include'); 
      el.classList.toggle('exclude');
    }

    // 添加属性行 (样式更新版)
    function addPropRow() {
      const div = document.createElement('div'); 
      div.className = 'prop-item'; // 改用新的类名
      div.innerHTML = `
        <select class="prop-select p-key">
          <optgroup label="图层 Layer">
            <option value="name">图层名称 (Name)</option>
            <option value="opacity">图层透明度 (Opacity)</option>
            <option value="visible">可见性 (Visible)</option>
            <option value="rotation">旋转 (Rotation)</option>
          </optgroup>
          <optgroup label="位置与尺寸 Bounds">
            <option value="width">宽度 (Width)</option>
            <option value="height">高度 (Height)</option>
            <option value="x">X 坐标</option>
            <option value="y">Y 坐标</option>
          </optgroup>
          <optgroup label="填充 Fills">
            <option value="fillCount">填充数量</option>
            <option value="fillOpacity">填充透明度</option>
          </optgroup>
          <optgroup label="文本 Text">
            <option value="characters">文本内容</option>
            <option value="fontSize">字号</option>
          </optgroup>
          <optgroup label="自动布局 AutoLayout">
            <option value="itemSpacing">子元素间距</option>
            <option value="paddingLeft">左边距</option>
          </optgroup>
        </select>
        
        <select class="prop-op">
            <option value="=">=</option>
            <option value=">">></option>
            <option value="<"><</option>
            <option value="!=">≠</option>
            <option value="has">含</option>
        </select>
        
        <input type="text" class="prop-val-input p-val" placeholder="值">
        
        <div class="prop-del-btn" onclick="this.parentElement.remove()">×</div>
      `;
      document.getElementById('propList').appendChild(div);
    }
    
    // 默认添加一行属性
    // addPropRow();

    // [核心修复] 运行筛选 (适配新版 UI 结构)
    function runFilter() {
      // 1. 获取范围 (Scope)
      // 适配新类名 .scope-btn
      const scopeEl = document.querySelector('#scopeGroup .scope-btn.active');
      const scope = scopeEl ? scopeEl.getAttribute('data-val') : 'inside';

      // 2. 获取名称 (Name) & 大小写设置
      const name = document.getElementById('filterNameInput').value;
      const isCase = document.getElementById('caseBtn').classList.contains('active');

      // 3. 获取类型 (Types)
      // 适配新类名 .filter-tag 和 .all-tag
      const types = Array.from(document.querySelectorAll('#typeGroup .filter-tag.active:not(.all-tag)')).map(b => b.getAttribute('data-val'));
      const typeLogic = document.getElementById('typeLogic').classList.contains('include') ? 'include' : 'exclude';

      // 4. 获取状态 (States)
      // 适配新类名 .filter-tag 和 .all-tag
      const states = Array.from(document.querySelectorAll('#stateGroup .filter-tag.active:not(.all-tag)')).map(b => b.getAttribute('data-val'));
      const stateLogic = document.getElementById('stateLogic').classList.contains('include') ? 'include' : 'exclude';
      
      // 5. 获取高级属性 (Props)
      const props = [];
      // 适配新类名 .prop-item
      document.querySelectorAll('.prop-item').forEach(row => {
        const valRaw = row.querySelector('.p-val').value;
        const op = row.querySelector('.prop-op').value;
        const key = row.querySelector('.p-key').value;
        // 🔥 修复点：如果值为空，则跳过该条件，不发送给后端
        if (valRaw === '') return;
        // 尝试转为数字，如果是纯数字字符串
        const valNum = parseFloat(valRaw);
        // 如果 valRaw 不为空且能转为数字，则传数字，否则传字符串
        const finalVal = (valRaw !== '' && !isNaN(valNum)) ? valNum : valRaw;
        
        props.push({ key, op, val: finalVal });
      });

      // 发送消息给后端
      parent.postMessage({ 
        pluginMessage: { 
          type: 'find-and-select', 
          filters: { 
            scope, 
            name: { val: name, caseSensitive: isCase }, 
            types: { vals: types, logic: typeLogic }, 
            states: { vals: states, logic: stateLogic }, 
            props 
          } 
        } 
      }, '*');
    }
    
    // 获取当前选中元素的名称
    function fetchName() {
      postMsg('fetch-selection-name');
    }
    
    // 清除输入框
    function clearNameInput() {
        const input = document.getElementById('filterNameInput');
        input.value = '';
        toggleClearBtn(input);
        input.focus();
    }
    
    // 控制清除按钮显隐
    function toggleClearBtn(input) {
        const btn = document.getElementById('nameClearBtn');
        if(input.value.length > 0) btn.classList.remove('hidden');
        else btn.classList.add('hidden');
    }

    // Drag
    const handle = document.getElementById('resizeHandle');
    let isDragging = false;
    handle.onpointerdown = (e) => { isDragging = true; handle.setPointerCapture(e.pointerId); };
    
    // 拖动窗口调整大小
    window.onmousemove = (e) => {
      if (!isDragging) return;
      postMsg('resize-drag',{width: Math.max(170, e.clientX+5), height: Math.max(200, e.clientY+5) });
    };
    // 拖动结束时，重置拖动状态
    window.onmouseup = () => { isDragging = false; };
  
    // 2. 初始化导航 UI (自动加角标容器，避免手动改 HTML)
    // 2. 初始化导航 UI (移除红点生成)
    function initNavigationUI() {
      document.querySelectorAll('.nav-item').forEach(item => {
        if (!item.querySelector('.nav-left')) {
          const svg = item.querySelector('svg');
          const span = item.querySelector('.nav-text');

          if(svg && span){
            // 创建左侧容器
            const leftDiv = document.createElement('div');
            leftDiv.className = 'nav-left';
            item.appendChild(leftDiv);
            leftDiv.appendChild(svg);
            leftDiv.appendChild(span);
            
            // 创建右侧信息容器 (仅保留数量 Badge，移除 Red Dot)
            const metaDiv = document.createElement('div');
            metaDiv.className = 'nav-meta';
            metaDiv.innerHTML = `<span class="count-badge" style="display: none;">0</span>`;
            item.appendChild(metaDiv);
          }
        }
      });
      updateCountsAndStatus();
    }

    // 3. 计算数量 (最终纯净版)
    function updateCountsAndStatus() {
      // 定义各分类的数量计算逻辑
      const counts = {
        'nav_simple': document.querySelectorAll('#toolPanel .card').length,
        'nav_layout': document.querySelectorAll('#layoutPanel .card').length,
        'nav_style_tools': document.querySelectorAll('#stylePanel .card').length,
        // 单功能面板或无需统计的面板设为 null
        'nav_select': null,
        'nav_text': null,
        'nav_ppt': 1, 
        'nav_refiner': 1,
        'nav_theory': null
      };

      // 遍历导航项更新 UI
      document.querySelectorAll('.nav-item').forEach(item => {
        const key = item.getAttribute('data-key');
        const badge = item.querySelector('.count-badge');
        
        // 仅更新数量角标 (大于1才显示)
        const count = counts[key];
        if (count && count > 1) {
          badge.innerText = count;
          badge.style.display = 'inline-block';
        } else {
          // 如果没有数量或数量为1，隐藏角标
          if(badge) badge.style.display = 'none';
        }
      });
    }

    // 4.执行初始化
    initNavigationUI();

    // === PPT 工具逻辑 (全自动 + Loading + 性能优化 + 死循环修复) ===
    
    let pptStepIndex = 1; 
    let pptState = 'idle'; 
    let pptSlidesCache = [];
    let pptIncomingSlide = null;
    let pptZip = null;
    let isAutoRunning = false; 
    let isUIUpdatePending = false; // UI 节流标记


    // =============================================================================
    // DESIGN THEORY MODULE (设计理论模块)
    // =============================================================================
    
    // 1. 核心数据库 (Data - Final Ultimate Version)
    const theoryDB = [
      // -------------------------------------------------------
      // 1. 交互与可用性 (Interaction)
      // -------------------------------------------------------
      {
        id: 'nielsen',
        cat: 'interaction',
        icon: '🔟',
        title: '尼尔森十大可用性原则',
        subtitle: '产品设计领域的"圣经"，评估易用性的黄金标准',
        desc: '1994年由 Jakob Nielsen 提出。它们不是严格的法律，而是基于经验的启发式规则（Heuristics）。遵循这些原则可以消除 80% 的低级交互错误。',
        subItems: [
          {
            title: "1. 系统状态的可见性 (Visibility of system status)",
            core: "系统应在合理时间内，通过适当反馈，始终告知用户当前发生了什么。",
            case: "微信发送消息时的'转圈'和'红色感叹号'；电梯楼层显示；下载进度条。",
            val: "消除不确定性，给予用户安全感和掌控感。"
          },
          {
            title: "2. 系统与现实世界的匹配 (Match between system and the real world)",
            core: "使用用户熟悉的语言和现实世界的概念（拟物化/隐喻）。",
            case: "回收站图标；指南针APP模仿真实罗盘；电子书翻页动画。",
            val: "降低学习成本，利用用户的既有认知模型。"
          },
          {
            title: "3. 用户操控与自由 (User control and freedom)",
            core: "提供显著的'紧急出口'，支持撤销和重做。",
            case: "微信'撤回消息'；Gmail '撤销发送'；弹窗的关闭(X)按钮。",
            val: "给用户'后悔药'，鼓励探索而不必担心不可逆后果。"
          },
          {
            title: "4. 一致性与标准化 (Consistency and standards)",
            core: "遵循平台惯例，内部用词、布局、操作逻辑统一。",
            case: "统一的保存图标；红绿灯逻辑（红=停/删）；底部导航栏布局。",
            val: "降低记忆负担，建立产品可信度。"
          },
          {
            title: "5. 防错原则 (Error prevention)",
            core: "利用限制条件或确认选项，从源头防止错误发生。",
            case: "必填项未填时按钮置灰；搜索引擎纠错；删除二次确认。",
            val: "阻断错误，提高任务完成率。"
          },
          {
            title: "6. 再认而非回忆 (Recognition rather than recall)",
            core: "把选项和对象显示出来，让用户'认'，而不是'背'。",
            case: "浏览记录；字体菜单显示字体样式；电商'猜你喜欢'。",
            val: "识别比回忆容易，显著降低认知负荷。"
          },
          {
            title: "7. 使用的灵活与高效 (Flexibility and efficiency of use)",
            core: "为专家用户提供快捷键或宏命令。",
            case: "Excel 快捷键；双击点赞；Spotlight 搜索。",
            val: "满足不同层级用户，提升长期体验。"
          },
          {
            title: "8. 美观与简约设计 (Aesthetic and minimalist design)",
            core: "去除无关信息，最大化信噪比。",
            case: "Google 首页；无印良品风格；去分割线设计。",
            val: "突出核心任务，减少注意力争夺。"
          },
          {
            title: "9. 帮助用户识别、诊断和恢复错误",
            core: "错误信息应说人话，并给出解决方案。",
            case: "断网提示'检查网络'而非'Error 404'；密码错误提示'找回密码'。",
            val: "减少挫败感，帮助闭环解决问题。"
          },
          {
            title: "10. 帮助与文档 (Help and documentation)",
            core: "必要时提供易检索、步骤清晰的帮助。",
            case: "新手引导 (Onboarding)；Tooltip；客服 FAQ。",
            val: "作为最后的安全网兜底复杂场景。"
          }
        ]
      },
      {
        id: 'wcag',
        cat: 'interaction',
        icon: '♿',
        title: 'WCAG 无障碍指南',
        subtitle: '让所有人（包括残障人士）都能使用',
        desc: 'Web Content Accessibility Guidelines 是全球通用的无障碍设计标准，遵循 POUR 四大原则。',
        subItems: [
          {
            title: "1. 可感知 (Perceivable)",
            core: "信息和界面必须以用户能感知的方式呈现（不能只靠视觉）。",
            case: "为图片提供 Alt 文本（给盲人读屏软件用）；视频加字幕（给听障用户）。",
            val: "确保感官障碍用户也能获取信息。"
          },
          {
            title: "2. 可操作 (Operable)",
            core: "界面组件必须可操作（不能只靠鼠标）。",
            case: "支持纯键盘操作（Tab键切换焦点）；避免导致癫痫的快速闪烁。",
            val: "确保肢体障碍用户能顺畅交互。"
          },
          {
            title: "3. 可理解 (Understandable)",
            core: "信息和操作必须易于理解。",
            case: "表单报错要说明原因；避免使用生僻的行业黑话。",
            val: "降低认知门槛，特别是对认知障碍人群。"
          },
          {
            title: "4. 鲁棒性 (Robust)",
            core: "内容能被各种辅助技术（如读屏器）可靠地解析。",
            case: "使用标准的 HTML 标签而不是自造标签；保持代码规范。",
            val: "兼容现在和未来的各种辅助设备。"
          }
        ]
      },
      {
        id: 'ai_guide',
        cat: 'interaction',
        icon: '🤖',
        title: '人与 AI 交互指南',
        subtitle: '微软/Google 针对 AI 产品的新原则',
        desc: 'AI 具有不确定性（幻觉）和进化性，传统的确定性交互原则不再完全适用。',
        subItems: [
          {
            title: "1. 明确系统能力 (Make clear what the system can do)",
            core: "帮助用户建立正确的心理预期，避免过度信任。",
            case: "ChatGPT 启动页列出'我能写代码、由于数据限制可能产生错误'。",
            val: "防止用户因期望过高而产生失望。"
          },
          {
            title: "2. 优雅地失败 (Support efficient correction)",
            core: "AI 经常犯错，要提供简单的修正机制。",
            case: "Midjourney 生成图如果不满意，提供'U1/V1'重绘按钮；语音助手听错了支持文本编辑。",
            val: "将错误转化为微调的机会，降低挫败感。"
          },
          {
            title: "3. 随着时间学习 (Learn over time)",
            core: "系统应记住用户的偏好，越用越好用。",
            case: "网易云音乐的'私人FM'；抖音的推荐算法。",
            val: "建立长期的个性化壁垒。"
          }
        ]
      },
      {
        id: 'vui',
        cat: 'interaction',
        icon: '🎙️',
        title: '语音交互原则 (VUI)',
        subtitle: '看不见的界面设计',
        desc: '针对 Siri、小爱同学、车载语音等无屏幕或少屏幕场景的设计原则。',
        subItems: [
          {
            title: "1. 会话合作原则 (Grice's Maxims)",
            core: "机器说话要像人：量的准则（别废话）、质的准则（别瞎说）、关联准则（不跑题）。",
            case: "问'天气怎么样'，回答'北京今天晴，20度'，而不是念一段气象百科。",
            val: "降低认知负荷，模拟自然对话体验。"
          },
          {
            title: "2. 容错与重听 (Error Handling)",
            core: "语音是线性的，无法像屏幕一样'扫视'，一旦听错成本很高。",
            case: "当没听清时，问'你是说播放周杰伦吗？'（隐式确认）而不是直接报错。",
            val: "防止对话进入死胡同。"
          }
        ]
      },
      {
        id: 'spatial',
        cat: 'interaction',
        icon: '🥽',
        title: '空间计算原则 (Spatial Computing)',
        subtitle: 'Apple Vision Pro / AR / VR 设计',
        desc: '从 2D 屏幕跨越到 3D 空间，交互逻辑发生了根本性变化：眼睛是鼠标，手势是点击。',
        subItems: [
          {
            title: "1. 视线与手势协同 (Eyes & Hands)",
            core: "利用眼动追踪进行'注视'（Hover），利用手势进行'确认'（Click）。",
            case: "Vision Pro 中，看着图标它会微微浮起，捏合手指即可打开。",
            val: "最符合直觉的'意念控制'体验。"
          },
          {
            title: "2. 舒适距离与视场角",
            core: "内容应放置在距离用户 1.5-2 米的舒适区，主要内容在中心 30度 视角内。",
            case: "主界面窗口总是默认出现在正前方，避免用户频繁转头（脖子累）。",
            val: "符合人体工程学，避免晕动症和疲劳。"
          },
          {
            title: "3. 沉浸与穿透 (Immersion Spectrum)",
            core: "允许用户在'完全虚拟'和'现实增强'之间自由调节。",
            case: "旋转数码旋钮，可以在'看见客厅'和'置身月球'之间无缝切换。",
            val: "赋予用户对环境的掌控感。"
          }
        ]
      },
      {
        id: 'fitts',
        cat: 'interaction',
        icon: '🎯',
        title: '费茨定律 (Fitts\'s Law)',
        subtitle: '距离与大小决定操作效率',
        desc: '从一个起始位置移动到一个最终目标所需的时间，由目标的距离和大小决定。简而言之：目标越大、距离越近，越容易操作。',
        subItems: [
          {
            title: "核心公式",
            core: "T = a + b log2(D/W + 1)。时间(T)与距离(D)成正比，与宽度(W)成反比。",
            case: "不仅适用于鼠标，更适用于触摸屏的手指操作。",
            val: "量化了交互效率，为按钮布局提供数学依据。"
          },
          {
            title: "应用：拇指热区",
            core: "在移动端，将高频操作放在屏幕底部（拇指自然触达区）。",
            case: "现代APP的底部导航栏；iOS 地址栏下移；弹窗操作按钮在底部。",
            val: "减少手指移动距离，提升单手操作舒适度。"
          },
          {
            title: "应用：无限大目标",
            core: "屏幕边缘和角落是'无限大'的目标，因为鼠标无法移出边缘。",
            case: "Windows 开始菜单在左下角；Mac 菜单栏贴顶。",
            val: "利用物理边缘实现盲操作。"
          }
        ]
      },
      {
        id: 'doherty',
        cat: 'interaction',
        icon: '⚡️',
        title: '多赫蒂阈值 (Doherty Threshold)',
        subtitle: '400ms 是人机交互的界限',
        desc: '为了保持用户的注意力，系统响应时间不应超过 400 毫秒。如果超过，用户就会分心，效率下降。',
        subItems: [
          {
            title: "即时反馈",
            core: "任何操作都必须在 0.1秒内给予视觉反馈。",
            case: "按钮按下的按压态（Pressed state）；Tab切换的高亮。",
            val: "告诉用户'系统收到了你的操作'。"
          },
          {
            title: "感知性能 (Perceived Performance)",
            core: "如果物理速度慢，就欺骗大脑，让它觉得快。",
            case: "骨架屏 (Skeleton)；点赞瞬间变红（本地预判）；进度条动画。",
            val: "消除'等待感'，留住不耐烦的用户。"
          }
        ]
      },

      // -------------------------------------------------------
      // 2. 心理学 (Psychology)
      // -------------------------------------------------------
      {
        id: 'norman',
        cat: 'psychology',
        icon: '❤️',
        title: '情感化设计 (Emotional Design)',
        subtitle: '唐·诺曼提出的三个设计层次',
        desc: '好的设计不仅要好用，还要能引发情感共鸣。诺曼将设计认知分为三个层次。',
        subItems: [
          {
            title: "1. 本能层 (Visceral)",
            core: "关注外观、感官刺激。'颜值即正义'。",
            case: "Apple 产品精致的铝合金质感；跑车流线型的外形；精美的图标。",
            val: "第一印象决定用户是否愿意接近产品。"
          },
          {
            title: "2. 行为层 (Behavioral)",
            core: "关注功能、性能和可用性。'好用才是硬道理'。",
            case: "顺滑的滑动列表；一键下单的便捷；符合人体工学的手柄。",
            val: "决定了用户能否完成任务，是产品的基础。"
          },
          {
            title: "3. 反思层 (Reflective)",
            core: "关注意识、回忆、自我形象和品牌认同。",
            case: "佩戴劳力士象征身份；网易云音乐评论区的情感共鸣；环保产品的自我满足感。",
            val: "建立长期情感连接，让用户成为粉丝。"
          }
        ]
      },
      {
        id: 'miller',
        cat: 'psychology',
        icon: '🧠',
        title: '米勒定律 (Miller\'s Law)',
        subtitle: '神奇的数字 7 ± 2',
        desc: '普通人的工作记忆只能同时处理 5 到 9 个信息块。超过这个数量，大脑就会过载。',
        subItems: [
          {
            title: "分块 (Chunking)",
            core: "将复杂信息拆解为更小的组合，以便记忆。",
            case: "手机号 138-0000-0000 (3-4-4结构)；银行卡号每4位一个空格。",
            val: "突破短时记忆瓶颈，提升信息易读性。"
          },
          {
            title: "选项限制",
            core: "导航菜单或选项卡尽量控制在 5-9 个以内。",
            case: "APP 底部 Tab 一般不超过 5 个；超过的部分收入'更多'。",
            val: "防止选择困难和认知过载。"
          }
        ]
      },
      {
        id: 'hick',
        cat: 'psychology',
        icon: '🤔',
        title: '希克定律 (Hick\'s Law)',
        subtitle: '选择越多，决策越慢',
        desc: '做决策所需的时间与选项数量呈对数关系。大脑天然厌恶复杂的决策。',
        subItems: [
          {
            title: "做减法",
            core: "在特定场景下，尽量减少选项数量。Less is More。",
            case: "落地页（Landing Page）只保留一个'立即购买'按钮；遥控器精简按钮。",
            val: "降低决策瘫痪风险，提高转化率。"
          },
          {
            title: "分步引导 (Wizard)",
            core: "将复杂任务拆解为简单步骤。",
            case: "注册流程：分三页填手机号、验证码、密码，而不是一页填所有。",
            val: "降低单页认知负荷，利用沉没成本鼓励完成。"
          }
        ]
      },
      {
        id: 'peakend',
        cat: 'psychology',
        icon: '🏔️',
        title: '峰终定律 (Peak-End Rule)',
        subtitle: '记忆由高潮和结尾决定',
        desc: '诺贝尔奖得主丹尼尔·卡尼曼提出。用户对体验的记忆不是平均值，而是由"最高峰"和"结束时"决定的。',
        subItems: [
          {
            title: "制造峰值 (Peak)",
            core: "在流程中设计一个让用户感到惊喜或极致便利的时刻。",
            case: "游戏抽卡金光特效；电商下单后的'确定性'快感。",
            val: "一个高光时刻可掩盖许多瑕疵。"
          },
          {
            title: "优化终值 (End)",
            core: "确保流程的最后一步是愉快的。",
            case: "宜家出口的冰淇淋；外卖支付成功后的红包。",
            val: "好的结尾极大提升复购意愿。"
          }
        ]
      },

      // -------------------------------------------------------
      // 3. 视觉感知 (Visual)
      // -------------------------------------------------------
      {
        id: 'gestalt',
        cat: 'visual',
        icon: '👀',
        title: '格式塔原理 (Gestalt)',
        subtitle: '全版本：大脑如何组织视觉元素',
        desc: '解释了人类视觉感知系统如何将复杂元素简化、分组。UI 排版的底层逻辑。',
        subItems: [
          {
            title: "1. 邻近性 (Proximity)",
            core: "位置靠近的元素被视为一组。",
            case: "标签与输入框的间距 < 标签与上一行输入框的间距。",
            val: "利用间距构建层级，无需分割线。"
          },
          {
            title: "2. 共同区域 (Common Region)",
            core: "同一背景框内的元素被视为一组。权重高于邻近性。",
            case: "卡片式设计 (Card UI)。",
            val: "最强大的分组工具，明确内容边界。"
          },
          {
            title: "3. 相似性 (Similarity)",
            core: "形状、颜色相同的元素被视为一组。",
            case: "所有可点击链接使用相同蓝色；按钮风格统一。",
            val: "建立功能模式识别。"
          },
          {
            title: "4. 连续性 (Continuity)",
            core: "人眼倾向于观察连续的路径。",
            case: "横滑卡片露出一半，暗示可滑动。",
            val: "引导视线，暗示屏幕外内容。"
          },
          {
            title: "5. 闭合性 (Closure)",
            core: "大脑会自动补全不完整的图形。",
            case: "Loading 断开的圆环；极简图标。",
            val: "利用负空间简化设计。"
          },
          {
            title: "6. 共同命运 (Common Fate)",
            core: "同向运动的元素是一组。动效核心。",
            case: "下拉菜单整体展开；侧滑返回全页移动。",
            val: "建立动效逻辑关联。"
          },
          {
            title: "7. 图底关系 (Figure-Ground)",
            core: "分辨前景与背景。",
            case: "弹窗背景压暗（遮罩）。",
            val: "引导注意力聚焦。"
          }
        ]
      },
      {
        id: 'vonrestorff',
        cat: 'visual',
        icon: '🌟',
        title: '冯·雷斯托夫效应 (隔离效应)',
        subtitle: '与众不同者，最易被铭记',
        desc: '在多个相似物体中，那个长得最不一样的（颜色、形状、大小）最容易被记住。',
        subItems: [
          {
            title: "强调核心操作 (CTA)",
            core: "最重要的按钮必须在视觉上完全隔离。",
            case: "灰色的取消按钮 vs 亮蓝色的确认按钮。",
            val: "引导注意力，提升转化率。"
          }
        ]
      },

      // -------------------------------------------------------
      // 4. 商业策略 (Business)
      // -------------------------------------------------------
      {
        id: 'hook',
        cat: 'business',
        icon: '🪝',
        title: '上瘾模型 (Hook Model)',
        subtitle: '如何打造让用户养成的习惯的产品',
        desc: '由尼尔·埃亚尔提出。通过四个阶段的循环，让用户在不知不觉中对产品产生依赖。',
        subItems: [
          {
            title: "1. 触发 (Trigger)",
            core: "外部触发（推送、广告）和内部触发（无聊、焦虑）。",
            case: "收到微信消息提示音（外部）；感到孤独想刷朋友圈（内部）。",
            val: "习惯养成的起点。"
          },
          {
            title: "2. 行动 (Action)",
            core: "在动机和能力的驱使下完成最简单的行为。",
            case: "双击屏幕点赞；下拉刷新。",
            val: "降低行动门槛是关键。"
          },
          {
            title: "3. 多变的酬赏 (Variable Reward)",
            core: "不可预测的反馈比固定的反馈更迷人（老虎机机制）。",
            case: "刷抖音不知道下一条是什么；盲盒；点赞数的不确定性。",
            val: "多巴胺分泌的核心来源。"
          },
          {
            title: "4. 投入 (Investment)",
            core: "用户投入的越多（时间、数据、社交关系），越离不开。",
            case: "收藏歌单；积累粉丝；完善个人资料。",
            val: "增加转换成本，建立护城河。"
          }
        ]
      },
      {
        id: 'kano',
        cat: 'business',
        icon: '📊',
        title: '卡诺模型 (Kano Model)',
        subtitle: '需求优先级分析工具',
        desc: '并非所有功能都同等重要。根据对满意度的影响，将需求分类。',
        subItems: [
          {
            title: "1. 基本型 (Must-be)",
            core: "必须有，没有会被骂，有了不加分。",
            case: "微信能发消息；火锅店有热水。",
            val: "产品的及格线，必须100%满足。"
          },
          {
            title: "2. 期望型 (Performance)",
            core: "越多越好，线性提升满意度。",
            case: "电池续航；网速；存储空间。",
            val: "产品的核心竞争力战场。"
          },
          {
            title: "3. 兴奋型 (Delighters)",
            core: "没有无所谓，有了惊喜若狂。",
            case: "海底捞美甲；微信拍一拍。",
            val: "低成本创造口碑传播点。"
          }
        ]
      },

      // -------------------------------------------------------
      // 5. 系统思维 (System)
      // -------------------------------------------------------
      {
        id: 'atomic',
        cat: 'system',
        icon: '⚛️',
        title: '原子设计 (Atomic Design)',
        subtitle: 'Brad Frost：构建设计系统的方法论',
        desc: '将界面视为由微小组件构成的系统，而非孤立的页面。',
        subItems: [
          {
            title: "1. 原子 (Atoms)",
            core: "不可再分的最小单元。",
            case: "颜色 Token、字体样式、图标、HTML标签。",
            val: "系统的基础DNA。"
          },
          {
            title: "2. 分子 (Molecules)",
            core: "原子的简单组合，具有单一功能。",
            case: "搜索框（输入框+按钮）；表单项（标签+输入框）。",
            val: "开始形成可复用的组件。"
          },
          {
            title: "3. 组织 (Organisms)",
            core: "分子组合成复杂模块。",
            case: "顶部导航栏；产品卡片；页脚。",
            val: "界面的主要构成区块。"
          },
          {
            title: "4. 模板与页面 (Templates & Pages)",
            core: "从抽象结构到具体内容的落地。",
            case: "线框图 -> 填充了真实数据的最终设计稿。",
            val: "验证系统在真实场景下的表现。"
          }
        ]
      },
      {
        id: 'iso9241',
        cat: 'system',
        icon: '📐',
        title: 'ISO 9241-210 标准',
        subtitle: '人机交互的人机工程学标准',
        desc: '定义了"以人为中心的设计 (HCD)" 流程，是工业界和专业 UX 领域的权威标准。',
        subItems: [
          {
            title: "核心：以人为中心",
            core: "设计应基于对用户、任务和环境的明确理解。",
            case: "在设计车载大屏前，必须了解驾驶员的注意力限制和光照环境。",
            val: "避免'闭门造车'，确保产品适应真实世界。"
          },
          {
            title: "迭代设计流程",
            core: "理解使用背景 -> 规定用户需求 -> 设计解决方案 -> 评估设计。",
            case: "用户调研 -> 需求文档 -> 原型设计 -> 可用性测试 -> 修改 -> 再测试。",
            val: "承认设计无法一次完美，必须通过反馈不断修正。"
          }
        ]
      },
      {
        id: 'tesler',
        cat: 'system',
        icon: '⚖️',
        title: '泰斯勒定律 (复杂性守恒)',
        subtitle: '复杂性不会消失，只能转移',
        desc: '任何系统都有一个无法减少的复杂性下限。问题是：谁来承担？用户还是开发者？',
        subItems: [
          {
            title: "把麻烦留给开发者",
            core: "不要让用户设定系统可以自动推断的参数。",
            case: "输入'北京到上海'自动查询车次（系统承担复杂性）vs 自己查时刻表（用户承担）。",
            val: "用开发成本换取用户体验。"
          }
        ]
      }
    ];

    // 2. 渲染列表逻辑
    function renderTheoryList(category = 'all') {
      const container = document.getElementById('theoryGrid');
      container.innerHTML = '';
      
      const list = category === 'all' 
        ? theoryDB 
        : theoryDB.filter(item => item.cat === category);
        
      if (list.length === 0) {
        container.innerHTML = `<div style="text-align:center; color:#999; font-size:12px; padding:20px;">暂无相关理论</div>`;
        return;
      }

      list.forEach(item => {
        const div = document.createElement('div');
        div.className = 'theory-card';
        div.onclick = () => openTheoryDetail(item.id);
        div.innerHTML = `
          <div class="t-card-icon">${item.icon}</div>
          <div class="t-card-content">
            <div class="t-card-title">${item.title}</div>
            <div class="t-card-desc">${item.subtitle}</div>
          </div>
        `;
        container.appendChild(div);
      });
    }

    // 3. 筛选逻辑
    function filterTheory(cat, el) {
      // 样式切换
      document.querySelectorAll('.t-tag').forEach(t => t.classList.remove('active'));
      el.classList.add('active');
      // 渲染
      renderTheoryList(cat);
    }

    // 4. 打开详情页 (Enhanced Renderer)
    function openTheoryDetail(id) {
      const item = theoryDB.find(t => t.id === id);
      if(!item) return;

      // A. 填充头部 Hero 内容
      document.getElementById('detailIcon').innerText = item.icon;
      document.getElementById('detailTitle').innerText = item.title;
      document.getElementById('detailSubtitle').innerText = item.subtitle;
      document.getElementById('detailMainDesc').innerHTML = item.desc;
      document.getElementById('detailCatBadge').innerText = item.cat.toUpperCase();
      
      // B. 动态渲染 Sub-items (核心部分)
      const container = document.getElementById('theoryDetailDynamicContent');
      container.innerHTML = ''; // 清空旧内容

      if (item.subItems && item.subItems.length > 0) {
        // 遍历所有子理论
        item.subItems.forEach((sub, index) => {
          const div = document.createElement('div');
          div.className = 'sub-theory-card';
          
          // 构建 HTML
          div.innerHTML = `
            <div class="st-index">${index + 1}</div>
            <div class="st-title">${sub.title}</div>
            
            <div class="st-block">
              <div class="st-label lbl-core">✨ 核心释义</div>
              <div class="st-text">${sub.core}</div>
            </div>
            
            <div class="st-block">
              <div class="st-label lbl-case">🌰 应用案例</div>
              <div class="st-text">${sub.case}</div>
            </div>
            
            <div class="st-block">
              <div class="st-label lbl-val">💎 理论价值</div>
              <div class="st-text">${sub.val}</div>
            </div>
          `;
          container.appendChild(div);
        });
      } else {
        // Fallback: 如果没有子理论 (兼容旧数据或简单理论)
        // 渲染一个默认卡片
        container.innerHTML = `<div style="padding:20px; text-align:center; color:#999;">暂无详细拆解</div>`;
      }

      // C. 切换视图
      document.getElementById('theoryListView').style.display = 'none';
      document.getElementById('theoryDetailView').style.display = 'flex';
      
      // 隐藏主搜索栏
      document.getElementById('mainHeader').style.display = 'none';
      
      // 滚动回顶部
      document.querySelector('.theory-article-scroll').scrollTop = 0;
    }

    // 5. 关闭详情页
    function closeTheoryDetail() {
      document.getElementById('theoryListView').style.display = 'flex';
      document.getElementById('theoryDetailView').style.display = 'none';
      
      // 恢复搜索栏显示 (如果需要的话，配合 switchGroup 逻辑)
      document.getElementById('mainHeader').style.display = 'block';
    }

    // 6. 搜索功能对接 (在 switchGroup 中被调用或监听 input)
    // 监听主搜索框输入 (如果用户在理论面板)
    document.getElementById('searchInput').addEventListener('input', (e) => {
      // 只有在理论面板显示时才接管搜索
      if (document.getElementById('theoryPanel').style.display !== 'none') {
        const val = e.target.value.toLowerCase();
        const container = document.getElementById('theoryGrid');
        
        // 如果在详情页，输入搜索自动切回列表
        if (document.getElementById('theoryDetailView').style.display === 'flex') {
           closeTheoryDetail();
        }

        container.innerHTML = '';
        const filtered = theoryDB.filter(item => 
          item.title.toLowerCase().includes(val) || 
          item.subtitle.toLowerCase().includes(val) ||
          item.desc.toLowerCase().includes(val)
        );

        if (filtered.length === 0) {
          container.innerHTML = `<div style="text-align:center; color:#999; font-size:12px; padding:20px;">未找到 "${e.target.value}" 相关理论</div>`;
          return;
        }

        filtered.forEach(item => {
          const div = document.createElement('div');
          div.className = 'theory-card';
          div.onclick = () => openTheoryDetail(item.id);
          div.innerHTML = `
            <div class="t-card-icon">${item.icon}</div>
            <div class="t-card-content">
              <div class="t-card-title">${item.title}</div>
              <div class="t-card-desc">${item.subtitle}</div>
            </div>
          `;
          container.appendChild(div);
        });
      }
    });

    // ==========================================
    // 统一的消息监听中心 (请确保全文件只有这一个 onmessage)
    // ==========================================
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      if (!msg) return;

      // PPT 工具消息处理 ---
      // 如果消息是以 'ppt-' 或 'step-' 开头，交给 PPT 逻辑处理
      if (msg.type.startsWith('ppt-') || msg.type.startsWith('step-')) {
          handlePPTMessage(msg);
          return;
      }

      // Refiner (命名清洗) 消息处理 ---
      // 如果消息是 'lint-results'，交给 Refiner 渲染函数
      if (msg.type === 'lint-results') {
        
          console.log("【4】前端：收到结果了！准备渲染列表...", msg.data);
          // 调用渲染函数显示列表
          // 确保 renderRefinerResults 函数已定义
          if (typeof renderRefinerResults === 'function') {
              renderRefinerResults(msg.data);
          } else {
              console.error("错误：找不到 renderRefinerResults 函数！");
          }
          return;
      }

      // 拾取名称消息 -- 其他通用消息 (例如获取图层名称) ---
      if (msg.type === 'update-name-input') {
          // 这里处理其他杂项功能，比如回填输入框
          const nameInput = document.getElementById('filterNameInput');
          if (nameInput) nameInput.value = msg.name;
      }
      
      // 查找结果处理
      if (msg.type === 'found-layers-result') {
          handleFoundLayersResult(msg);
      }
    
      if (msg.type === 'text-find-results') {
          renderTextFindResults(msg.data);
      }
      // 在 window.onmessage 内部添加：
    
      if (msg.type === 'text-replace-success') {
          const uids = msg.processedUids || [];
          
          // 1. 更新数据状态
          uids.forEach(uid => {
              const item = textResultCache.find(x => x.uid === uid);
              if (item) {
                  item._done = true;
                  item._selected = false; // 取消选中
              }
              
              // 2. 更新 DOM 样式
              const row = document.getElementById(`row_${uid}`);
              if (row) {
                  row.classList.add('replaced');
                  const cb = row.querySelector('.row-cb');
                  if(cb) {
                      cb.checked = false;
                      cb.disabled = true;
                  }
              }
          });

          // 3. 刷新底部按钮状态
          updateTextFooterBtn();
          // 刷新全选框状态
          document.getElementById('textSelectAll').checked = false;
      }
    
      if (msg.type === 'highlight-status') {
        // msg: { key: "ID_Index", status: true/false }
        const { key, status } = msg;
        // 我们需要把后端 Key 映射回前端的 UID
        // 前端 UID 格式: match_${item.id}_${item.index}_${i}
        // 后端 Key 格式: ${item.id}_${item.index}
        // 我们可以遍历查找，或者直接改用后端 Key 作为 DOM ID 的一部分。
        // 简单遍历：
        const item = textResultCache.find(x => `${x.id}_${x.index}` === key);
        if (item) {
            const row = document.getElementById(`row_${item.uid}`);
            if (row) {
                if (status) row.classList.add('is-highlighted');
                else row.classList.remove('is-highlighted');
            }
        }
    }
    
      if (msg.type === 'clear-all-highlights-ui') {
          document.querySelectorAll('.text-result-row').forEach(el => {
              el.classList.remove('is-highlighted');
          });
      }

      // Smart Fill 消息处理
      if (msg.type === 'selection-count-res') {
          handleFillGeneration(msg.count);
      }
      if (msg.type === 'storage-loaded') {
          if (msg.key === 'smart_custom_lists' && msg.value) {
             customDataLists = msg.value;
             renderBasicList();
          }
          if (msg.key === 'smart_ai_config' && msg.value) {
             aiConfig = msg.value;
             // 回填配置页
             document.getElementById('aiProvider').value = aiConfig.provider;
             document.getElementById('aiBaseUrl').value = aiConfig.baseUrl;
             document.getElementById('aiModelName').value = aiConfig.model;
             document.getElementById('aiKey').value = aiConfig.key;
          }
          if (msg.key === 'smart_date_format' && msg.value) {
             dateFormat = msg.value;
          }
      }
      if (msg.key === 'smart_advanced_settings') smartSettings = msg.value || smartSettings;
    };

    // 处理 PPT 消息的独立函数 (从 onmessage 拆分出来)
    function handlePPTMessage(msg) {
      const loadMsg = document.getElementById('loadingMsg');
      const statusEl = document.getElementById('status' + pptStepIndex);

      try {
          // 实时进度
          if (msg.type === 'ppt-init-total') {
              if(loadMsg) loadMsg.innerText = `准备处理共 ${msg.count} 个画板...`;
          }
          else if (msg.type === 'ppt-start-slide') {
              if (pptStepIndex === 4) {
                  pptIncomingSlide = { width: msg.width, height: msg.height, elements: [] };
                  if (!isUIUpdatePending) {
                      isUIUpdatePending = true;
                      requestAnimationFrame(() => {
                          if(loadMsg) loadMsg.innerText = `正在解析第 ${msg.index + 1} 页...`;
                          isUIUpdatePending = false;
                      });
                  }
              }
          }
          else if (msg.type === 'ppt-element-batch') {
              if (pptIncomingSlide && Array.isArray(msg.data)) {
                  pptIncomingSlide.elements.push(...msg.data);
              }
          }
          else if (msg.type === 'ppt-end-slide') {
              if (pptIncomingSlide) {
                  pptSlidesCache.push(pptIncomingSlide);
                  pptIncomingSlide = null;
              }
          }
          else if (msg.type === 'ppt-asset-chunk') {
              if (pptZip) {
                  pptZip.file(msg.fileName, msg.data);
                  if (!isUIUpdatePending) {
                      isUIUpdatePending = true;
                      requestAnimationFrame(() => {
                          if(loadMsg) loadMsg.innerText = `正在压缩: ${msg.fileName}`;
                          isUIUpdatePending = false;
                      });
                  }
              }
          }
          // 步骤完成
          else if (msg.type === 'step-done' && msg.step === pptStepIndex) {
              if(statusEl) statusEl.innerText = "✅ 执行成功";
              
              if (pptStepIndex === 4) {
                  if(loadMsg) loadMsg.innerText = "数据提取完成，生成 PPT...";
                  const scale = document.getElementById('pptScale') ? document.getElementById('pptScale').checked : true;
                  setTimeout(() => generatePPT({ slides: pptSlidesCache }, scale), 50);
              }
              if (pptStepIndex === 5) {
                  if(loadMsg) loadMsg.innerText = "资源打包完成，准备下载...";
                  generateAssetsZip(true); 
              }

              pptState = 'done';
              if (isAutoRunning) {
                  if (pptStepIndex < 6) {
                      setTimeout(() => runCurrentPPTStep(), 800);
                  } else {
                      isAutoRunning = false;
                  }
              }
              updatePPTUI();
          }
          // 错误处理
          else if (msg.type === 'step-error') {
              pptState = 'idle';
              isAutoRunning = false;
              alert("执行出错，请重试。");
              updatePPTUI();
          }
      } catch (e) {
          console.error("PPT Error:", e);
          isAutoRunning = false;
          pptState = 'idle';
          updatePPTUI();
      }
    }

    // 1. 刷新界面显示 (含 Loading 遮罩)
    function updatePPTUI() {
      const overlay = document.getElementById('loadingOverlay');
      const loadTitle = document.getElementById('loadingTitle');
      const loadMsg = document.getElementById('loadingMsg');

      // 控制遮罩显隐
      if (pptState === 'processing') {
        if(overlay) overlay.classList.add('active');
        // 动态获取当前步骤的标题作为 Loading 标题 (例如: "1. Global Clean")
        const currentStepKey = 'ppt_step' + pptStepIndex + '_t';
        if(loadTitle) loadTitle.innerText = (i18n[curLang][currentStepKey] || "Processing...") + "...";
        
        // 副标题处理
        if(loadMsg) {
           if(pptStepIndex === 4) {
              loadMsg.innerText = curLang === 'zh' 
                ? "图层较多时耗时较长，请保持耐心..." 
                : "Large files may take time, please wait...";
           } else {
              loadMsg.innerText = curLang === 'zh' 
                ? "正在分析设计稿结构..." 
                : "Analyzing design structure...";
           }
        }
      } else {
        if(overlay) overlay.classList.remove('active');
      }

      // 步骤卡片显隐
      for (let i = 1; i <= 6; i++) {
        const el = document.getElementById('pptStep' + i);
        if(el) el.classList.toggle('active', i === pptStepIndex);
      }
      
      const prog = document.getElementById('pptProgBar');
      if(prog) prog.style.width = ((pptStepIndex - 1) / 5 * 100) + '%';

      // 按钮状态逻辑
      const btn = document.getElementById('pptActionBtn');
      const autoBtn = document.getElementById('btnAutoRun');
      if (!btn) return;

      if (isAutoRunning) {
        autoBtn.innerHTML = curLang === 'zh' ? "⏳ 自动运行中..." : "🚀 Auto Running..."; 
        autoBtn.disabled = true;
        btn.disabled = true; 
        btn.innerText = curLang === 'zh' ? "🤖 接管中..." : "🤖 Processing...";
      } else {
        autoBtn.innerHTML = `<span>${i18n[curLang].ppt_btn_auto}</span>`;
        autoBtn.disabled = false;
        
        if (pptStepIndex === 6) {
          btn.innerText = i18n[curLang].ppt_btn_done;
          btn.disabled = true;
        } else if (pptState === 'done') {
          btn.innerText = i18n[curLang].ppt_btn_next;
          btn.disabled = false;
          btn.style.color = '#52c41a'; // 绿色
        } else {
          btn.innerText = i18n[curLang].ppt_btn_run + pptStepIndex;
          btn.disabled = false;
          btn.style.color = '#1890FF'; // 蓝色
        }
      }
      // 更新每一步的小状态标签 (waiting/success)
      for (let i = 1; i <= 5; i++) {
        const s = document.getElementById('status' + i);
        if(s) {
          if (i < pptStepIndex || (i === pptStepIndex && pptState === 'done')) {
            s.innerText = i18n[curLang].ppt_stat_done;
            s.style.background = '#f6ffed';
            s.style.color = '#52c41a';
          } else {
            s.innerText = i18n[curLang].ppt_stat_wait;
            s.style.background = '#f5f5f5';
            s.style.color = '#999';
          }
        }
      }
    }

    // 2. 一键全自动入口 - 演示模式
    async function startAutoRun() {
      // 重置状态
      pptStepIndex = 1;
      pptState = 'idle';
      pptSlidesCache = [];
      isAutoRunning = true;
      
      updatePPTUI();
      
      // 演示模式：自动播放所有步骤
      await runDemoMode();
    }
    
    // 演示模式：自动播放步骤
    async function runDemoMode() {
      const stepDelays = [2000, 2500, 3000, 4000, 2500]; // 每个步骤的演示时间（毫秒）
      
      for (let i = 0; i < 5; i++) {
        pptStepIndex = i + 1;
        pptState = 'processing';
        updatePPTUI();
        
        // 显示loading动画
        await sleep(stepDelays[i]);
        
        // 标记当前步骤完成
        pptState = 'done';
        updatePPTUI();
        
        // 步骤间切换间隔
        if (i < 4) {
          await sleep(800);
        }
      }
      
      // 进入完成步骤
      pptStepIndex = 6;
      pptState = 'done';
      isAutoRunning = false;
      updatePPTUI();
    }
    
    // 辅助函数：延迟
    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    // 3. 手动/自动 执行入口 (含死循环修复)
    // 3. 手动/自动 执行入口 (清理后的版本)
    function runCurrentPPTStep() {
      // 防止在第6步继续执行
      if (pptStepIndex === 6) {
        isAutoRunning = false;
        updatePPTUI();
        return;
      }

      if (pptState === 'done') {
        // 点击“下一步”
        pptStepIndex++;
        pptState = 'idle';
        updatePPTUI();
        
        // 自动模式：延时触发
        if (isAutoRunning) {
          if (pptStepIndex === 6) {
             isAutoRunning = false;
             updatePPTUI();
             return;
          }
          setTimeout(() => runCurrentPPTStep(), 1000); 
        }
      } else {
        // 点击“执行”
        const scale = document.getElementById('pptScale') ? document.getElementById('pptScale').checked : true;
        // === 修改：在 Step 4 就初始化 ZIP 和缓存 ===
        if (pptStepIndex === 4) { 
          pptSlidesCache = []; 
          pptIncomingSlide = null; 
          pptZip = new JSZip(); // 提前创建 ZIP 实例
        }
        

        pptState = 'processing';
        updatePPTUI(); 

        parent.postMessage({ 
          pluginMessage: { type: 'ppt-step-' + pptStepIndex, config: { scale: scale } } 
        }, '*');
        
        // ❌ 注意：这里千万不要再写 window.addEventListener 了！！！
      }
    }

    // 4. 重置
    function resetPPT() {
      if (!confirm("确定要重新开始吗？")) return;
      pptStepIndex = 1;
      pptState = 'idle';
      pptSlidesCache = [];
      isAutoRunning = false;
      
      for(let i=1; i<=5; i++) {
        const s = document.getElementById('status'+i);
        if(s) s.innerText = i18n[curLang].ppt_stat_wait;
      }
      updatePPTUI();
    }

    // 5. 监听消息 (核心：UI防卡顿 + 流程控制)，有问题，删掉了
 
    // 6. 生成 PPT (最新版：圆角/阴影/透明度/字号)
    function generatePPT(data, doScale) {
      if (!data.slides || data.slides.length === 0) { alert("没有数据"); return; }
      const pptx = new PptxGenJS();
      const firstSlide = data.slides[0];
      const ratio = doScale ? 0.5 : 1;
      const layoutWidth = (firstSlide.width * ratio) / 96;
      const layoutHeight = (firstSlide.height * ratio) / 96;

      pptx.defineLayout({ name: 'FigmaFrame', width: layoutWidth, height: layoutHeight });
      pptx.layout = 'FigmaFrame';

      data.slides.forEach(slideData => {
        const slide = pptx.addSlide();
        
        slideData.elements.forEach(el => {
          // 绝对中心定位反推坐标
          const w = (el.w * ratio) / 96;
          const h = (el.h * ratio) / 96;
          const cx = (el.cx * ratio) / 96;
          const cy = (el.cy * ratio) / 96;
          const x = cx - (w / 2);
          const y = cy - (h / 2);

          const opts = { x:x, y:y, w:w, h:h };

          // 旋转
          if (el.rotation) opts.rotate = -el.rotation;

          // 透明度
          let pptTransparency = 0;
          if (el.opacity !== undefined && el.opacity < 1) pptTransparency = (1 - el.opacity) * 100;
          const fillTrans = (el.fillAlpha !== undefined && el.fillAlpha < 1) ? (1 - el.fillAlpha) * 100 : 0;
          const strokeTrans = (el.strokeAlpha !== undefined && el.strokeAlpha < 1) ? (1 - el.strokeAlpha) * 100 : 0;

          // 边框
          if (el.strokeColor) {
            opts.line = { color: el.strokeColor, width: (el.strokeWeight || 1) * ratio, transparency: strokeTrans };
          }

          // 阴影
          if (el.shadow) {
            const dist = Math.sqrt(el.shadow.x**2 + el.shadow.y**2) * ratio;
            let angle = Math.atan2(el.shadow.y, el.shadow.x) * (180 / Math.PI);
            if (angle < 0) angle += 360; 
            opts.shadow = { type: 'outer', color: el.shadow.color, opacity: el.shadow.opacity, blur: (el.shadow.blur * ratio * 0.75), offset: dist / 0.75, angle: angle };
          }

          // A. 线条 (Line) - 终极修正版
          else if (el.type === 'line') {
            // 箭头样式：如果后端标记了有箭头，就设为 'triangle' (标准箭头)，否则 'none'
            const arrowHead = el.headArrow ? 'triangle' : 'none';
            const arrowTail = el.tailArrow ? 'triangle' : 'none';

            const lineOpts = {
              x: x, y: y, w: w, h: h,
              rotate: opts.rotate || 0,
              line: {
                color: el.strokeColor || '000000',
                width: (el.strokeWeight || 1) * ratio,
                transparency: (el.strokeAlpha !== undefined) ? (1 - el.strokeAlpha)*100 : 0,
                
                // 🔥 核心修复：同时写上两套属性名，防止版本兼容问题
                // 方案 1: 针对 Shape 的属性
                lineHead: arrowHead,
                lineTail: arrowTail,
                // 方案 2: 针对 Connector 的属性 (作为兜底)
                beginArrowType: arrowHead,
                endArrowType: arrowTail
              }
            };
            
            if (el.dashPattern) lineOpts.line.dashType = 'dash'; 

            // 使用 addShape 画线条，这是最标准的做法
            slide.addShape(pptx.ShapeType.line, lineOpts);
          }
         
          // B. 文本
          else if (el.type === 'text') {
            const ptSize = Math.round((el.fontSize || 12) * ratio * 0.75);
            opts.fontSize = ptSize;
            opts.margin = 0; 
            
            // --- 调试日志 (请查看控制台) ---
            console.log(`文本: ${el.text.substring(0,5)}... | 字号(px):${el.fontSize} | 行高(px):${el.lineHeightPx}`);

            // 计算行高 (px -> pt)
            if (el.lineHeightPx) {
                opts.lineSpacing = Math.round(el.lineHeightPx * ratio * 0.75);
            } else {
                opts.lineSpacing = Math.round(ptSize * 1.2);
            }

            if (el.fontFace) opts.fontFace = el.fontFace;
            if (el.isBold) opts.bold = true;
            opts.color = el.color || '000000';
            opts.transparency = fillTrans;
            // ============================================
            // 🔥 核心修改：根据单/多行设置不同的布局属性
            // ============================================
            
            // 1. 水平对齐 (完全同步 Figma)
            opts.align = el.align || 'left';

            // 2. 差异化设置
            if (el.isMultiLine) {
                // --- 多行文本 ---
                // 需求：根据文字调整大小 + 自动换行 + 顶部对齐
                opts.fit = 'resize';  // 允许形状随文字撑开
                opts.wrap = true;     // 开启换行
                opts.valign = 'top';  // 顶部对齐
            } else {
                // --- 单行文本 ---
                // 需求：根据文字调整大小 + 不自动换行 + 垂直居中
                opts.fit = 'resize';  // 允许形状随文字撑开 (宽度变长)
                opts.wrap = false;    // 关闭换行 (单行无限长)
                opts.valign = 'middle'; // 垂直居中
            }
            
            // 注意：autoFit 属性与 fit 属性有时冲突，建议显式移除 autoFit 以防干扰
            delete opts.autoFit; 

            slide.addText(el.text, opts);
          }
          
          // C. 通用形状 (矩形、圆、三角、星形...)
          // 只要类型是 shape (新逻辑) 或者 rect/ellipse (兼容旧逻辑)
          else if (el.type === 'shape' || el.type === 'rect' || el.type === 'ellipse') {
            
            // 样式设置
            if (el.color) opts.fill = { color: el.color, transparency: fillTrans };
            else opts.fill = { color: 'FFFFFF', transparency: 100 }; // 无填充则白色透明(占位)
            
            if (el.strokeColor) {
                opts.line = { 
                    color: el.strokeColor, 
                    width: (el.strokeWeight || 1) * ratio, 
                    transparency: strokeTrans 
                };
            }

            // --- 🔥 核心：动态形状类型 ---
            let pptShapeType = pptx.ShapeType.rect; // 默认矩形

            // 1. 优先使用后端指定的 pptShape (如 'star5', 'triangle')
            if (el.pptShape && pptx.ShapeType[el.pptShape]) {
                pptShapeType = pptx.ShapeType[el.pptShape];
            }
            // 2. 兼容旧逻辑
            else if (el.type === 'ellipse') {
                pptShapeType = pptx.ShapeType.ellipse;
            }

            // 3. 圆角矩形特殊处理
            if (pptShapeType === pptx.ShapeType.rect && el.cornerRadius > 0) {
                pptShapeType = pptx.ShapeType.roundRect;
                const minSide = Math.min(el.w, el.h);
                if (minSide > 0) opts.rectRadius = Math.min(el.cornerRadius / 2 / minSide, 0.5);
            }
            slide.addShape(pptShapeType, opts);
          }
          
          // D. 占位符
          else if (el.type === 'placeholder') {
            const boxOpts = { 
                x:x, y:y, w:w, h:h, rotate: opts.rotate,
                fill: { color: 'F5F5F5', transparency: fillTrans }, 
                line: null 
            };
            let phShape = pptx.ShapeType.rect;
            if (el.cornerRadius > 0) {
                phShape = pptx.ShapeType.roundRect;
                const minSide = Math.min(el.w, el.h);
                if (minSide > 0) boxOpts.rectRadius = Math.min(el.cornerRadius / 2 / minSide, 0.5);
            }
            slide.addShape(phShape, boxOpts);
            slide.addText(el.imageName || 'IMG', { 
              x:x, y:y, w:w, h:h, rotate: opts.rotate,
              fontSize: 10, color: '999999', align: 'center', valign: 'middle',
              fontFace: 'Arial', wrap: false, margin: 0, transparency: fillTrans
            });
          }
        });
      });
      // === 关键修改：不再直接下载，而是存入 ZIP ===
      // pptx.writeFile({ fileName: "Figma-Export.pptx" }); // ❌ 删掉这行
      
      // ✅ 改为写入 Blob 并存入 zip
      pptx.write("blob").then((blob) => {
        if (pptZip) {
          pptZip.file("Figma_Presentation.pptx", blob);
          console.log("PPT 已成功打包进 ZIP");
        }
      }).catch(err => {
        console.error("PPT 生成失败", err);
        alert("PPT 生成失败，请重试");
      });
    }

    // 7. 生成 ZIP (防拦截)
    // 7. 生成 ZIP (防拦截增强版)
    // isAuto: true 代表流程自动触发，false 代表用户点击按钮触发
    function generateAssetsZip(isAuto = false) {
      if (!pptZip) {
        if (!isAuto) alert("资源包数据为空，请重新运行导出流程。");
        return;
      }
      
      const doDownload = () => {
        pptZip.generateAsync({ type: "blob" }).then(function(content) {
          const link = document.createElement('a');
          link.href = URL.createObjectURL(content);
          link.download = "Figma_Export_Package.zip";
          link.click();
          
        });
      };

      if (isAuto) {
        // 自动触发：延时 2500ms，避开浏览器拦截
        setTimeout(doDownload, 1000);
      } else {
        // 手动点击：立即下载 (浏览器绝对放行)
        doDownload();
      }
    }



    // ==========================================
    // Refiner 核心逻辑 (UI 交互 + 业务逻辑)
    // ==========================================
    let allRefinerData = []; // 🔥 新增：存放所有搜索结果的总数据池
    let refinerCache = [];  // 🔥 新增：当前显示的缓存数据池（每次分页展示）
    let findDebounceTimer = null; // 🔥 新增：搜索防抖定时器
    let currentTab = 'lint';  // 🔥 新增：当前选中的 Tab（lint/find）
    const BATCH_SIZE = 50;   // 🔥 配置：每波只显示 50 条，防止卡顿
    
    // --- 1. 初始化 ---
    // 确保页面加载时 UI 状态正确
    setTimeout(() => updateStyleUI(), 100);

    // --- 2. Tab 切换 ---
    function switchRefinerTab(tab) {
        currentTab = tab;
        
        // CSS 类切换
        document.querySelectorAll('.refiner-tab-item').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.refiner-tab-content').forEach(el => el.classList.remove('active'));

        if (tab === 'lint') {
            document.querySelector('[data-key="ref_tab_lint"]').classList.add('active');
            document.getElementById('tabLint').classList.add('active');
        } else {
            document.querySelector('[data-key="ref_tab_find"]').classList.add('active');
            document.getElementById('tabFind').classList.add('active');
            
            // 如果 Find 输入框为空，重置一下界面
            if (document.getElementById('inpFind').value === '') {
                refinerCache = []; 
                const list = document.getElementById('findList');
                if(list) list.innerHTML = `<div class="empty-state-refiner"><div class="es-icon">🔍</div><div class="es-text">${i18n[curLang].ref_empty_find_init}</div></div>`;
            }
        }
        updateHeaderCheckbox(); 
    }

    // --- 3. UI 交互控制 (不能删！) ---
    
    // 单选按钮点击逻辑
    function selectRadio(el, groupName, value) {
        const parent = el.closest('.radio-grid');
        parent.querySelectorAll('.radio-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
        el.dataset.value = value;
    }

    // 多选 chip 切换逻辑
    function toggleTargetChip(el) {
        el.classList.toggle('active');
    }

    // [重要] 命名风格 UI 联动 (互斥逻辑)
    function updateStyleUI() {
        const formatEl = document.querySelector('#lintConfigPage .radio-item[onclick*="format"].active');
        const format = formatEl ? formatEl.dataset.value : 'separator';
        
        const separatorArea = document.getElementById('separatorOptions');
        const radios = separatorArea.querySelectorAll('.radio-item');

        if (format === 'separator') {
            // 启用分隔符区域
            separatorArea.classList.remove('disabled-area');
            radios.forEach(r => r.style.pointerEvents = 'auto');
        } else {
            // 禁用分隔符区域 (变灰、不可点)
            separatorArea.classList.add('disabled-area');
            radios.forEach(r => r.style.pointerEvents = 'none');
        }
    }

    // 按钮 Loading 动画控制
    function setButtonLoading(btnId, isLoading) {
        const btn = document.getElementById(btnId);
        if(!btn) return;
        const txtSpan = btn.querySelector('span');
        
        if(isLoading) {
            btn.classList.add('loading');
            // 根据按钮ID显示不同的 Loading 文案
            if(btnId === 'btnFindStart') txtSpan.innerText = i18n[curLang].ref_status_searching || "Searching...";
            else txtSpan.innerText = i18n[curLang].ref_msg_scan || "Scanning...";
        } else {
            btn.classList.remove('loading');
            const lintTxt = i18n[curLang].btn_start_check || "Start Check";
            const findTxt = i18n[curLang].ref_btn_find_preview || "Find & Preview";
            txtSpan.innerText = (btnId === 'btnFindStart') ? findTxt : lintTxt;
        }
    }

    // --- 4. 智能检查 (Lint) 逻辑 (不能删！) ---

    // [入口] 开始检查
    function startRefinerLint(isManualClick = false) {
        console.log("【1】前端：按钮被点击了，准备发送消息..."); 
        if (isManualClick) {
            setButtonLoading('btnLintStart', true);
        }

        const scopeEl = document.querySelector('#lintConfigPage .radio-item[onclick*="scope"].active');
        const formatEl = document.querySelector('#lintConfigPage .radio-item[onclick*="format"].active');
        const sepEl = document.querySelector('#separatorOptions .radio-item[onclick*="sep"].active');
        const caseEl = document.querySelector('#separatorOptions .radio-item[onclick*="casing"].active');

        const config = {
            mode: 'lint',
            scope: scopeEl ? scopeEl.dataset.value : 'selection',
            
            format: formatEl ? formatEl.dataset.value : 'separator', 
            separator: sepEl ? sepEl.dataset.value : 'space',        
            casing: caseEl ? caseEl.dataset.value : 'lower',          
            
            trim: document.getElementById('opt_trim').checked,
            emoji: document.getElementById('opt_emoji').checked,
            removeId: document.getElementById('opt_id').checked,
            unmarkHidden: document.getElementById('opt_unmark_hidden').checked,
            
            targetTypes: {
                compName: document.getElementById('target_comp_name').checked,
                propName: document.getElementById('target_prop_name').checked,
                propValue: document.getElementById('target_prop_value').checked
            }
        };

        setTimeout(() => {
            postMsg('lint-variants', config);
        }, 50);
    }


    // --- 5. 查找替换 (Find) 逻辑 (不能删！) ---


    // ==========================================
    // 查找功能修复 (UI.HTML Script)
    // ==========================================

    // Tag 切换 (确保 active 类名能正确切换)
    function toggleChip(el) {
        el.classList.toggle('active');
        if(currentTab === 'find') updateReplacePreview();
    }

    // [入口] 开始查找 (修复变量缺失 bug)
    function startFindRefiner(isManualClick = false) {
        console.log("【前端】点击了查找按钮..."); 

        const findText = document.getElementById('inpFind').value;
        
        // 校验 1: 必须输入查找词
        if (!findText && isManualClick) {
            alert("请输入要查找的内容");
            return;
        }

        if(isManualClick) setButtonLoading('btnFindStart', true);

        // 收集基础配置
        const isSelection = document.getElementById('fScopeSel').classList.contains('active');
        const isCase = document.getElementById('btnCase').classList.contains('active');
        const isWhole = document.getElementById('btnWhole').classList.contains('active');
        
        // 🔥 关键修复：获取两个 Checkbox 的 DOM 元素
        const markHiddenEl = document.getElementById('opt_mark_hidden_find');
        const unmarkHiddenEl = document.getElementById('opt_unmark_hidden_find');

        const config = {
            mode: 'find',
            scope: isSelection ? 'selection' : 'page',
            findText: findText,
            replaceText: document.getElementById('inpRep').value || '', 
            caseSensitive: isCase,
            wholeWord: isWhole,
            
            // 🔥 关键修复：正确读取选中状态 (防止变量未定义报错)
            markHidden: markHiddenEl ? markHiddenEl.checked : false,
            unmarkHidden: unmarkHiddenEl ? unmarkHiddenEl.checked : false,
            
            targets: []
        };
        
        // 收集搜索目标
        document.querySelectorAll('.chip-check.active').forEach(el => {
            if (el.dataset.target) config.targets.push(el.dataset.target);
        });
        
        // 校验 2: 必须至少选一个搜索目标
        if (config.targets.length === 0) {
             if(isManualClick) { 
                 setButtonLoading('btnFindStart', false);
                 alert("请至少选择一个搜索目标 (Prop Name 或 Prop Value)");
             }
             return;
        }

        console.log("【前端】发送查找请求:", config);
        
        // 重置数据池，准备接收新数据
        allRefinerData = [];
        refinerCache = [];
        
        postMsg('lint-variants', config);
    }

    // 废弃旧的实时预览函数 (保留空函数防止报错)
    function updateReplacePreview() { return; }

    // --- 6. 渲染与结果处理 (核心引擎 - 绝对不能删！) ---

    const RENDER_LIMIT = 100; 

    // [回调] 接收后端数据
    function renderRefinerResults(results) {
        setButtonLoading('btnLintStart', false);
        setButtonLoading('btnFindStart', false);
        
        // 1. 将所有结果存入总池子，并初始化选中状态
        allRefinerData = results.map((item, idx) => ({
            ...item,
            _uniqueId: idx, // 给个唯一ID方便查找
            _selected: true 
        }));

        // 2. 根据当前 Tab 决定如何显示
        if (currentTab === 'lint') {
            // Lint 模式通常数量不多，或者沿用旧逻辑，这里为了统一，也可以用分页
            // 但 Lint 模式建议一次性显示（如果很多可以考虑分页，这里暂按全部显示处理）
            document.getElementById('lintConfigPage').style.display = 'none';
            document.getElementById('lintResultsWrapper').style.display = 'flex';
            // 🔥🔥🔥 修复逻辑开始：处理 0 结果的情况 🔥🔥🔥
            if (results.length === 0) {
                // A. 如果结果为 0：显示缺省页，隐藏列表和按钮
                document.getElementById('lintList').style.display = 'none';
                document.getElementById('lintFooter').style.display = 'none';
                
                // 显示“太棒了”缺省页
                const emptyEl = document.getElementById('lintEmpty');
                if (emptyEl) {
                    emptyEl.style.display = 'flex';
                    // 动态更新文案（可选）
                    const textEl = emptyEl.querySelector('.es-text');
                    if(textEl) textEl.innerText = "太棒了！未发现需要修复的组件命名";
                }
                
                // 更新计数
                document.getElementById('lintCount').innerText = "0";
                
            } else {
                // B. 如果有结果：显示列表和按钮，隐藏缺省页
                document.getElementById('lintList').style.display = 'block';
                document.getElementById('lintFooter').style.display = 'flex';
                const emptyEl = document.getElementById('lintEmpty');
                if (emptyEl) emptyEl.style.display = 'none';
                
                // 执行渲染
                renderBatch(document.getElementById('lintList'), true); 
            }
            // 🔥🔥🔥 修复逻辑结束 🔥🔥🔥
        } else {
            // --- Find 模式逻辑 (🔥 重点修复这里) ---
            const listEl = document.getElementById('findList');
            const footerEl = document.getElementById('findFooter');
            const headerEl = document.getElementById('findListHeader');
            const countEl = document.getElementById('findCount');

            // 1. 无论有无结果，先强制显示列表容器 (修复白屏问题的关键!)
            listEl.style.display = 'block'; 
            
            // 2. 隐藏之前的成功状态 (如果有)
            const successEl = document.getElementById('lintSuccess');
            if(successEl) successEl.style.display = 'none';

            if (results.length === 0) {
                // A. 无结果
                headerEl.style.display = 'none';
                listEl.innerHTML = `<div class="empty-state-refiner"><div class="es-icon">🔍</div><div class="es-text">未找到匹配项</div></div>`;
                if(countEl) countEl.innerText = "0";
                footerEl.style.display = 'none';
            } else {
                // B. 有结果
                headerEl.style.display = 'flex'; // 显示头部
                footerEl.style.display = 'flex'; // 显示底部按钮
                
                // 执行渲染
                renderBatch(listEl, false);
            }
        }
    }

    // [核心] 分批渲染函数
    function renderBatch(container, showAll = false) {
        container.innerHTML = '';
        
        // 1. 截取当前批次的数据
        const total = allRefinerData.length;
        // 如果是 Find 模式，只取前 BATCH_SIZE 个；如果是 Lint 模式，取全部
        const limit = showAll ? total : BATCH_SIZE; 
        
        // refinerCache 现在只代表“当前屏幕上显示的这波数据”
        refinerCache = allRefinerData.slice(0, limit);
        
        const displayCount = refinerCache.length;
        const remaining = total - displayCount;

        // 2. 更新头部计数 (显示：当前显示 / 总数)
        const countId = currentTab === 'lint' ? 'lintCount' : 'findCount';
        const countEl = document.getElementById(countId);
        if(countEl) {
            if (remaining > 0) {
                countEl.innerText = `${displayCount} / ${total}`; // 例如: 50 / 1200
            } else {
                countEl.innerText = total;
            }
        }

        // 3. 渲染列表
        renderTree(refinerCache, container);

        // 4. 如果还有剩余，在底部显示提示
        if (remaining > 0 && !showAll) {
            const tip = document.createElement('div');
            tip.className = 'limit-warning';
            tip.style.marginTop = '10px';
            tip.innerHTML = `⚡️ 为防止卡顿，仅显示前 <b>${displayCount}</b> 项。处理完这波后，会自动加载剩余的 <b>${remaining}</b> 项。`;
            container.appendChild(tip);
        }
        
        updateHeaderCheckbox();
    }
        
    // [定位] 专用跳转函数 (支持高亮)
    function locateItem(id, keyword = null) {
        if (event) event.stopPropagation();
        
        // 发送消息给后端，带上 keyword
        postMsg('locate-node', { 
            id: id, 
            highlight: keyword // 告诉后端需要高亮这个词
        });
    }
    // 挂载到 window 确保 HTML 能访问
    window.locateItem = locateItem;
    
    // [渲染] 生成列表 HTML (分组版)
    function renderTree(allItems, container) {
        container.innerHTML = '';

        const displayItems = allItems.slice(0, RENDER_LIMIT);
        const hiddenCount = allItems.length - displayItems.length;

        // 1. 按组件 ID 分组
        const groups = {};
        displayItems.forEach(item => {
            if (!groups[item.compId]) groups[item.compId] = { name: item.compName, items: [] };
            groups[item.compId].items.push(item);
        });

        let html = '';
        
        if (hiddenCount > 0) {
            html += `<div class="limit-warning">⚡️ 仅显示前 ${RENDER_LIMIT} 项，但“全选”对全部 ${allItems.length} 项生效。</div>`;
        }

        Object.keys(groups).forEach(compId => {
            const group = groups[compId];
            
            // --- 2. 内部再细分：分类 bucket ---
            const buckets = {
                CompName: [],    // 组件/集合命名
                PropName: [],    // 变体属性值
                PropValue: []    // 变体属性值
            };

            // 🔥🔥🔥 新增逻辑：获取该组的组件类型 🔥🔥🔥
            // 我们取该组第一个数据的 type 属性来判断
            const groupType = group.items[0].type; 
            
            // 根据类型决定图标：
            // 组件集(变体) -> ❖ (四个菱形)
            // 独立组件 -> ◆ (单个菱形)
            const iconSymbol = groupType === 'COMPONENT_SET' ? '❖' : '◆';
            const iconColor  = groupType === 'COMPONENT_SET' ? '#7B61FF' : '#7B61FF'; // 变体紫，组件蓝(可选)
            // ------------------------------------------

            group.items.forEach(item => {
                // 根据后端返回的 targetType 分类
                if (buckets[item.targetType]) {
                    buckets[item.targetType].push(item);
                } else {
                    buckets.PropValue.push(item);
                }
            });

            // --- 3. 开始构建 HTML ---
            html += `
            <div class="comp-group expanded">
                <div class="comp-header" onclick="this.parentElement.classList.toggle('expanded')">
                    <div class="comp-info" style="color: ${iconColor};">
                        <span class="comp-arrow" style="color: #9e9e9e">▶</span>
                        <span style="margin-right:4px; font-size:14px;">${iconSymbol}</span>
                        ${group.name}
                    </div>
                    <!-- 头部定位按钮 -->
                    <button class="btn-locate" onclick="locateItem('${compId}')">⌖</button>
                </div>
                <div class="comp-details">`;

            // 辅助函数：生成列表项 HTML
            const renderRows = (items) => {
                return items.map(item => `
                 <div class="diff-item">
                    <input type="checkbox" class="diff-cb" 
                        ${item._selected ? 'checked' : ''} 
                        onchange="updateItemSelection(${item._index}, this.checked)"
                    >
                    <div class="txt-wrapper" 
                         title="点击定位: ${item.oldVal} -> ${item.newVal}"
                         onclick="locateItem('${item.id}')" 
                         style="cursor: pointer;"> 
                         
                        
                        <span class="txt-old">${item.targetType === 'PropValue' ? item.propName + ': ' : ''}${item.oldVal}</span>
                        <span class="txt-arrow">→</span>
                        <span class="txt-new">${item.newVal}</span>
                    </div>
                 </div>`).join('');
            };

            // A. 渲染组件名组
            if (buckets.CompName.length > 0) {
                html += `<div class="detail-category">
                            <span>Component Name</span>
                            <span class="cat-badge">${buckets.CompName.length}</span>
                         </div>`;
                html += renderRows(buckets.CompName);
            }

            // B. 渲染属性组
            if (buckets.PropName.length > 0) {
                html += `<div class="detail-category">
                            <span>Property Name</span>
                            <span class="cat-badge">${buckets.PropName.length}</span>
                         </div>`;
                html += renderRows(buckets.PropName);
            }

            // C. 渲染属性值组
            if (buckets.PropValue.length > 0) {
                html += `<div class="detail-category">
                            <span>Property Value</span>
                            <span class="cat-badge">${buckets.PropValue.length}</span>
                         </div>`;
                html += renderRows(buckets.PropValue);
            }

            html += `</div></div>`;
        });

        if (hiddenCount > 0) {
            html += `<div style="padding:10px; text-align:center; color:#999; font-size:11px;">... 还有 ${hiddenCount} 项未显示 ...</div>`;
        }

        container.innerHTML = html;
        updateHeaderCheckbox(); 
    }

    // 更新单个选中状态
    function updateItemSelection(idx, checked) {
        if (refinerCache[idx]) refinerCache[idx]._selected = checked;
        updateHeaderCheckbox();
    }

    // 更新头部全选框 UI
    function updateHeaderCheckbox() {
        const isAll = refinerCache.length > 0 && refinerCache.every(i => i._selected);
        const headerCb = document.getElementById(currentTab === 'lint' ? 'lintSelectAll' : 'findSelectAll');
        if (headerCb) headerCb.checked = isAll;
        
        const count = refinerCache.filter(i => i._selected).length;
        const btn = document.querySelector(currentTab === 'lint' ? '#lintFooter .btn-act' : '#btnRepChecked');
        if (btn) {
            btn.disabled = count === 0;
            // 🔥 获取当前语言的文本
            const t = i18n[curLang];
            const text = t.btn_rep_selected || "Replace Selected"; // "修复选中项"
            
            // 动态更新按钮文字
            btn.innerText = count > 0 ? `${text} (${count})` : text;
        }
    }

    // 全选逻辑
    function toggleSelectAll(tab, checked) {
        refinerCache.forEach(item => item._selected = checked);
        const list = document.getElementById(tab === 'lint' ? 'lintList' : 'findList');
        if(list) list.querySelectorAll('.diff-cb').forEach(cb => cb.checked = checked);
        updateHeaderCheckbox();
    }

    // Find Panel Scope 切换
    function toggleFindScope(scope) {
        document.getElementById('fScopeSel').classList.toggle('active', scope === 'selection');
        document.getElementById('fScopePage').classList.toggle('active', scope === 'page');
        updateReplacePreview();
    }

    // ==========================================
    // 修复逻辑 (UI 显示修正版)
    // ==========================================
    
    // [操作] 修复选中项 (UI 修正版)
    function fixRefiner(mode) {
        // 1. 获取选中项（基于当前显示的 refinerCache）
        const itemsToFix = refinerCache.filter(i => i._selected);
        if (itemsToFix.length === 0) return alert("请至少选择一项");

        // 2. 发送指令给后端
        postMsg('fix-variants', { items: itemsToFix });

        // 3. 更新数据池（从总数据中剔除已修复的）
        // 如果你还没引入 allRefinerData，这里会降级使用 refinerCache
        if (typeof allRefinerData !== 'undefined') {
            const fixedIds = new Set(itemsToFix.map(i => i._uniqueId));
            allRefinerData = allRefinerData.filter(item => !fixedIds.has(item._uniqueId));
            // 重新计算剩余项
            const remainingTotal = allRefinerData.length;
            if (remainingTotal > 0) {
                 // 如果还有下一波数据，直接渲染下一波，不显示成功页
                 renderRefinerResults(allRefinerData);
                 return; 
            }
        }
        
        // --- 走到这里说明：当前列表（或总数据）已全部修完 ---

        if (currentTab === 'lint') {
            const wrapper = document.getElementById('lintResultsWrapper');
            if (wrapper) {
                // A. 暴力隐藏 wrapper 下的所有直接子元素 (Header, List, Footer, Empty...)
                Array.from(wrapper.children).forEach(child => child.style.display = 'none');
                
                // B. 独独显示 Success 页
                const successEl = document.getElementById('lintSuccess');
                if (successEl) {
                    successEl.style.display = 'flex';
                } else {
                    console.error("找不到 id=lintSuccess 的元素，请检查 HTML");
                }
            }
        } else {
            // 🔥🔥🔥 Find 模式：显示专用的成功页 🔥🔥🔥
            
            // 1. 隐藏列表相关元素
            document.getElementById('findListHeader').style.display = 'none';
            document.getElementById('findList').style.display = 'none';
            document.getElementById('findFooter').style.display = 'none';
            
            // 2. 显示 Find 专用成功页
            const findSuccessEl = document.getElementById('findSuccess');
            if (findSuccessEl) {
                findSuccessEl.style.display = 'flex';
                // 更新数量
                document.getElementById('findSuccessCount').innerText = itemsToFix.length;
            }
        }
    }

    // [操作] 继续加载下一波
    function continueAfterFix() {
        // 隐藏成功页
        document.getElementById('lintSuccess').style.display = 'none';
        
        // 恢复列表显示
        if (currentTab === 'find') {
            document.getElementById('findListHeader').style.display = 'flex';
            document.getElementById('findList').style.display = 'block';
            document.getElementById('findFooter').style.display = 'flex';
        } else {
            document.getElementById('lintResultsWrapper').style.display = 'flex';
        }

        // 检查总池子是否还有数据
        if (allRefinerData.length > 0) {
            // 🔥 重新渲染下一波 (自动取 allRefinerData 的前 50 个)
            const container = currentTab === 'lint' ? document.getElementById('lintList') : document.getElementById('findList');
            const isLint = currentTab === 'lint';
            renderBatch(container, isLint); 
        } else {
            // 彻底没了，显示空状态或返回
            if (currentTab === 'find') {
                document.getElementById('findList').innerHTML = `<div class="empty-state-refiner"><div class="es-icon">🎉</div><div class="es-text">所有匹配项已处理完毕！</div></div>`;
                document.getElementById('findCount').innerText = "0";
                document.getElementById('findFooter').style.display = 'none';
            } else {
                resetLintList();
            }
        }
    }
        
    // [操作] 重置/返回配置页 (最终版)
    function resetLintList() {
        // 1. 切换回配置页
        document.getElementById('lintConfigPage').style.display = 'flex';
        document.getElementById('lintResultsWrapper').style.display = 'none';
        
        // 2. 彻底重置所有子元素的显示状态
        const wrapper = document.getElementById('lintResultsWrapper');
        if (wrapper) {
            Array.from(wrapper.children).forEach(child => {
                // 恢复所有子元素的默认显示
                if (child.id === 'lintList' || child.id === 'findList') {
                    child.style.display = 'block';
                } else if (child.classList.contains('res-header') || child.classList.contains('res-footer')) {
                    child.style.display = 'flex';
                } else {
                    // 隐藏缺省页和成功页
                    child.style.display = 'none';
                }
            });
            // 确保 wrapper 本身是隐藏的
            wrapper.style.display = 'none';
        }

        // 3. 清理数据
        document.getElementById('lintList').innerHTML = '';
        document.getElementById('lintCount').innerText = '0';
        
        setButtonLoading('btnLintStart', false);

        // 🔥 关键：确保所有数据池都清空
        allRefinerData = [];
        refinerCache = [];
    }
    
    // ==========================================
    // 7. 补全遗漏的 UI 辅助函数 (必须保留！)
    // ==========================================

    // 2. 查找面板折叠/展开控制
    function toggleFindHeader(expand) {
        const controls = document.getElementById('findControlsExpanded');
        const summary = document.getElementById('findSummaryBar');
        
        if (expand) {
            // 展开状态
            controls.style.display = '';
            summary.style.display = 'none'; // 隐藏摘要条
        } else {
            // 折叠状态
            controls.style.display = 'none';
            summary.style.display = 'flex'; // 显示摘要条
            
            // 更新摘要条文字 (显示当前查找词)
            const keyword = document.getElementById('inpFind').value;
            const summarySpan = summary.querySelector('span');
            if (summarySpan) {
                summarySpan.innerText = keyword ? `查找: "${keyword}"` : "点击展开配置";
            }
        }
    }

    // [兼容] Footer 状态更新别名
    // 防止 HTML 中有旧的 onclick="updateFindFooterState()" 调用导致报错
    function updateFindFooterState() {
        updateHeaderCheckbox(); 
    }

    // 1. 处理隐藏选项的互斥逻辑 (二选一)
    function handleExclusiveFindOptions(type) {
        const markEl = document.getElementById('opt_mark_hidden_find');
        const unmarkEl = document.getElementById('opt_unmark_hidden_find');
        
        if (type === 'mark') {
            // 如果勾选了“标记”，则取消“清除”
            if (markEl.checked) unmarkEl.checked = false;
        } else if (type === 'unmark') {
            // 如果勾选了“清除”，则取消“标记”
            if (unmarkEl.checked) markEl.checked = false;
        }
        // 由于取消了实时预览，这里不需要调用 updateReplacePreview
    }
 
    // [操作] 查找替换 - 继续查找 (重置状态)
    function resetFindState() {
        // 1. 隐藏成功页
        const successEl = document.getElementById('findSuccess');
        if (successEl) successEl.style.display = 'none';
        
        // 2. 展开顶部的搜索配置 (关键体验优化)
        toggleFindHeader(true);
        
        // 3. 恢复列表区域的默认状态
        const list = document.getElementById('findList');
        list.style.display = 'block';
        // 显示初始空状态
        list.innerHTML = `<div class="empty-state-refiner"><div class="es-icon">🔍</div><div class="es-text">输入关键词预览修改效果</div></div>`;
        
        // 4. 恢复底部按钮显示 (虽然是禁用状态)
        const footer = document.getElementById('findFooter');
        footer.style.display = 'flex';
        const btn = document.getElementById('btnRepChecked');
        btn.disabled = true;
        btn.innerText = "Replace Selected";
        
        // 5. 隐藏结果头部 (Result 0)
        document.getElementById('findListHeader').style.display = 'none';
        
        // 6. 清空数据缓存
        allRefinerData = [];
        refinerCache = [];
    }

    // =============================================================================
    // TEXT TOOLS LOGIC (文字查找替换 - 升级版)
    // =============================================================================
    
    let textResultCache = []; // 缓存查找结果

    // 1. 切换查找范围
    function toggleTextScope(scope) {
        document.getElementById('tScopeSel').classList.toggle('active', scope === 'selection');
        document.getElementById('tScopePage').classList.toggle('active', scope === 'page');
    }

    // 2. 智能折叠/展开控制
    // 参数 forceState: true(展开), false(折叠), undefined(切换)
    function toggleTextHeader(forceState) {
        const header = document.getElementById('textPanelHeader');
        const content = document.getElementById('textControlsContent');
        const titleEl = document.getElementById('txtHeaderTitle');
        const findInput = document.getElementById('txtFindInput');
        
        // 获取当前语言包 (关键步骤)
        const t = i18n[curLang]; 

        // 判断当前状态
        const isCurrentlyExpanded = header.classList.contains('expanded');
        
        // 决定目标状态
        let shouldExpand;
        if (typeof forceState !== 'undefined') {
            shouldExpand = forceState;
        } else {
            shouldExpand = !isCurrentlyExpanded; // 没传参数则取反（点击切换）
        }

        if (shouldExpand) {
            // ---> 展开状态
            content.style.display = 'block';
            header.classList.add('expanded');
            
            // 🔥 修复：读取变量 t.txt_title_config
            titleEl.innerHTML = t.txt_title_config || "查找配置"; 
            titleEl.classList.remove('search-status-text');
            
        } else {
            // ---> 折叠状态
            content.style.display = 'none';
            header.classList.remove('expanded');
            
            // 标题显示为“查找: xxx”
            const val = findInput.value;
            if (val) {
                // 🔥 修复：读取变量 t.txt_prefix_find
                const prefix = t.txt_prefix_find || "查找";
                titleEl.innerHTML = `${prefix}: "${val}"`;
                titleEl.classList.add('search-status-text');
            } else {
                // 🔥 修复：读取变量 t.txt_expand
                titleEl.innerHTML = t.txt_expand;
                titleEl.classList.remove('search-status-text');
            }
        }
    }

    // 3. 开始查找 (修复版)
    function startTextFind() {
        const findInput = document.getElementById('txtFindInput');
        const findText = findInput.value;
        const t = i18n[curLang] || i18n['zh'];

        if (!findText) {
            alert(t.txt_err_no_input || "请输入查找内容");
            findInput.focus();
            return;
        }
        
        saveFindHistory(findText);
        
        const isSelection = document.getElementById('tScopeSel').classList.contains('active');
        const btn = document.getElementById('btnTextFind');
        
        if (btn) {
            btn.classList.add('loading');
            const span = btn.querySelector('span');
            if(span) span.innerText = t.txt_btn_finding || "搜索中...";
        }

        parent.postMessage({ 
            pluginMessage: { 
                type: 'text-find-matches', 
                scope: isSelection ? 'selection' : 'page',
                findText: findText
            } 
        }, '*');
        
        toggleTextHeader(false);
    }
    
    function saveFindHistory(text) {
        if (!text || text.trim().length === 0) return;
        let history = PersistentCache.get('find_history') || [];
        history = history.filter(item => item !== text);
        history.unshift(text);
        history = history.slice(0, 10);
        PersistentCache.set('find_history', history);
    }
    
    function getFindHistory() {
        return PersistentCache.get('find_history') || [];
    }
    
    // 4. 重置函数 (也要更新一下，确保重置后展开)
    function resetTextFind(e) {
        if(e) e.stopPropagation(); // 阻止冒泡，防止触发折叠
        
        document.getElementById('txtFindInput').value = '';
        document.getElementById('txtRepInput').value = '';
        
        // 恢复初始 UI：展开面板，隐藏结果
        toggleTextHeader(true);
        document.getElementById('textResultWrapper').style.display = 'none';
        document.getElementById('textFooter').style.display = 'none';
        document.getElementById('textEmptyState').style.display = 'flex';
        
        // 清空缓存数据
        textResultCache = [];
    }
    function renderTextFindResults(results) {
        // 1. 停止 Loading
        const btn = document.getElementById('btnTextFind');
        if (btn) {
            btn.classList.remove('loading');
            const span = btn.querySelector('span');
            // 安全读取翻译
            const t = (typeof i18n !== 'undefined' && i18n[curLang]) ? i18n[curLang] : {};
            if(span) span.innerText = t.txt_btn_find || "开始查找";
        }

        // 2. 处理数据
        textResultCache = results.map((item, i) => ({
            ...item, 
            uid: `match_${item.id}_${item.index}_${i}`, 
            _selected: false,
            _done: false
        }));
        
        const total = results.length;
        
        // 3. 控制显隐
        const emptyState = document.getElementById('textEmptyState');
        const resultWrapper = document.getElementById('textResultWrapper');
        const footer = document.getElementById('textFooter');
        
        if (!emptyState || !resultWrapper || !footer) {
            console.error('[TextFind] 关键元素缺失!');
            return;
        }
        
        emptyState.style.display = total === 0 ? 'flex' : 'none';
        resultWrapper.style.display = total === 0 ? 'none' : 'flex';
        footer.style.display = total === 0 ? 'none' : 'flex';
        
        if (total === 0) {
            const t = (typeof i18n !== 'undefined' && i18n[curLang]) ? i18n[curLang] : {};
            emptyState.querySelector('.es-text').innerText = t.txt_empty_none || "未找到匹配内容";
            return;
        }

        // 4. 折叠头部 & 更新计数
        toggleTextHeader(false);
        
        const textCountEl = document.getElementById('textCount');
        if (textCountEl) {
            textCountEl.innerText = total;
        }
        
        const selectAllEl = document.getElementById('textSelectAll');
        if (selectAllEl) {
            selectAllEl.checked = false;
        }
        
        updateTextFooterBtn();

        // 5. 渲染列表
        const container = document.getElementById('textResultList');
        if (!container) return;
        container.innerHTML = '';

        textResultCache.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'text-result-row'; 
            div.id = `row_${item.uid}`;
            
            // 预览文字处理
            const fullTxt = item.fullText || "";
            const start = item.index;
            const len = item.length;
            const preLen = 15; 
            const postLen = 30;
            
            let previewStart = Math.max(0, start - preLen);
            let previewEnd = Math.min(fullTxt.length, start + len + postLen);
            
            let prefix = (previewStart > 0 ? "..." : "") + fullTxt.substring(previewStart, start);
            let highlight = fullTxt.substring(start, start + len);
            let suffix = fullTxt.substring(start + len, previewEnd) + (previewEnd < fullTxt.length ? "..." : "");

            const escape = (s) => s ? s.replace(/</g, "&lt;").replace(/>/g, "&gt;") : "";

            div.innerHTML = `
                <input type="checkbox" class="row-cb" id="cb_${item.uid}" onchange="updateTextSingleSelect(${index}, this.checked)">
                
                <div class="text-row-content" onclick="locateItemExact('${item.id}', ${item.index}, ${item.length}, '${item.uid}')" title="点击定位">
                    <div class="text-preview-main">
                       ${escape(prefix)}<span class="hl-text">${escape(highlight)}</span>${escape(suffix)}
                    </div>
                </div>
                
                <button class="btn-row-replace" id="btn_${item.uid}" onclick="runSingleTextReplace(${index})">
                    替换
                </button>
            `;
            container.appendChild(div);
        });
    }
    // 在 JS 区域添加/修改：

    // 1. [新增] 清除所有高亮
    function clearAllHighlights(e) {
        if(e) e.stopPropagation();
        postMsg('clear-all-highlights');
    }

    // 2. [修改] 定位函数 - 现在的行为是 Toggle
    function locateItemExact(id, index, length, uid) {
        if (event) event.stopPropagation();
        
        // 记录一下当前的 UID，方便回调时通过 key 找不到 DOM 时备用（虽然 key 更准）
        // 这里主要发给后端
        postMsg('locate-node', { id, index, length });
    }


    // [修复Bug 3] 全选逻辑：必须同步 DOM 的 checked 状态
    function toggleTextSelectAll(checked) {
        // 1. 更新数据缓存
        textResultCache.forEach(i => {
            if (!i._done) i._selected = checked; // 只选中未完成的
        });
        
        // 2. 同步 DOM Checkbox
        const cbs = document.querySelectorAll('#textResultList .row-cb');
        cbs.forEach(cb => {
            if (!cb.disabled) cb.checked = checked;
        });
        
        updateTextFooterBtn();
    }

    // 单选更新
    function updateTextSingleSelect(index, checked) {
        textResultCache[index]._selected = checked;
        
        // 检查是否全选（排除已禁用的）
        const activeItems = textResultCache.filter(i => !i._done);
        const allChecked = activeItems.length > 0 && activeItems.every(i => i._selected);
        document.getElementById('textSelectAll').checked = allChecked;
        
        updateTextFooterBtn();
    }

    // 更新底部按钮
    function updateTextFooterBtn() {
        const t = i18n[curLang]; // 获取当前语言包
        const count = textResultCache.filter(i => i._selected && !i._done).length;
        const btn = document.getElementById('btnTextBatchRep');
        if (!btn) return;
        btn.disabled = count === 0;
        // 动态拼接: "Replace Selected (N)"
        const text = count > 0 ? `${t.txt_btn_rep_batch} (${count})` : t.txt_btn_rep_batch;
        btn.textContent = text;
    }

    // [核心] 执行替换 (单项或批量)
    // 统一封装，mode = 'single' | 'batch'
    function runTextReplaceCommon(tasks) {
        const repText = document.getElementById('txtRepInput').value;
        if (tasks.length === 0) return;

        // 发送给后端
        parent.postMessage({ 
            pluginMessage: { 
                type: 'text-replace-batch', 
                tasks: tasks, // [{id, index, length, uid}, ...]
                replaceText: repText
            } 
        }, '*');
    }

    // 单项替换入口
    function runSingleTextReplace(index) {
        const item = textResultCache[index];
        if (!item || item._done) return;
        runTextReplaceCommon([item]);
    }

    // 批量替换入口
    function runBatchTextReplace() {
        const selectedItems = textResultCache.filter(i => i._selected && !i._done);
        runTextReplaceCommon(selectedItems);
    }

    // ==========================================
    // Smart Fill 逻辑模块
    // ==========================================
    
    // 存储每个类型的标签选中状态 { 'name': ['cn'], 'gender': ['male', 'female'] }
    let activeTagsMap = {}; 

    function rand(min, max) { 
        return Math.floor(Math.random() * (max - min + 1)) + min; 
    }

     // 精简版中国省市区数据 (按需扩充)
    const chinaAreaData = {
        "北京市": { "北京市": ["东城区", "西城区", "朝阳区", "海淀区", "丰台区"] },
   
    };

    // --- 数据源定义 ---
    const basicDataTypes = [
      // 姓名 (Tag: AI生成)
      { 
        key: 'name', label: '姓名', 
        allowAI: true,
        tags: [ {l:'中文', v:'cn'}, {l:'英文', v:'en'} ],
        gen: (tags) => {
            // 示例：根据标签判断生成什么
            const useEn = tags.includes('en');
            const useCn = tags.includes('cn') || tags.length === 0; // 默认中文
            
            // 如果都选了，随机混合
            if(useEn && useCn) return Math.random()>0.5 ? getRandomNameCN() : getRandomNameEN();
            if(useEn) return getRandomNameEN();
            return getRandomNameCN();
        }
      },
      
      // 地址 (Tag: AI生成)
      { 
        key: 'address', label: '地址', 
        allowAI: true,
        gen: (tags) => {
            const list = [
              "北京市朝阳区建国路88号",
             
            ];
            return list[Math.floor(Math.random()*list.length)];
        } 
      },

      // 省市区 (重构版)
      { 
        key: 'province', label: '省市区', 
        // 定义 Tags
        tags: [ 
            {l:'省', v:'prov'}, 
            {l:'市', v:'city'}, 
            {l:'区', v:'area'} 
        ],
        gen: (tags) => {
            // 1. 随机选一个省
            const provs = Object.keys(chinaAreaData);
            const p = provs[Math.floor(Math.random() * provs.length)];
            
            // 2. 根据省选市
            const cities = Object.keys(chinaAreaData[p]);
            const c = cities[Math.floor(Math.random() * cities.length)];
            
            // 3. 根据市选区
            const areas = chinaAreaData[p][c];
            const a = areas[Math.floor(Math.random() * areas.length)];
            
            // 4. 根据 Tags 拼接结果
            // 如果用户一个都没选，默认全显示
            const showP = tags.includes('prov') || tags.length === 0;
            const showC = tags.includes('city') || tags.length === 0;
            const showA = tags.includes('area') || tags.length === 0;
            
            let res = "";
            if (showP) {
                // 特殊处理直辖市：北京/上海的省名和市名一样，如果同时显示，可以去重
                if (p === c && showC) {
                    res += p; // 只显示一次 "北京市"
                } else {
                    res += p;
                }
            }
            
            if (showC) {
                // 如果刚刚没显示过市名（非直辖市，或者直辖市但没勾选省），则显示
                if (!(p === c && showP)) {
                    res += c;
                }
            }
            
            if (showA) res += a;
            
            return res;
        } 
      },

      // 街道 (Street)
      {
        key: 'street', label: '街道', allowAI: true,
        gen: () => {
            const roadNames = ["人民"];
            const suffixes = ["路"];
            const road = roadNames[Math.floor(Math.random() * roadNames.length)];
            const suffix = suffixes[Math.floor(Math.random() * suffixes.length)];
            const num = Math.floor(Math.random() * 900) + 1; // 1-900号
            return `${road}${suffix}${num}号`;
        }
      },

      // 小区 (Community)
      {
        key: 'community', label: '小区', allowAI: true,
        gen: () => {
            const prefix = ["阳光"];
            const suffix = ["花园"];
            const p = prefix[Math.floor(Math.random() * prefix.length)];
            const s = suffix[Math.floor(Math.random() * suffix.length)];
            
            // 随机生成楼栋房号
            const build = Math.floor(Math.random() * 20) + 1;
            const unit = Math.floor(Math.random() * 4) + 1;
            const room = (Math.floor(Math.random() * 20) + 1) * 100 + Math.floor(Math.random() * 4) + 1;
            
            return `${p}${s}${build}栋${unit}单元${room}室`;
        }
      },
      
      // 数字 (Tag: AI生成)
      { 
        key: 'number', label: '数字', hasSetting: true, 
        gen: (tags) => {
            const s = smartSettings.number;
            let val = Math.random() * (s.max - s.min) + s.min;
            // 处理小数
            if (s.decimals === 0) val = Math.floor(val);
            else val = val.toFixed(s.decimals);
            
            // 处理千分位
            if (s.thousands) {
                return Number(val).toLocaleString('en-US', {minimumFractionDigits: s.decimals});
            }
            return val.toString();
        } 
      },
      
      // 日期 (格式化)
      { 
        key: 'date', label: '日期', hasSetting: true,
        gen: () => {
            const fmt = smartSettings.date.format;
            const start = new Date(smartSettings.date.start || '2020-01-01').getTime();
            const end = new Date(smartSettings.date.end || '2025-12-31').getTime();
            const d = new Date(start + Math.random() * (end - start));
            
            const y = d.getFullYear();
            const m = (d.getMonth()+1).toString().padStart(2,'0');
            const day = d.getDate().toString().padStart(2,'0');
            const dayNoPad = d.getDate().toString();
            const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
            const monthShort = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            const mmm = monthShort[d.getMonth()];
            const mmmm = monthNames[d.getMonth()];
            
            let result = fmt;
            result = result.replace('MMMM', mmmm);
            result = result.replace('MMM', mmm);
            result = result.replace('YYYY', y);
            result = result.replace('MM', m);
            result = result.replace('DD', day);
            result = result.replace('D', dayNoPad);
            
            return result;
        } 
      },
      
      // 时间 (格式化)
      {
        key: 'time', label: '时间', hasSetting: true,
        gen: () => {
            const fmt = smartSettings.time.format;
            const parseTime = (str) => {
                const parts = str.split(':');
                return parseInt(parts[0])*3600 + parseInt(parts[1])*60 + (parseInt(parts[2]) || 0);
            };
            const start = parseTime(smartSettings.time.start || '00:00:00');
            const end = parseTime(smartSettings.time.end || '23:59:59');
            
            let totalSeconds = Math.floor(start + Math.random() * (end - start));
            const h = Math.floor(totalSeconds / 3600).toString().padStart(2,'0');
            totalSeconds %= 3600;
            const m = Math.floor(totalSeconds / 60).toString().padStart(2,'0');
            const s = (totalSeconds % 60).toString().padStart(2,'0');
            
            if(fmt === 'HH:mm:ss') return `${h}:${m}:${s}`;
            if(fmt === 'HH:mm') return `${h}:${m}`;
            if(fmt === 'mm:ss') return `${m}:${s}`;
            if(fmt === 'H:m:s') return `${Number(h)}:${Number(m)}:${Number(s)}`;
            if(fmt === 'cn_long') return `${h}时${m}分${s}秒`;
            return `${h}:${m}`;
        }
      },
      
      // 邮箱 (Tag: AI生成)
      { 
        key: 'email', label: 'Email', allowAI: true, 
        gen: () => {
          const list = [
            "john.smith@example.com",
          
          ];
          return list[Math.floor(Math.random()*list.length)];
        } 
      },
      
      // 身份证 (Tag: 男/女)
      { 
        key: 'idcard', label: '身份证', allowAI: true, 
        gen: () => {
          const list = [
            "14072119900307" + Math.floor(Math.random()*10000),
       
          ];
          return list[Math.floor(Math.random()*list.length)];
        } 
      },
      
      // 公司名称 (Tag: AI生成)
      { 
        key: 'company', label: '公司名称', allowAI: true, 
        gen: () => {
          const list = [
            "未来视界科技有限公司",
     
          ];
          return list[Math.floor(Math.random()*list.length)];
        } 
      },
      
      // 银行卡号 (Tag: AI生成)
      { key: 'bank', label: '银行卡号', allowAI: true, gen: () => "622202" + Math.floor(Math.random()*100000000000) },
      
      // 网站地址 (Tag: 去协议头, 长路径)
      {
        key: 'website', label: '网站地址', allowAI: true,
        tags: [ {l:'去协议头', v:'no_proto'}, {l:'长路径', v:'long'} ],
        gen: (tags) => {
            const protos = ['https://', 'http://', 'ftp://'];
            const domains = [
              'www.google.com',
           
            ];
            const paths = ['/search?q=codeium', '/repo/main/src', '/p/12345', '/category/tech/news', '/api/v1/status'];

            const proto = tags.includes('no_proto') ? '' : protos[rand(0, protos.length - 1)];
            const domain = domains[rand(0, domains.length - 1)];
            const path = tags.includes('long') ? paths[rand(0, paths.length - 1)] : '';
            return `${proto}${domain}${path}`;
        }
      },
      
      // IP地址 (Tag: 含端口)
      {
        key: 'ip', label: 'IP地址', allowAI: true,
        tags: [ {l:'含端口', v:'port'} ],
        gen: (tags) => {
            const ip = `${rand(0,255)}.${rand(0,255)}.${rand(0,255)}.${rand(0,255)}`;
            return tags.includes('port') ? `${ip}:${rand(0,65535)}` : ip;
        }
      },
      
      // 手机型号 (Tag: AI生成)
      { 
        key: 'phone', label: '手机型号', allowAI: true , 
        gen: () => {
            const list = [
              "iPhone 15 Pro Max",
           
            ];
            return list[Math.floor(Math.random()*list.length)];
        }
      },
      
      // 性别 (Tag: AI生成)
      { 
        key: 'gender', label: '性别', 
        tags: [ {l:'男', v:'1'}, {l:'女', v:'0'} ],
        gen: (tags) => {
            const hasMale = tags.includes('1');
            const hasFemale = tags.includes('0');
            if(hasMale && !hasFemale) return '男';
            if(!hasMale && hasFemale) return '女';
            return Math.random() > 0.5 ? '男' : '女';
        }
      },

      // 网名 (Tag: AI生成)
      { 
        key: 'nickname', label: '网名', allowAI: true, 
        gen: () => {
          const list = [
            "风清扬", 
          
          ];
          return list[Math.floor(Math.random()*list.length)];
        },
      },

      // 新闻标题 (Tag: AI生成)
      { 
        key: 'news_title', label: '新闻标题', allowAI: true, 
        gen: () => {
            const list = [
                "重磅！科技巨头发布最新AI模型，性能超越GPT-4",
              
            ];
            return list[Math.floor(Math.random() * list.length)];
        } 
      },
      
      // 名人名言 (Tag: AI生成)
      { 
        key: 'lorem', label: '名人名言', allowAI: true, 
        gen: () => {
            const list = [
                "未经审视的人生不值得过",
               
            ];
            return list[Math.floor(Math.random() * list.length)];
        } 
      }
    ];

    let customDataLists = []; // 存储自定义列表 [{title: 'xxx', list: ['a','b']}]
    // 默认配置改为 GLM
    let aiConfig = { 
        provider: 'glm', 
        baseUrl: 'https://open.bigmodel.cn/api/paas/v4', 
        model: 'glm-4-flash', 
        key: '' 
    };
    let dateFormat = 'YYYY-MM-DD';

    let smartSettings = {
        number: { min: 1, max: 100, decimals: 0, thousands: false, sort: 'random' },
        date: { format: 'YYYY-MM-DD', sort: 'random', start: '2020-01-01', end: '2025-12-31' },
        time: { format: 'HH:mm:ss', sort: 'random', start: '00:00:00', end: '23:59:59' }
    };

    let currentSettingKey = '';
    // --- 初始化 ---
    function initSmartFill() {
      renderBasicList();

      // 1. 先把默认值填进去
      document.getElementById('aiProvider').value = aiConfig.provider;
      document.getElementById('aiBaseUrl').value = aiConfig.baseUrl;
      document.getElementById('aiModelName').value = aiConfig.model;

      // 2. 然后再请求保存的配置
      postMsg('load-storage', { key: 'smart_custom_lists' });
      renderBasicList(); // 渲染基础列表
      renderCustomList(); // 渲染自定义列表
      postMsg('load-storage', { key: 'smart_ai_config' });
      postMsg('load-storage', { key: 'smart_date_format' });
      postMsg('load-storage', { key: 'smart_advanced_settings' });
    }

    // 渲染 Tab 1: 基础填充 (带标签和AI按钮)
    function renderBasicList() {
      const container = document.getElementById('smartBasicList');
      if (!container) return;
      container.innerHTML = '';
      
      const tDict = i18n[curLang];

      basicDataTypes.forEach(item => {
        const row = document.createElement('div');
        row.className = 'smart-row';
        
        // --- 标签 Tag 渲染 ---
        let tagsHtml = '';
        if (item.tags && item.tags.length > 0) {
            // 初始化默认选中
            if (!activeTagsMap[item.key]) {
               activeTagsMap[item.key] = []; 
               // 默认全选或根据逻辑？根据 logic，空也是处理所有
            }
            
            tagsHtml = item.tags.map(t => {
                const isActive = activeTagsMap[item.key].includes(t.v) ? 'active' : '';
                
                // 优先根据 tag.v 查找翻译 sf_tag_xxx
                // 特殊处理 1/0 (性别) 为 male/female
                let tagKey = `sf_tag_${t.v.toLowerCase().replace('_','')}`;
                if (t.v === '1') tagKey = 'sf_tag_male';
                if (t.v === '0') tagKey = 'sf_tag_female';

                const tagLabel = tDict[tagKey] || t.l;

                return `<span class="tag-btn ${isActive}" onclick="toggleTag('${item.key}', '${t.v}', this, event)">${tagLabel}</span>`;
            }).join('');
        }

        // 优先根据 item.key 查找翻译 sf_lbl_xxx
        const displayLabel = tDict[`sf_lbl_${item.key}`] || item.label;

        // 构建“发送到AI”按钮
        let aiBtnHtml = '';
        if (item.allowAI) {
            aiBtnHtml = `<span class="btn-to-ai" onclick="jumpToAI('${item.key}', '${displayLabel}', event)">${tDict.sf_send_ai}</span>`;
        }

        // 构建设置按钮
        let settingBtnHtml = '';
        if (item.hasSetting) {
            settingBtnHtml = `<div class="smart-setting-btn" onclick="openBasicSetting('${item.key}', event)">⚙️</div>`;
        }

        row.innerHTML = `
           <div class="smart-label">${displayLabel}</div>
           <div class="row-tags">
              ${tagsHtml}
              ${aiBtnHtml}
              ${settingBtnHtml}
           </div>
        `;
        
        // 点击行本身触发填充
        row.onclick = (e) => { 
           // 只有点击空白处或文字才触发，点击按钮不触发
           if(e.target.classList.contains('tag-btn') || 
              e.target.classList.contains('btn-to-ai') || 
              e.target.classList.contains('smart-setting-btn')) return;
           
           runBasicFill(item.key); 
        };
        container.appendChild(row);
      });
    }

    // 渲染 Tab 3: 自定义字段 (仅显示用户添加的)
    function renderCustomList() {
      const container = document.getElementById('smartCustomList');
      const emptyState = document.getElementById('customEmptyState');
      if (!container) return;
      
      // 清空列表区域 (保留 emptyState dom)
      // 简单做法：先把 innerHTML 清空，再根据情况加回去
      container.innerHTML = '';
      container.appendChild(emptyState);

      if (!customDataLists || customDataLists.length === 0) {
          emptyState.style.display = 'flex';
          return;
      } else {
          emptyState.style.display = 'none';
      }

      customDataLists.forEach((item, index) => {
        const row = document.createElement('div');
        row.className = 'smart-row';
        row.innerHTML = `
           <div class="smart-label">${item.title}</div>
           <div class="row-tags">
              <span class="tag-btn" style="background:#fffbe6; color:#d48806;">${item.list.length}条</span>
              <div class="smart-setting-btn" onclick="editCustomList(${index}, event)">✏️</div>
              <div class="smart-setting-btn" onclick="deleteCustomList(${index}, event)">🗑️</div>
           </div>
        `;
        row.onclick = (e) => {
           if(e.target.classList.contains('smart-setting-btn')) return;
           runCustomFill(index);
        };
        container.appendChild(row);
      });
    }
    
    // 1. 切换标签状态 (多选)
    function toggleTag(key, val, el, e) {
        e.stopPropagation(); // 阻止触发填充
        
        const list = activeTagsMap[key] || [];
        const idx = list.indexOf(val);
        
        if (idx > -1) {
            list.splice(idx, 1); // 取消选中
            el.classList.remove('active');
        } else {
            list.push(val); // 选中
            el.classList.add('active');
        }
        activeTagsMap[key] = list;
    }

    // 2. 快捷跳转到 AI 并填入提示词
    function jumpToAI(key, label, e) {
        e.stopPropagation();
        switchSmartTab('ai');
        
        // 1. 获取选中的 tags 对象数组 [{l:'中文', v:'cn'}, ...]
        const config = basicDataTypes.find(t => t.key === key);
        const activeVals = activeTagsMap[key] || [];
        
        // 2. 找到对应的中文 label
        const activeLabels = [];
        if (config.tags) {
            config.tags.forEach(t => {
                if (activeVals.includes(t.v)) activeLabels.push(t.l);
            });
        }

        // 3. 构建提示词
        let promptText = `生成${label}`;
        if (activeLabels.length > 0) {
            promptText += `，要求：${activeLabels.join('、')}`;
        }
        
        // 4. 特殊处理：如果没有任何要求，且本来就没tag，或者没选tag，就不加冒号
        const promptBox = document.getElementById('aiPrompt');
        promptBox.value = promptText;
        promptBox.focus();
    }

    // --- 填充执行逻辑 ---
    function runBasicFill(key) {
      // 1. 请求选中数量
      // 为了简单，我们先不请求数量，直接让后端处理单次生成逻辑？
      // 不，为了支持随机不重复，最好前端一次性生成
      // 这里采用策略：先请求数量，再生成
      
      // 这里的逻辑稍微绕一下，通过 postMsg('get-selection-count')
      // 然后在 onmessage 里处理生成逻辑。
      // 为简化代码，我们先把“当前要执行的任务”存起来
      window.pendingFillTask = { 
        type: 'basic', 
        key: key,
        // 🔥 将当前选中的标签传递给后端/生成器
        tags: activeTagsMap[key] || [] 
      };
      postMsg('get-selection-count');
    }

    function runCustomFill(index) {
      window.pendingFillTask = { type: 'custom', index: index };
      postMsg('get-selection-count');
    }
    
    
   

    // --- 收到后端消息回调 (在 window.onmessage 里补充) ---
    // if (msg.type === 'selection-count-res') { handleFillGeneration(msg.count); }
    // if (msg.type === 'storage-loaded') { ... }

    function handleFillGeneration(count) {
      if (!window.pendingFillTask) return;
      const task = window.pendingFillTask;
      
      const list = [];
      
      // 获取当前模式
      const isPrefix = document.getElementById('sfPrefix').checked;
      const isSuffix = document.getElementById('sfSuffix').checked;
      let mode = 'replace';
      if(isPrefix) mode = 'prefix';
      else if(isSuffix) mode = 'suffix';

      // 生成数据
      if (task.type === 'basic') {
        const generator = basicDataTypes.find(t => t.key === task.key);
        if (generator) {
          for(let i=0; i<count; i++) {
              list.push(generator.gen(task.tags));
          }
        }
      } else if (task.type === 'custom') {
        const customData = customDataLists[task.index];
        if (customData) {
           // 自定义列表通常循环使用
           for(let i=0; i<count; i++) list.push(customData.list[i % customData.list.length]);
        }
      }

      // 2. 排序逻辑 (修复报错点)
      if (task.type === 'basic') {
          // 🔥 必须在这里声明变量
          let sortMode = 'random';
          
          // 根据类型读取配置
          if (task.key === 'number') sortMode = smartSettings.number.sort;
          else if (task.key === 'date') sortMode = smartSettings.date.sort;
          else if (task.key === 'time') sortMode = smartSettings.time.sort;
          
          // 执行排序
          if (sortMode && sortMode !== 'random') { // 加上非空检查更安全
              list.sort((a, b) => {
                  let valA = a, valB = b;
                  
                  if (task.key === 'number') {
                      valA = parseFloat(String(a).replace(/,/g, ''));
                      valB = parseFloat(String(b).replace(/,/g, ''));
                  } else if (task.key === 'date') {
                      const parseDate = (str) => {
                          const s = String(str).replace(/[年月日]/g, '/').replace(/\/$/, '');
                          return Date.parse(s) || str;
                      };
                      valA = parseDate(a);
                      valB = parseDate(b);
                  }
                  
                  if (valA < valB) return sortMode === 'asc' ? -1 : 1;
                  if (valA > valB) return sortMode === 'asc' ? 1 : -1;
                  return 0;
              });
          }
      }
      
      

      postMsg('smart-fill-exec', {
        dataList: list,
        mode: mode,
        distribution: 'order' // 基础填充默认顺序，如需随机可扩展UI
      });
      
      window.pendingFillTask = null;
    }

    // --- 数据生成器 (Mock Generators) ---
    function getRandomNameCN() {
       // 常见单姓 + 复姓
       const xingList = [
           "赵","钱","孙","李","周","吴","郑","王","冯","陈","褚","卫","蒋","沈","韩","杨","朱","秦","尤","许",
           "何","吕","施","张","孔","曹","严","华","金","魏","陶","姜","戚","谢","邹","喻","柏","水","窦","章",
           "云","苏","潘","葛","奚","范","彭","郎","鲁","韦","昌","马","苗","凤","花","方","俞","任","袁","柳",
           "欧阳","太史","端木","上官","司马","东方","独孤","南宫","万俟","闻人","夏侯","诸葛","尉迟","公羊","赫连","澹台","皇甫","宗政","濮阳","公孙",
           "慕容","仲孙","钟离","长孙","宇文","司徒","鲜于","司空","闾丘","子车","亓官","司寇","巫马","公西","颛孙","壤驷","公良","漆雕","乐正","宰父",
           "谷梁","拓跋","夹谷","轩辕","令狐","段干","百里","呼延","东郭","南门","羊舌","微生","公户","公玉","公仪","梁丘","公仲","公上","公门","公山"
       ];
       const mingChars = "伟刚勇毅俊峰强军平保东文辉力明永健世广志义兴良海山仁波宁贵福生龙元全国胜学祥才发武新利清飞彬富顺信子杰涛昌成康星光天达安岩中茂进林有坚和彪博诚先敬震振壮会思群豪心邦承乐绍功松善厚庆磊民友裕河哲江超浩亮政谦亨奇固之轮翰朗伯宏言若鸣朋斌梁栋维启克伦翔旭鹏泽晨辰士以建家致树炎德行时泰盛雄琛钧冠策腾楠榕风航弘";
       
       const selectedXing = xingList[Math.floor(Math.random() * xingList.length)];
       
       // 名字长度 1 或 2
       const mingLen = Math.random() > 0.5 ? 2 : 1;
       let selectedMing = "";
       for(let i=0; i<mingLen; i++) {
           selectedMing += mingChars.charAt(Math.floor(Math.random() * mingChars.length));
       }
       
       return selectedXing + selectedMing;
    }
    function getRandomNameEN() {
       const firstNames = [
          "James", "Mary", "John", "Patricia", "Robert", "Jennifer", "Michael", "Linda",
          "William", "Elizabeth", "David", "Barbara", "Richard", "Susan", "Joseph", "Jessica",
          "Thomas", "Sarah", "Charles", "Karen", "Christopher", "Nancy", "Daniel", "Lisa", 
          "Matthew", "Betty", "Anthony", "Margaret", "Mark", "Sandra"
       ];
       const lastNames = [
          "Smith", "Johnson", "Williams", "Brown", "Jones", "Garcia", "Miller", "Davis",
          "Rodriguez", "Martinez", "Hernandez", "Lopez", "Gonzalez", "Wilson", "Anderson",
          "Thomas", "Taylor", "Moore", "Jackson", "Martin", "Lee", "Perez", "Thompson",
          "White", "Harris", "Sanchez", "Clark", "Ramirez", "Lewis", "Robinson"
       ];
       const first = firstNames[Math.floor(Math.random() * firstNames.length)];
       const last = lastNames[Math.floor(Math.random() * lastNames.length)];
       return `${first} ${last}`;
    }
    
  
    function getRandomDate() {
       const d = new Date();
       d.setDate(d.getDate() - Math.floor(Math.random()*1000));
       // 使用全局 dateFormat 格式化
       const y = d.getFullYear();
       const m = (d.getMonth()+1).toString().padStart(2,'0');
       const day = d.getDate().toString().padStart(2,'0');
       
       if(dateFormat === 'YYYY/MM/DD') return `${y}/${m}/${day}`;
       if(dateFormat === 'MM-DD') return `${m}-${day}`;
       if(dateFormat === 'CN') return `${y}年${m}月${day}日`;
       return `${y}-${m}-${day}`;
    }
    function getRandomTime() {
       return `${Math.floor(Math.random()*24).toString().padStart(2,'0')}:${Math.floor(Math.random()*60).toString().padStart(2,'0')}`;
    }

    // --- 子页面导航 ---
    function openSubPage(id) { document.getElementById(id).classList.add('open'); }
    function closeSubPage(id) { document.getElementById(id).classList.remove('open'); }
    
    function switchSmartTab(tab) {
      document.querySelectorAll('.smart-tab-item').forEach(el => el.classList.remove('active'));
      document.querySelector(`[data-key="sf_tab_${tab}"]`).classList.add('active');
      document.querySelectorAll('.smart-content').forEach(el => el.classList.remove('active'));
      if (tab === 'basic') document.getElementById('smartBasic').classList.add('active');
      if (tab === 'ai') document.getElementById('smartAI').classList.add('active');
      if (tab === 'custom') {
          document.getElementById('smartCustom').classList.add('active');
          renderCustomList(); // 每次切换进来刷新一下，确保数据最新
      }
    }
    
    // --- 基础设置页逻辑 ---
    function openBasicSetting(key, e) {
      e.stopPropagation();
      currentSettingKey = key;
      const config = basicDataTypes.find(t => t.key === key);
      document.getElementById('basicSettingTitle').innerText = config.label + " 设置";
      
      const container = document.getElementById('settingFormContainer');
      container.innerHTML = '';
      
      // 1. 数字设置 (补全了范围、小数、千分位)
      if (key === 'number') {
          const s = smartSettings.number;
          container.innerHTML = `
            <div class="config-group">
                <label class="config-label">${i18n[curLang].sf_cfg_range}</label>
                <div style="display:flex; gap:8px; align-items:center;">
                    <input type="number" id="numMin" class="search-box" value="${s.min}" style="flex:1">
                    <span style="color:#999">-</span>
                    <input type="number" id="numMax" class="search-box" value="${s.max}" style="flex:1">
                </div>
            </div>
            <div class="config-group" style="margin-top:12px;">
                <label class="config-label">${i18n[curLang].sf_cfg_decimal}</label>
                <input type="number" id="numDec" class="search-box" value="${s.decimals}" min="0" max="5">
            </div>
            <div style="margin-top:12px;">
                 <label class="checkbox-row">
                    <input type="checkbox" id="numThous" ${s.thousands?'checked':''}> ${i18n[curLang].sf_cfg_thous} 
                </label>
            </div>
            
            <div class="config-group" style="margin-top:16px; border-top:1px dashed #eee; padding-top:12px;">
                <label class="config-label">${i18n[curLang].sf_cfg_sort}</label>
                ${renderRadioTags('numSort', [
                    {l:'随机', v:'random'}, {l:'升序 1→9', v:'asc'}, {l:'降序 9→1', v:'desc'}
                ], s.sort)}
            </div>
          `;
      }
      
      
      
      // 3. 日期设置
      else if (key === 'date') {
          const s = smartSettings.date;
          // 防止 undefined 报错
          const dStart = s.start || '2020-01-01';
          const dEnd = s.end || '2025-12-31';
          
          container.innerHTML = `
            <div class="config-group">
                <label class="config-label">${i18n[curLang].sf_cfg_date_range}</label>
                <div style="display:flex; gap:8px; align-items:center;">
                    <input type="date" id="dateStart" class="search-box" value="${dStart}" style="flex:1">
                    <span style="color:#999">-</span>
                    <input type="date" id="dateEnd" class="search-box" value="${dEnd}" style="flex:1">
                </div>
            </div>
          
            <div class="config-group" style="margin-top:16px;">
                <label class="config-label">${i18n[curLang].sf_cfg_date_fmt}</label>
                ${renderRadioTags('dateFormat', [
                    {l:'2023-10-01', v:'YYYY-MM-DD'},
                    {l:'2023/10/01', v:'YYYY/MM/DD'},
                    {l:'2023.10.01', v:'YYYY.MM.DD'},
                    {l:'2023年10月1日', v:'YYYY年MM月DD日'},
                    {l:'2023-10', v:'YYYY-MM'},
                    {l:'10-01', v:'MM-DD'},
                    {l:'Oct 1, 2023', v:'MMM D, YYYY'},
                    {l:'October 1, 2023', v:'MMMM D, YYYY'},
                    {l:'1 Oct 2023', v:'D MMM YYYY'},
                    {l:'01/10/2023', v:'DD/MM/YYYY'},
                    {l:'10/01/2023', v:'MM/DD/YYYY'}
                ], s.format)}
            </div>
            
            <div class="config-group" style="margin-top:16px;">
                <label class="config-label">${i18n[curLang].sf_cfg_sort}</label>
                ${renderRadioTags('dateSort', [
                    {l:'随机', v:'random'}, {l:'正序 (old→new)', v:'asc'}, {l:'倒序 (new→old)', v:'desc'}
                ], s.sort)}
            </div>
          `;
      }
      
      // 4. 时间设置
      else if (key === 'time') {
          const s = smartSettings.time;
          const tStart = s.start || '00:00:00';
          const tEnd = s.end || '23:59:59';
          
          container.innerHTML = `
            <div class="config-group">
                <label class="config-label">${i18n[curLang].sf_cfg_time_range}</label>
                <div style="display:flex; gap:8px; align-items:center;">
                    <div style="flex:1">
                         <input type="time" id="timeStart" class="search-box" value="${tStart.substring(0,5)}" step="1" style="width:100%">
                    </div>
                    <span style="color:#999">-</span>
                    <div style="flex:1">
                         <input type="time" id="timeEnd" class="search-box" value="${tEnd.substring(0,5)}" step="1" style="width:100%">
                    </div>
                </div>
                <div style="font-size:11px; color:#999; margin-top:4px;">${i18n[curLang].sf_cfg_time_help}</div>
            </div>
          
            <div class="config-group" style="margin-top:16px;">
                <label class="config-label">${i18n[curLang].sf_cfg_time_fmt}</label>
                ${renderRadioTags('timeFormat', [
                    {l:'05:05:05', v:'HH:mm:ss'},
                    {l:'05:05', v:'HH:mm'},
                    {l:'05:05 (m:s)', v:'mm:ss'},
                    {l:'5:5:5', v:'H:m:s'},
                    {l:'中文长格式', v:'cn_long'}
                ], s.format)}
            </div>
            
            <div class="config-group" style="margin-top:16px;">
                <label class="config-label">${i18n[curLang].sf_cfg_sort}</label>
                ${renderRadioTags('timeSort', [
                    {l:'随机', v:'random'}, {l:'升序 (早→晚)', v:'asc'}, {l:'降序 (晚→早)', v:'desc'}
                ], s.sort)}
            </div>
          `;
      }
      
      openSubPage('pageBasicSetting');
    }

    function saveCurrentSettings(closePage = true) {
        const key = currentSettingKey;
        
        // 辅助函数：获取单选框选中的值
        const getRadioValue = (name) => {
            const el = document.querySelector(`input[name="${name}"]:checked`);
            return el ? el.value : 'random'; // 默认 random 防错
        };
        
        if (key === 'number') {
            smartSettings.number = {
                min: Number(document.getElementById('numMin').value),
                max: Number(document.getElementById('numMax').value),
                decimals: Number(document.getElementById('numDec').value),
                thousands: document.getElementById('numThous').checked,
                sort: getRadioValue('numSort')
            };
        }
        else if (key === 'date') {
            smartSettings.date = {
                format: getRadioValue('dateFormat'),
                sort: getRadioValue('dateSort'),
                start: document.getElementById('dateStart').value,
                end: document.getElementById('dateEnd').value
            };
        }
        else if (key === 'time') {
            // input type=time 返回的是 HH:mm，我们补全秒数
            let sStart = document.getElementById('timeStart').value;
            let sEnd = document.getElementById('timeEnd').value;
            
            if(sStart && sStart.length===5) sStart += ":00";
            if(sEnd && sEnd.length===5) sEnd += ":59";
            
            smartSettings.time = {
                format: getRadioValue('timeFormat'),
                sort: getRadioValue('timeSort'),
                start: sStart,
                end: sEnd
            };
        }
        
        // 持久化存储
        // 只有当 closePage 为 true 时显示 Notify，避免 saveAndFill 时也弹窗干扰体验（或者也可以都弹）
        postMsg('save-storage', { key: 'smart_advanced_settings', value: smartSettings, notify: closePage });
        
        // 关闭页面
        if (closePage) {
            closeSubPage('pageBasicSetting');
        }
    }
    
    function saveBasicSettings(type) {
       if (type === 'date') {
          dateFormat = document.getElementById('dateFormatSel').value;
          postMsg('save-storage', { key: 'smart_date_format', value: dateFormat, notify: true });
       }
       closeSubPage('pageBasicSetting');
    }

    // 辅助：生成单选 Tag 组 HTML
    function renderRadioTags(groupName, options, currentValue) {
        return `<div class="radio-tag-group" style="display:flex; gap:8px; flex-wrap:wrap;">
            ${options.map(opt => {
                // 兼容处理：优先取 label/value，没有则取 l/v
                const label = opt.label || opt.l;
                const value = opt.value || opt.v;
                
                return `
                <label class="radio-tag ${value === currentValue ? 'active' : ''}">
                    <input type="radio" name="${groupName}" value="${value}" ${value === currentValue ? 'checked' : ''} onchange="updateRadioTagStyle(this)">
                    ${label}
                </label>
            `}).join('')}
        </div>`;
    }

    // 辅助：点击切换样式
    function updateRadioTagStyle(input) {
        const group = input.closest('.radio-tag-group');
        group.querySelectorAll('.radio-tag').forEach(el => el.classList.remove('active'));
        input.parentElement.classList.add('active');
    }
    
    function saveAndFill() {
        // 1. 保存配置，但不关闭页面
        saveCurrentSettings(false); 
        
        // 2. 执行填充 (使用当前设置的 key)
        // 稍微延迟一下，确保状态更新（虽然同步的，但稳妥起见）
        setTimeout(() => {
            runBasicFill(currentSettingKey);
        }, 50);
    }

    let currentEditingIndex = -1; // 记录当前编辑的索引，-1 表示新增

    function editCustomList(index, e) {
        e.stopPropagation();
        currentEditingIndex = index;
        const item = customDataLists[index];
        
        document.getElementById('customTitle').value = item.title;
        document.getElementById('customContent').value = item.list.join('\n');
        
        // 修改标题和按钮文字
        document.querySelector('#pageAddCustom .sub-header span:last-child').innerText = "编辑自定义数据";
        openSubPage('pageAddCustom');
    }

    function openAddCustomPage() {
        currentEditingIndex = -1;
        document.getElementById('customTitle').value = '';
        document.getElementById('customContent').value = '';
        document.querySelector('#pageAddCustom .sub-header span:last-child').innerText = "添加自定义数据";
        openSubPage('pageAddCustom');
    }
    
    // --- 自定义列表逻辑 ---
    function saveCustomList() {
       const title = document.getElementById('customTitle').value;
       const content = document.getElementById('customContent').value;
       if(!title || !content) return alert("请填写标题和内容");
       
       const list = content.split('\n').filter(s => s.trim());
       
       if (currentEditingIndex >= 0) {
           // 编辑模式
           customDataLists[currentEditingIndex] = { title, list };
       } else {
           // 新增模式
           customDataLists.push({ title, list });
       }
       
       postMsg('save-storage', { key: 'smart_custom_lists', value: customDataLists, notify: true });
       renderCustomList();
       closeSubPage('pageAddCustom');
       // 清空
       // document.getElementById('customTitle').value = '';// 清空标题
       // document.getElementById('customContent').value = '';// 清空内容
       // renderCustomList();// 刷新列表
       // switchSmartTab('custom');// 切换到自定义列表页
    }
    
    function deleteCustomList(index, e) {
       e.stopPropagation();
       if(confirm("确定删除这个列表吗？")) {
         customDataLists.splice(index, 1);
         postMsg('save-storage', { key: 'smart_custom_lists', value: customDataLists });
         renderCustomList();
       }
    }

    // --- 1. 清空所有自定义列表 ---
    function clearAllCustomLists() {
        if (customDataLists.length === 0) return alert("列表已经是空的了");
        if (confirm("⚠️ 确定要清空所有自定义列表吗？此操作不可恢复！")) {
            customDataLists = [];
            postMsg('save-storage', { key: 'smart_custom_lists', value: customDataLists, notify: true });
            renderCustomList();
        }
    }

    // --- AI 逻辑 ---
    // 补全后的模型配置字典 (OpenAI 兼容格式)
    const aiProviders = {
      // 1. 智谱 AI (GLM) - 默认推荐
      'glm': { 
          url: 'https://open.bigmodel.cn/api/paas/v4', 
          model: 'glm-4-flash' 
      },
      // 2. DeepSeek
      'deepseek': { 
          url: 'https://api.deepseek.com/v1', 
          model: 'deepseek-chat' 
      },
      // 3. Kimi (Moonshot AI)
      'kimi': { 
          url: 'https://api.moonshot.cn/v1', 
          model: 'moonshot-v1-8k' 
      },
      // 4. 通义千问 (Qwen / DashScope) - 需使用兼容端点
      'qwen': { 
          url: 'https://dashscope.aliyuncs.com/compatible-mode/v1', 
          model: 'qwen-plus' 
      },
      // 5. OpenAI
      'openai': { 
          url: 'https://api.openai.com/v1', 
          model: 'gpt-4o-mini' 
      },
      // 6. Google Gemini (OpenAI 兼容模式需特定网关，此处为通用格式)
      'gemini': { 
          url: 'https://generativelanguage.googleapis.com/v1beta/openai', 
          model: 'gemini-1.5-flash' 
      },
      // 7. Anthropic Claude (通常需要中转，此处填常用中转格式，或官方API)
      // 注意：Claude 原生API不兼容OpenAI格式，这里假设你使用类似 one-api 的中转
      // 如果直连，地址通常不同。这里提供一个通用占位。
      'claude': { 
          url: 'https://api.anthropic.com/v1', 
          model: 'claude-3-5-sonnet-20240620' 
      },
      // 8. xAI Grok
      'grok': { 
          url: 'https://api.x.ai/v1', 
          model: 'grok-beta' 
      },
      // 9. Ollama (本地运行)
      'ollama': { 
          url: 'http://localhost:11434/v1', 
          model: 'llama3' 
      },
      // 10. 硅基流动 (SiliconFlow) - 聚合了多种开源模型
      'siliconflow': { 
          url: 'https://api.siliconflow.cn/v1', 
          model: 'Qwen/Qwen2.5-7B-Instruct' 
      }
    };

    function updateAiConfigDefaults() {
       const p = document.getElementById('aiProvider').value;
       if (aiProviders[p]) {
         document.getElementById('aiBaseUrl').value = aiProviders[p].url;
         document.getElementById('aiModelName').value = aiProviders[p].model;
       }
    }

    function saveAiConfig() {
       aiConfig = {
          provider: document.getElementById('aiProvider').value,
          baseUrl: document.getElementById('aiBaseUrl').value,
          model: document.getElementById('aiModelName').value,
          key: document.getElementById('aiKey').value
       };
       postMsg('save-storage', { key: 'smart_ai_config', value: aiConfig, notify: true });
       
       // 显示成功后 3s 返回
       const btn = event.target; // 获取点击的按钮
       const originalText = "保存配置"; // 记录原始文字
       
       btn.innerText = "配置成功"; // 1. 去掉 (3s) 文字
       btn.disabled = true;        // 2. 禁用按钮防止重复点击
       
       // 3. 1.5秒后自动返回 (比3秒更流畅)
       setTimeout(() => {
          btn.innerText = originalText;
          btn.disabled = false;
          closeSubPage('pageAiConfig');
       }, 1500);
    }

    let aiAbortController = null; // 全局控制器
    
    // --- 辅助函数：强制重置 UI 状态 ---
    function resetAiInterface() {
        const btn = document.getElementById('btnAiGen');
        if (!btn) return;

        btn.innerText = "生成内容";
        btn.style.backgroundColor = ""; // 恢复默认颜色
        btn.style.borderColor = "";
        btn.disabled = false;
        
        // 恢复清空按钮
        const clearBtn = document.querySelector('button[title="清空"]');
        if (clearBtn) clearBtn.disabled = false;

        // 关键：清空控制器
        aiAbortController = null;
    }

    // --- 新增：清空 AI 输入和结果 ---
    function clearAiInput() {
       document.getElementById('aiPrompt').value = '';
       document.getElementById('aiResultArea').innerText = '';
       // 可选：让输入框重新获得焦点
       document.getElementById('aiPrompt').focus();
    }
    
    // --- 新增：保存 AI 结果为自定义列表 ---
    let currentSaveMode = ''; // 'new' | 'append'

    
    // 辅助：保存并刷新 (补上这个缺失的函数)
    function saveAndRefreshCustom() {
        postMsg('save-storage', { key: 'smart_custom_lists', value: customDataLists, notify: true });
        renderCustomList(); // 刷新自定义Tab
    }
    
    // 2. 关闭弹窗
    function closeSaveDialog() {
       const dialog = document.getElementById('saveDialog');
       const overlay = document.getElementById('dialogOverlay');
       
       if (dialog) {
           dialog.classList.remove('open');
           // 强制加个延时隐藏，配合 CSS transition
           setTimeout(() => {
               // 只有当它是弹窗模式时才隐藏 display，避免影响普通 sub-page
               // 但这里我们用的是 class 控制 transform，所以 remove open 就够了
           }, 300); 
       }
       
       if (overlay) {
           overlay.style.display = 'none';
       }
    }

    // 3. 确认保存
    function confirmSaveDialog() {
       // 1. 先获取数据
       const text = document.getElementById('aiResultArea').innerText;
       const list = text.split('\n').filter(s => s.trim());
       
       // 2. 执行逻辑
       if (currentSaveMode === 'new') {
           const title = document.getElementById('saveNewTitle').value;
           if (!title) return alert("请输入标题");
           
           customDataLists.push({ title: title, list: list });
           // 先关闭，再弹提示
           closeSaveDialog(); 
           setTimeout(() => alert("已保存为新列表"), 100);
           
       } else {
           const idxStr = document.getElementById('saveTargetSelect').value;
           const index = parseInt(idxStr);
           
           if (isNaN(index) || !customDataLists[index]) return alert("目标列表无效");
           
           const target = customDataLists[index];
           target.list = target.list.concat(list);
           
           // 先关闭，再弹提示
           closeSaveDialog();
           setTimeout(() => alert(`追加成功！"${target.title}" 现有 ${target.list.length} 条数据。`), 100);
       }

       // 3. 刷新数据
       saveAndRefreshCustom();
    }

    initSmartFill();

    // ==========================================
    // 7. 查找结果列表 (Result List View) - 完整版
    // ==========================================
    
    // 缓存当前的搜索结果数据
    let currentFoundLayers = [];

    // 接收后端发来的搜索结果
    function handleFoundLayersResult(msg) {
        currentFoundLayers = msg.layers || [];
        const count = msg.count || 0;
        
        // 1. 更新主界面按钮 (例如：显示 "已找到 10 项")
        const btn = document.getElementById('btnShowSelResult');
        const badge = document.getElementById('selResultBadge');
        if (btn) {
            if (badge) badge.innerText = count;
            // 使用 flex 显示，确保并列布局生效
            btn.style.display = count > 0 ? 'flex' : 'none';
        }
        
        // 2. 如果结果列表视图当前是打开的，立即刷新列表内容
        const resultView = document.getElementById('selResultView');
        if (resultView && resultView.style.display !== 'none') {
            renderSelectionResultList();
        }
    }

    // 切换到结果列表视图
    function showSelectionResults() {
        const queryView = document.getElementById('selQueryView');
        const resultView = document.getElementById('selResultView');
        
        if(queryView) queryView.style.display = 'none';
        if(resultView) resultView.style.display = 'flex';
        
        renderSelectionResultList();
    }

    // 返回到搜索条件视图
    function hideSelectionResults() {
        const queryView = document.getElementById('selQueryView');
        const resultView = document.getElementById('selResultView');

        if(resultView) resultView.style.display = 'none';
        if(queryView) queryView.style.display = 'flex';
    }



    let isClicking = false;

    // 渲染列表 - 核心修复：单击即响应
    function renderSelectionResultList() {
        const listEl = document.getElementById('selResultList');
        const countEl = document.getElementById('selResultCountText');
        
        if(!listEl) return;
        
        // 更新计数
        if(countEl) countEl.innerText = currentFoundLayers.length;
        
        listEl.innerHTML = '';
        
        if(currentFoundLayers.length === 0) {
             const t = (i18n[curLang]) || {};
             const emptyTxt = t.sel_res_empty || (curLang === 'en' ? "No layers found" : "暂无找到图层");
             listEl.innerHTML = `<div style="padding:24px; text-align:center; color:#999; font-size:12px;">${emptyTxt}</div>`;
             return;
        }

        // 图标映射 (对齐主界面图标)
        const iconMap = {
            'FRAME': '#', 'GROUP': '🃖', 'SECTION': '❏', 'AUTOLAYOUT': '⍇⍈',
            'COMPONENT': '❖', 'COMPONENT_SET': '💠', 'INSTANCE': '◇',
            'RECTANGLE': '⬛️', 'ELLIPSE': '⭕️', 'LINE': '|', 'VECTOR': '✏️',
            'STAR': '★', 'POLYGON': '🛑', 'BOOLEAN_OPERATION': '◑',
            'TEXT': 'T', 'SLICE': '✂️', 'CONNECTOR': '⤚', 'SHAPE_WITH_TEXT': '💬',
            'STICKY': '📝', 'WIDGET': '🧩', 'STAMP': '💮', 'WASHI_TAPE': '🎞',
            'IMAGE': '🌄'
        };

        // 遍历渲染
        currentFoundLayers.forEach(layer => {
            const item = document.createElement('div');
            item.className = 'sel-result-item';
            // 必须设置 tabIndex，否则 Tab 键无法选中它
            item.tabIndex = 0; 

            const icon = iconMap[layer.type] || '?';
            
            item.innerHTML = `
                <div style="width:24px; text-align:center; margin-right:8px; color:var(--text-sec-color, #888); font-family:monospace; font-size:14px;">${icon}</div>
                <div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:var(--text-color, #333);">${layer.name}</div>
            `;
            
            // --- 核心交互逻辑 (修复版) ---
            
            // 使用 const 锁定当前循环的 ID
            const targetId = layer.id;

            // 执行定位的通用函数
            const executeLocate = () => {
                 // 1. 立即给后端发消息
                 parent.postMessage({ 
                     pluginMessage: { 
                         type: 'focus-layers', 
                         ids: [targetId] 
                     } 
                 }, '*');

                 // 2. 前端高亮反馈 (排他性)
                 const allItems = listEl.querySelectorAll('.sel-result-item');
                 allItems.forEach(el => el.style.background = 'transparent');
                 item.style.background = 'var(--bg-hover, #f0f0f0)'; 
            };

            // 【鼠标交互】：回归最简原则 - Click
            // 之前的复杂逻辑反而导致了冲突。
            // 只有 click 才是最稳健的触发方式，且自带了正确的焦点处理。
            item.onclick = (e) => {
                executeLocate();
                // 如果需要，也可以在这里强制 blur() 或者 focus()，但通常没必要
            };

            // 【键盘交互】：仅 Enter / Space 确认
            // 移除了 onfocus 自动定位。
            // 因为 Tab 快速切换时自动跳动画面不仅体验糟糕，也是导致事件冲突的根源。
            // 现在按 Tab 只会看到选中框，按下回车才会定位，这是最标准的无障碍交互。
            item.onkeydown = (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    executeLocate();
                }
            };

            // 【键盘交互】：Enter / Space 确认 (备用)
            item.onkeydown = (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    executeLocate();
                }
            };

            listEl.appendChild(item);
        });
    }



  </script>

</body>
</html>